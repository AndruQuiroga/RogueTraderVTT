{{!-- 
  Rogue Trader Critical Injury Item Sheet - V2 Redesign
  Matches weapon/armour sheet patterns with modern ApplicationV2 structure
--}}
<div class="rt-critical-injury-sheet">
  <form autocomplete="off">
    
    {{!-- ═══════════════════════════════════════════════════════════════════
         HEADER: Compact injury identity with inline stats
    ═══════════════════════════════════════════════════════════════════ --}}
    <header class="rt-injury-header">
      <div class="rt-injury-header__image" data-action="editImage" data-edit="img">
        <img src="{{item.img}}" alt="{{item.name}}" />
        <div class="rt-injury-header__image-overlay">
          <i class="fas {{item.system.damageTypeIcon}}"></i>
        </div>
      </div>
      
      <div class="rt-injury-header__info">
        <input type="text" class="rt-injury-header__name" name="name" value="{{item.name}}" placeholder="Critical Injury Name" />
        
        <div class="rt-injury-header__meta">
          <span class="rt-injury-badge rt-injury-badge--damage rt-injury-badge--{{item.system.damageType}}" title="Damage Type">
            <i class="fas {{item.system.damageTypeIcon}}"></i>
            {{item.system.damageTypeLabel}}
          </span>
          <span class="rt-injury-badge rt-injury-badge--location" title="Body Location">
            <i class="fas {{item.system.bodyPartIcon}}"></i>
            {{item.system.bodyPartLabel}}
          </span>
          <span class="rt-injury-badge rt-injury-badge--severity rt-injury-badge--{{item.system.severityClass}}" title="Severity Level">
            <i class="fas fa-chart-line"></i>
            Severity {{item.system.severity}}
          </span>
          {{#if item.system.isPermanent}}
          <span class="rt-injury-badge rt-injury-badge--permanent" title="Permanent Injury">
            <i class="fas fa-infinity"></i>
            Permanent
          </span>
          {{/if}}
        </div>
      </div>
    </header>


    {{!-- ═══════════════════════════════════════════════════════════════════
         SEVERITY INDICATOR: Visual slider showing severity 1-10
    ═══════════════════════════════════════════════════════════════════ --}}
    <div class="rt-injury-severity">
      <div class="rt-injury-severity__header">
        <i class="fas fa-chart-line"></i>
        <span>Severity Level</span>
      </div>
      <div class="rt-injury-severity__slider">
        <input type="range" 
               name="system.severity" 
               min="1" 
               max="10" 
               value="{{item.system.severity}}" 
               data-dtype="Number"
               data-action="changeSeverity"
               class="rt-injury-severity__input" />
        <div class="rt-injury-severity__labels">
          <span class="rt-injury-severity__label rt-injury-severity__label--min">Minor (1)</span>
          <span class="rt-injury-severity__label rt-injury-severity__label--current">
            <strong>{{item.system.severity}}</strong>
          </span>
          <span class="rt-injury-severity__label rt-injury-severity__label--max">Fatal (10)</span>
        </div>
        <div class="rt-injury-severity__zones">
          <span class="rt-injury-severity__zone rt-injury-severity__zone--minor" title="Minor (1-3)"></span>
          <span class="rt-injury-severity__zone rt-injury-severity__zone--moderate" title="Moderate (4-6)"></span>
          <span class="rt-injury-severity__zone rt-injury-severity__zone--severe" title="Severe (7-9)"></span>
          <span class="rt-injury-severity__zone rt-injury-severity__zone--fatal" title="Fatal (10)"></span>
        </div>
      </div>
    </div>

    {{!-- ═══════════════════════════════════════════════════════════════════
         TAB NAVIGATION
    ═══════════════════════════════════════════════════════════════════ --}}
    <nav class="rt-tabs rt-tabs--injury rt-injury-tabs" data-group="primary">
      <button type="button" class="rt-tab rt-injury-tab active" data-tab="details" data-group="primary">
        <i class="fas fa-info-circle"></i>
        <span>Details</span>
      </button>
      <button type="button" class="rt-tab rt-injury-tab" data-tab="description" data-group="primary">
        <i class="fas fa-book"></i>
        <span>Description</span>
      </button>
    </nav>

    {{!-- ═══════════════════════════════════════════════════════════════════
         TAB CONTENT
    ═══════════════════════════════════════════════════════════════════ --}}
    <div class="rt-injury-content rt-tab-content rt-tab-content--injury scrollable">
      
      {{!-- DETAILS TAB --}}
      <div class="rt-injury-panel tab active" data-tab="details" data-group="primary">
        
        {{!-- Basic Properties --}}
        <div class="rt-injury-section">
          <div class="rt-injury-section__header">
            <i class="fas fa-cog"></i>
            <h3>Injury Properties</h3>
          </div>
          <div class="rt-injury-section__body">
            <div class="rt-field-grid rt-field-grid--2col">
              <div class="rt-field">
                <label>Damage Type</label>
                <select name="system.damageType">
                  <option value="impact" {{#if (eq item.system.damageType "impact")}}selected{{/if}}>Impact</option>
                  <option value="rending" {{#if (eq item.system.damageType "rending")}}selected{{/if}}>Rending</option>
                  <option value="explosive" {{#if (eq item.system.damageType "explosive")}}selected{{/if}}>Explosive</option>
                  <option value="energy" {{#if (eq item.system.damageType "energy")}}selected{{/if}}>Energy</option>
                </select>
              </div>
              <div class="rt-field">
                <label>Body Location</label>
                <select name="system.bodyPart">
                  <option value="head" {{#if (eq item.system.bodyPart "head")}}selected{{/if}}>Head</option>
                  <option value="arm" {{#if (eq item.system.bodyPart "arm")}}selected{{/if}}>Arm</option>
                  <option value="body" {{#if (eq item.system.bodyPart "body")}}selected{{/if}}>Body</option>
                  <option value="leg" {{#if (eq item.system.bodyPart "leg")}}selected{{/if}}>Leg</option>
                </select>
              </div>
              <div class="rt-field">
                <label>Severity (1-10)</label>
                <input type="number" name="system.severity" value="{{item.system.severity}}" 
                       data-dtype="Number" min="1" max="10" />
              </div>
              <div class="rt-field rt-field--checkbox">
                <label>
                  <input type="checkbox" name="system.permanent" {{checked item.system.permanent}} />
                  <span>Permanent Injury</span>
                </label>
              </div>
            </div>
          </div>
        </div>

        {{!-- Effect --}}
        <div class="rt-injury-section">
          <div class="rt-injury-section__header">
            <i class="fas fa-file-medical"></i>
            <h3>Injury Effect{{#if item.system.isConsolidated}} (Severity {{item.system.severity}}){{/if}}</h3>
          </div>
          <div class="rt-injury-section__body rt-injury-section__body--editor">
            {{#if inEditMode}}
              {{#if item.system.isConsolidated}}
                {{!-- Consolidated format: Show all severity levels for editing --}}
                {{#each item.system.availableSeverities as |sev|}}
                  <div class="rt-severity-effect-editor">
                    <label><strong>Severity {{sev}}:</strong></label>
                    {{editor content=(lookup item.system.effects sev).text target=(concat "system.effects." sev ".text") button=true editable=true engine="prosemirror"}}
                    <label>
                      <input type="checkbox" name="system.effects.{{sev}}.permanent" {{checked (lookup item.system.effects sev).permanent}} />
                      <span>Permanent</span>
                    </label>
                  </div>
                {{/each}}
              {{else}}
                {{!-- Legacy format: Single effect editor --}}
                {{editor content=system.effect target="system.effect" button=true editable=true engine="prosemirror"}}
              {{/if}}
            {{else}}
              {{!-- View mode: Show current severity effect --}}
              <div class="rt-description-content">{{{item.system.currentEffect}}}</div>
              {{#if item.system.isConsolidated}}
                <div class="rt-injury-severity-preview">
                  <p><em>This injury has effects for all severity levels 1-10. Change the severity slider to preview different effects.</em></p>
                </div>
              {{/if}}
            {{/if}}
          </div>
        </div>

        {{!-- Notes --}}
        <div class="rt-injury-section">
          <div class="rt-injury-section__header">
            <i class="fas fa-sticky-note"></i>
            <h3>GM Notes</h3>
          </div>
          <div class="rt-injury-section__body">
            <textarea name="system.notes" rows="3" placeholder="Treatment details, duration, special circumstances...">{{item.system.notes}}</textarea>
          </div>
        </div>

      </div>

      {{!-- DESCRIPTION TAB --}}
      <div class="rt-injury-panel tab" data-tab="description" data-group="primary">
        
        {{!-- Full Description --}}
        <div class="rt-injury-section">
          <div class="rt-injury-section__header">
            <i class="fas fa-book"></i>
            <h3>Description</h3>
          </div>
          <div class="rt-injury-section__body rt-injury-section__body--editor">
            {{#if inEditMode}}
            {{editor content=system.description.value target="system.description.value" button=true editable=true engine="prosemirror"}}
            {{else}}
            <div class="rt-description-content">{{{system.description.value}}}</div>
            {{/if}}
          </div>
        </div>

        {{!-- Source --}}
        <div class="rt-injury-section">
          <div class="rt-injury-section__header">
            <i class="fas fa-book-open"></i>
            <h3>Source</h3>
          </div>
          <div class="rt-injury-section__body">
            <div class="rt-field-grid rt-field-grid--3col">
              <div class="rt-field">
                <label>Source Book</label>
                <input type="text" name="system.source.book" value="{{system.source.book}}" 
                       placeholder="Rogue Trader Core" />
              </div>
              <div class="rt-field">
                <label>Page</label>
                <input type="text" name="system.source.page" value="{{system.source.page}}" 
                       placeholder="254" />
              </div>
              <div class="rt-field">
                <label>Custom Reference</label>
                <input type="text" name="system.source.custom" value="{{system.source.custom}}" 
                       placeholder="Homebrew" />
              </div>
            </div>
          </div>
        </div>

      </div>

    </div>

  </form>
</div>
