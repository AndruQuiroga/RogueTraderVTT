{{!-- 
  Rogue Trader Weapon Item Sheet V3 - Modern Single-Page Redesign
  Features: Sticky header+stats, FAB actions, collapsible sections, color-coded stats
--}}
<div class="rt-item-sheet rt-weapon-sheet-v3">
  <form autocomplete="off">
    
    {{!-- ═══════════════════════════════════════════════════════════════════
         STICKY HEADER AREA (Header + Stats)
    ═══════════════════════════════════════════════════════════════════ --}}
    <div class="rt-weapon-sticky-header">
      
      {{!-- HEADER WITH EDIT TOGGLE --}}
      <header class="rt-weapon-header">
        <div class="rt-item-image rt-item-image--sm" data-edit="img" data-action="editImage">
          <img src="{{item.img}}" alt="{{item.name}}" />
        </div>

        <div class="rt-item-title">
          {{#if inEditMode}}
          <input type="text" class="rt-item-title__name" name="name" value="{{item.name}}" placeholder="Weapon Name" />
          {{else}}
          <h2 class="rt-item-title__name rt-item-title__name--readonly">{{item.name}}</h2>
          {{/if}}
          
          <div class="rt-item-meta rt-weapon-meta">
            <span class="rt-meta-badge rt-meta-badge--weapon-class" title="{{system.classLabel}}">
              <i class="fa-solid fa-{{#if system.isMeleeWeapon}}sword{{else}}gun{{/if}}"></i>
              {{system.classLabel}}
            </span>
            <span class="rt-meta-badge rt-meta-badge--weapon-type" title="{{system.typeLabel}}">
              {{system.typeLabel}}
            </span>
            {{#if (ne system.craftsmanship "common")}}
            <span class="rt-meta-badge rt-meta-badge--craft rt-meta-badge--{{system.craftsmanship}}" title="Craftsmanship">
              {{system.craftsmanshipLabel}}
            </span>
            {{/if}}
          </div>
        </div>

        <div class="rt-weapon-header-actions">
          {{#if isOwnedByActor}}
          <label class="rt-toggle-equipped" title="Toggle Equipped">
            <input type="checkbox" name="system.equipped" {{checked system.equipped}} />
            <span class="rt-toggle-equipped__indicator">
              <i class="fa-solid {{#if system.equipped}}fa-circle-check{{else}}fa-circle{{/if}}"></i>
            </span>
          </label>
          {{/if}}
          
          {{#if canEdit}}
          <button type="button" class="rt-edit-toggle {{#if inEditMode}}active{{/if}}"
                  data-action="toggleEditMode"
                  data-tooltip="{{#if inEditMode}}Exit Edit Mode{{else}}Edit Mode{{/if}}">
            <i class="fa-solid {{#if inEditMode}}fa-lock-open{{else}}fa-pen-to-square{{/if}}"></i>
          </button>
          {{/if}}
        </div>
      </header>

      {{!-- ICONIC STAT MOSAIC --}}
      <div class="rt-weapon-mosaic">
        {{!-- Damage - Skull (Large, 2x) --}}
        <div class="rt-iconic-stat rt-iconic-stat--damage rt-iconic-stat--large {{#if hasModificationEffects}}rt-iconic-stat--modified{{/if}}"
             data-tooltip="Damage">
          <div class="rt-iconic-stat__shape">
            <i class="fa-solid fa-skull"></i>
          </div>
          <div class="rt-iconic-stat__content">
            <span class="rt-iconic-stat__value">{{effectiveDamageLabel}}</span>
            <span class="rt-iconic-stat__label">Damage</span>
          </div>
          <div class="rt-iconic-stat__glow"></div>
        </div>
        
        {{!-- Penetration - Arrow (Medium) --}}
        <div class="rt-iconic-stat rt-iconic-stat--pen rt-iconic-stat--medium {{#if hasModificationEffects}}rt-iconic-stat--modified{{/if}}"
             data-tooltip="Penetration">
          <div class="rt-iconic-stat__shape">
            <i class="fa-solid fa-location-arrow"></i>
          </div>
          <div class="rt-iconic-stat__content">
            <span class="rt-iconic-stat__value">{{effectivePenetration}}</span>
            <span class="rt-iconic-stat__label">Pen</span>
          </div>
          <div class="rt-iconic-stat__glow"></div>
        </div>
        
        {{!-- To Hit - Crosshairs (Medium, conditional) --}}
        {{#if (ne effectiveToHit 0)}}
        <div class="rt-iconic-stat rt-iconic-stat--tohit rt-iconic-stat--medium"
             data-tooltip="To Hit Modifier">
          <div class="rt-iconic-stat__shape">
            <i class="fa-solid fa-crosshairs"></i>
          </div>
          <div class="rt-iconic-stat__content">
            <span class="rt-iconic-stat__value {{#if (gt effectiveToHit 0)}}rt-iconic-stat__value--positive{{else}}rt-iconic-stat__value--negative{{/if}}">
              {{#if (gt effectiveToHit 0)}}+{{/if}}{{effectiveToHit}}
            </span>
            <span class="rt-iconic-stat__label">To Hit</span>
          </div>
          <div class="rt-iconic-stat__glow"></div>
        </div>
        {{/if}}
        
        {{!-- Range - Crosshairs/Target (Medium, ranged only) --}}
        {{#if system.isRangedWeapon}}
        <div class="rt-iconic-stat rt-iconic-stat--range rt-iconic-stat--medium"
             data-tooltip="Range">
          <div class="rt-iconic-stat__shape">
            <i class="fa-solid fa-bullseye"></i>
          </div>
          <div class="rt-iconic-stat__content">
            <span class="rt-iconic-stat__value">{{system.rangeLabel}}</span>
            <span class="rt-iconic-stat__label">Range</span>
          </div>
          <div class="rt-iconic-stat__glow"></div>
        </div>
        
        {{!-- Rate of Fire - Burst (Small) --}}
        <div class="rt-iconic-stat rt-iconic-stat--rof rt-iconic-stat--small"
             data-tooltip="Rate of Fire">
          <div class="rt-iconic-stat__shape">
            <i class="fa-solid fa-burst"></i>
          </div>
          <div class="rt-iconic-stat__content">
            <span class="rt-iconic-stat__value">{{system.rateOfFireLabel}}</span>
            <span class="rt-iconic-stat__label">RoF</span>
          </div>
          <div class="rt-iconic-stat__glow"></div>
        </div>
        {{/if}}
        
        {{!-- Clip - Magazine (Small, with progress) --}}
        {{#if system.usesAmmo}}
        <div class="rt-iconic-stat rt-iconic-stat--clip rt-iconic-stat--small rt-iconic-stat--ammo-{{system.ammoStatus}}"
             data-tooltip="Ammunition">
          <div class="rt-iconic-stat__shape">
            <i class="fa-solid fa-gun"></i>
          </div>
          <div class="rt-iconic-stat__content">
            <span class="rt-iconic-stat__value">{{system.clip.value}}/{{system.clip.max}}</span>
            <span class="rt-iconic-stat__label">Clip</span>
          </div>
          <div class="rt-iconic-stat__progress" style="--progress: {{system.ammoPercentage}}%"></div>
          <div class="rt-iconic-stat__glow"></div>
        </div>
        {{/if}}
        
        {{!-- Weight - Scale (Small) --}}
        <div class="rt-iconic-stat rt-iconic-stat--weight rt-iconic-stat--small"
             data-tooltip="Weight">
          <div class="rt-iconic-stat__shape">
            <i class="fa-solid fa-scale-balanced"></i>
          </div>
          <div class="rt-iconic-stat__content">
            <span class="rt-iconic-stat__value">{{effectiveWeight}}<small>kg</small></span>
            <span class="rt-iconic-stat__label">Weight</span>
          </div>
          <div class="rt-iconic-stat__glow"></div>
        </div>
        
        {{!-- Individual Quality Cards --}}
        {{#each qualitiesArray}}
        <div class="rt-iconic-stat rt-iconic-stat--quality rt-iconic-stat--small"
             data-action="openQuality"
             data-identifier="{{identifier}}"
             data-rt-tooltip="quality"
             data-rt-tooltip-data="{{@root.prepareQualityTooltip identifier level}}">
          <div class="rt-iconic-stat__shape">
            <i class="fa-solid fa-star"></i>
          </div>
          <div class="rt-iconic-stat__content">
            <span class="rt-iconic-stat__value rt-iconic-stat__value--quality">{{label}}</span>
          </div>
          <div class="rt-iconic-stat__glow"></div>
        </div>
        {{/each}}
      </div>
      
      {{!-- Body Toggle Button --}}
      <button type="button" class="rt-body-toggle" data-action="toggleBody" title="{{#if bodyCollapsed}}Show Details{{else}}Hide Details{{/if}}">
        <span class="rt-body-toggle__label">{{#if bodyCollapsed}}Show Details{{else}}Hide Details{{/if}}</span>
        <i class="fa-solid {{#if bodyCollapsed}}fa-chevron-down{{else}}fa-chevron-up{{/if}} rt-body-toggle__icon"></i>
      </button>
    </div>

    {{!-- ═══════════════════════════════════════════════════════════════════
         SCROLLABLE BODY
    ═══════════════════════════════════════════════════════════════════ --}}
    <div class="rt-weapon-body {{#if bodyCollapsed}}collapsed{{/if}}">
      
      {{!-- LOADED AMMO BANNER (if loaded) --}}
      {{#if (and system.usesAmmo hasLoadedAmmo)}}
      <div class="rt-loaded-ammo-card">
        <div class="rt-loaded-ammo-card__header">
          <i class="fa-solid fa-circle-dot"></i>
          <span class="rt-loaded-ammo-card__name">{{loadedAmmoLabel}}</span>
          {{#if isOwnedByActor}}
          <button type="button" class="rt-btn rt-btn--icon rt-btn--ghost" data-action="ejectAmmo" title="Eject">
            <i class="fa-solid fa-eject"></i>
          </button>
          {{/if}}
        </div>
        {{#if loadedAmmoData.modifiers}}
        <div class="rt-loaded-ammo-card__effects">
          {{#if (ne loadedAmmoData.modifiers.damage 0)}}
          <span class="rt-ammo-mod {{#if (gt loadedAmmoData.modifiers.damage 0)}}rt-ammo-mod--positive{{else}}rt-ammo-mod--negative{{/if}}">
            Dmg {{#if (gt loadedAmmoData.modifiers.damage 0)}}+{{/if}}{{loadedAmmoData.modifiers.damage}}
          </span>
          {{/if}}
          {{#if (ne loadedAmmoData.modifiers.penetration 0)}}
          <span class="rt-ammo-mod {{#if (gt loadedAmmoData.modifiers.penetration 0)}}rt-ammo-mod--positive{{else}}rt-ammo-mod--negative{{/if}}">
            Pen {{#if (gt loadedAmmoData.modifiers.penetration 0)}}+{{/if}}{{loadedAmmoData.modifiers.penetration}}
          </span>
          {{/if}}
          {{#if (gt loadedAmmoData.addedQualities.length 0)}}
          <span class="rt-ammo-mod rt-ammo-mod--quality">+{{join loadedAmmoData.addedQualities ", "}}</span>
          {{/if}}
        </div>
        {{/if}}
      </div>
      {{/if}}

      {{!-- MODIFICATIONS CARDS (Integrated) --}}
      {{#if modificationsData.length}}
      <div class="rt-mods-inline">
        {{#each modificationsData as |mod|}}
        <div class="rt-mod-chip {{#unless mod.active}}rt-mod-chip--inactive{{/unless}}">
          <i class="fa-solid {{mod.categoryIcon}}"></i>
          <span>{{mod.name}}</span>
          <button type="button" class="rt-mod-chip__toggle" 
                  data-action="toggleModificationActive" 
                  data-mod-index="{{mod.index}}"
                  title="{{#if mod.active}}Deactivate{{else}}Activate{{/if}}">
            <i class="fa-solid {{#if mod.active}}fa-toggle-on{{else}}fa-toggle-off{{/if}}"></i>
          </button>
        </div>
        {{/each}}
      </div>
      {{/if}}
      
      {{!-- ─────────────────────────────────────────────────────────────────
           COLLAPSIBLE SECTIONS
      ───────────────────────────────────────────────────────────────── --}}
      
      {{!-- COMBAT STATISTICS --}}
      <section class="rt-section">
        <header class="rt-section__header" data-action="toggleSection" data-section="combat">
          <i class="fa-solid fa-swords"></i>
          <span>Combat Statistics</span>
          <i class="fa-solid fa-chevron-down rt-section__toggle"></i>
        </header>
        <div class="rt-section__body" data-section-content="combat">
          <div class="rt-form-grid rt-form-grid--2col">
            {{!-- Damage Formula (single field) --}}
            {{#if inEditMode}}
            <div class="rt-float-field">
              <input type="text" name="system.damage.formula" value="{{system.damage.formula}}" placeholder=" " id="damage-formula" />
              <label for="damage-formula">Damage Formula</label>
              <span class="rt-float-field__bar"></span>
            </div>
            {{else}}
            <div class="rt-form-field">
              <label>Damage</label>
              <div class="rt-form-field__value">{{system.damage.formula}}</div>
            </div>
            {{/if}}
            
            {{!-- Penetration --}}
            {{#if inEditMode}}
            <div class="rt-float-field rt-float-field--narrow">
              <input type="number" name="system.damage.penetration" value="{{system.damage.penetration}}" placeholder=" " id="penetration" />
              <label for="penetration">Penetration</label>
              <span class="rt-float-field__bar"></span>
            </div>
            {{else}}
            <div class="rt-form-field rt-form-field--narrow">
              <label>Penetration</label>
              <div class="rt-form-field__value">{{system.damage.penetration}}</div>
            </div>
            {{/if}}
            
            {{!-- Damage Type --}}
            {{#if inEditMode}}
            <div class="rt-float-field rt-float-field--select">
              <select name="system.damage.type" id="damage-type">
                {{selectOptions damageTypes selected=system.damage.type labelAttr="label"}}
              </select>
              <label for="damage-type">Damage Type</label>
              <i class="fa-solid fa-chevron-down rt-float-field__arrow"></i>
            </div>
            {{else}}
            <div class="rt-form-field">
              <label>Type</label>
              <div class="rt-form-field__value">{{system.damage.typeLabel}}</div>
            </div>
            {{/if}}
            
            {{!-- Weapon Class --}}
            {{#if inEditMode}}
            <div class="rt-float-field rt-float-field--select">
              <select name="system.class" id="weapon-class">
                {{selectOptions weaponClasses selected=system.class labelAttr="label"}}
              </select>
              <label for="weapon-class">Class</label>
              <i class="fa-solid fa-chevron-down rt-float-field__arrow"></i>
            </div>
            {{else}}
            <div class="rt-form-field">
              <label>Class</label>
              <div class="rt-form-field__value">{{system.classLabel}}</div>
            </div>
            {{/if}}
            
            {{!-- Weapon Type --}}
            {{#if inEditMode}}
            <div class="rt-float-field rt-float-field--select">
              <select name="system.type" id="weapon-type">
                {{selectOptions weaponTypes selected=system.type labelAttr="label"}}
              </select>
              <label for="weapon-type">Weapon Type</label>
              <i class="fa-solid fa-chevron-down rt-float-field__arrow"></i>
            </div>
            {{else}}
            <div class="rt-form-field">
              <label>Type</label>
              <div class="rt-form-field__value">{{system.typeLabel}}</div>
            </div>
            {{/if}}
          </div>
          
          {{!-- Toggle Switches Row --}}
          {{#if inEditMode}}
          <div class="rt-toggle-row">
            <label class="rt-toggle-switch">
              <input type="checkbox" name="system.twoHanded" {{checked system.twoHanded}} />
              <span class="rt-toggle-switch__slider"></span>
              <span class="rt-toggle-switch__label"><i class="fa-solid fa-hands"></i> Two-Handed</span>
            </label>
            <label class="rt-toggle-switch">
              <input type="checkbox" name="system.melee" {{checked system.melee}} />
              <span class="rt-toggle-switch__slider"></span>
              <span class="rt-toggle-switch__label"><i class="fa-solid fa-sword"></i> Can Melee</span>
            </label>
          </div>
          {{/if}}
        </div>
      </section>
      
      {{!-- RANGED ATTACK (if ranged) --}}
      {{#if system.isRangedWeapon}}
      <section class="rt-section">
        <header class="rt-section__header" data-action="toggleSection" data-section="ranged">
          <i class="fa-solid fa-crosshairs"></i>
          <span>Ranged Attack</span>
          <i class="fa-solid fa-chevron-down rt-section__toggle"></i>
        </header>
        <div class="rt-section__body" data-section-content="ranged">
          <div class="rt-form-grid rt-form-grid--2col">
            {{!-- Range --}}
            {{#if inEditMode}}
            <div class="rt-float-field">
              <input type="number" name="system.attack.range.value" value="{{system.attack.range.value}}" placeholder=" " id="range-value" />
              <label for="range-value">Range (m)</label>
              <span class="rt-float-field__bar"></span>
            </div>
            {{else}}
            <div class="rt-form-field">
              <label>Range (m)</label>
              <div class="rt-form-field__value">{{system.attack.range.value}}m</div>
            </div>
            {{/if}}
            
            {{!-- Special Range --}}
            {{#if inEditMode}}
            <div class="rt-float-field">
              <input type="text" name="system.attack.range.special" value="{{system.attack.range.special}}" placeholder=" " id="range-special" />
              <label for="range-special">Special</label>
              <span class="rt-float-field__bar"></span>
            </div>
            {{else}}
            <div class="rt-form-field">
              <label>Special</label>
              <div class="rt-form-field__value">{{system.attack.range.special}}</div>
            </div>
            {{/if}}
          </div>
          
          {{!-- Rate of Fire --}}
          {{#if inEditMode}}
          <div class="rt-rof-grid">
            <label class="rt-checkbox">
              <input type="checkbox" name="system.attack.rateOfFire.single" {{checked system.attack.rateOfFire.single}} />
              <span>Single (S)</span>
            </label>
            <div class="rt-float-field rt-float-field--narrow">
              <input type="number" name="system.attack.rateOfFire.semi" value="{{system.attack.rateOfFire.semi}}" min="0" placeholder=" " id="rof-semi" />
              <label for="rof-semi">Semi</label>
              <span class="rt-float-field__bar"></span>
            </div>
            <div class="rt-float-field rt-float-field--narrow">
              <input type="number" name="system.attack.rateOfFire.full" value="{{system.attack.rateOfFire.full}}" min="0" placeholder=" " id="rof-full" />
              <label for="rof-full">Full</label>
              <span class="rt-float-field__bar"></span>
            </div>
          </div>
          {{else}}
          <div class="rt-form-field">
            <label>Rate of Fire</label>
            <div class="rt-form-field__value">{{system.rateOfFireLabel}}</div>
          </div>
          {{/if}}
        </div>
      </section>
      {{/if}}
      
      {{!-- AMMUNITION (if uses ammo) --}}
      {{#if system.usesAmmo}}
      <section class="rt-section">
        <header class="rt-section__header" data-action="toggleSection" data-section="ammunition">
          <i class="fa-solid fa-box-archive"></i>
          <span>Ammunition</span>
          <i class="fa-solid fa-chevron-down rt-section__toggle"></i>
        </header>
        <div class="rt-section__body" data-section-content="ammunition">
          <div class="rt-form-grid rt-form-grid--3col">
            {{!-- Current --}}
            {{#if inEditMode}}
            <div class="rt-float-field rt-float-field--narrow">
              <input type="number" name="system.clip.value" value="{{system.clip.value}}" min="0" placeholder=" " id="clip-current" />
              <label for="clip-current">Current</label>
              <span class="rt-float-field__bar"></span>
            </div>
            {{else}}
            <div class="rt-form-field rt-form-field--narrow">
              <label>Current</label>
              <div class="rt-form-field__value">{{system.clip.value}}</div>
            </div>
            {{/if}}
            
            {{!-- Max --}}
            {{#if inEditMode}}
            <div class="rt-float-field rt-float-field--narrow">
              <input type="number" name="system.clip.max" value="{{system.clip.max}}" min="0" placeholder=" " id="clip-max" />
              <label for="clip-max">Max</label>
              <span class="rt-float-field__bar"></span>
            </div>
            {{else}}
            <div class="rt-form-field rt-form-field--narrow">
              <label>Max</label>
              <div class="rt-form-field__value">{{system.clip.max}}</div>
            </div>
            {{/if}}
            
            {{!-- Reload Time --}}
            {{#if inEditMode}}
            <div class="rt-float-field rt-float-field--select">
              <select name="system.reload" id="reload-time">
                {{selectOptions reloadTimes selected=system.reload labelAttr="label"}}
              </select>
              <label for="reload-time">Reload</label>
              <i class="fa-solid fa-chevron-down rt-float-field__arrow"></i>
            </div>
            {{else}}
            <div class="rt-form-field">
              <label>Reload</label>
              <div class="rt-form-field__value">{{system.reloadLabel}}</div>
            </div>
            {{/if}}
          </div>
          
          {{!-- Ammo Dropzone --}}
          {{#unless hasLoadedAmmo}}
          <div class="rt-ammo-dropzone">
            <i class="fa-solid fa-bullseye"></i>
            <p>Standard Ammunition</p>
            <p class="rt-hint">Drag special ammo here to load</p>
          </div>
          {{/unless}}
        </div>
      </section>
      {{/if}}
      
      {{!-- ACQUISITION --}}
      <section class="rt-section">
        <header class="rt-section__header" data-action="toggleSection" data-section="acquisition">
          <i class="fa-solid fa-coins"></i>
          <span>Acquisition</span>
          <i class="fa-solid fa-chevron-down rt-section__toggle"></i>
        </header>
        <div class="rt-section__body" data-section-content="acquisition">
          <div class="rt-form-grid rt-form-grid--2col">
            {{!-- Availability --}}
            {{#if inEditMode}}
            <div class="rt-float-field rt-float-field--select">
              <select name="system.availability" id="availability">
                {{selectOptions availabilities selected=system.availability labelAttr="label"}}
              </select>
              <label for="availability">Availability</label>
              <i class="fa-solid fa-chevron-down rt-float-field__arrow"></i>
            </div>
            {{else}}
            <div class="rt-form-field">
              <label>Availability</label>
              <div class="rt-form-field__value">{{system.availabilityLabel}}</div>
            </div>
            {{/if}}
            
            {{!-- Craftsmanship --}}
            {{#if inEditMode}}
            <div class="rt-float-field rt-float-field--select">
              <select name="system.craftsmanship" id="craftsmanship">
                {{selectOptions craftsmanships selected=system.craftsmanship labelAttr="label"}}
              </select>
              <label for="craftsmanship">Craftsmanship</label>
              <i class="fa-solid fa-chevron-down rt-float-field__arrow"></i>
            </div>
            {{else}}
            <div class="rt-form-field">
              <label>Craftsmanship</label>
              <div class="rt-form-field__value">{{system.craftsmanshipLabel}}</div>
            </div>
            {{/if}}
            
            {{!-- Weight --}}
            {{#if inEditMode}}
            <div class="rt-float-field rt-float-field--narrow">
              <input type="number" name="system.weight" value="{{system.weight}}" step="0.1" min="0" placeholder=" " id="weight" />
              <label for="weight">Weight (kg)</label>
              <span class="rt-float-field__bar"></span>
            </div>
            {{else}}
            <div class="rt-form-field rt-form-field--narrow">
              <label>Weight (kg)</label>
              <div class="rt-form-field__value">{{system.weight}}kg</div>
            </div>
            {{/if}}
            
            {{!-- Source --}}
            {{#if inEditMode}}
            <div class="rt-float-field">
              <input type="text" name="system.source" value="{{system.source}}" placeholder=" " id="source" />
              <label for="source">Source</label>
              <span class="rt-float-field__bar"></span>
            </div>
            {{else}}
            <div class="rt-form-field">
              <label>Source</label>
              <div class="rt-form-field__value">{{system.source}}</div>
            </div>
            {{/if}}
          </div>
        </div>
      </section>
      
      {{!-- DESCRIPTION --}}
      <section class="rt-section">
        <header class="rt-section__header" data-action="toggleSection" data-section="description">
          <i class="fa-solid fa-scroll"></i>
          <span>Description</span>
          <i class="fa-solid fa-chevron-down rt-section__toggle"></i>
        </header>
        <div class="rt-section__body rt-section__body--prose" data-section-content="description">
          {{#if inEditMode}}
          <div class="rt-description-editor">
            {{editor system.description.value target="system.description.value" button=true editable=editable engine="prosemirror"}}
          </div>
          {{else}}
          <div class="rt-prose rt-prose--clickable {{#if canEdit}}rt-prose--editable{{/if}}" 
               {{#if canEdit}}data-action="toggleEditMode" title="Click to edit"{{/if}}>
            {{#if system.description.value}}
            {{{system.description.value}}}
            {{else}}
            <p class="rt-prose__placeholder"><i class="fa-solid fa-pen"></i> Click to add description...</p>
            {{/if}}
          </div>
          {{/if}}
          
          {{!-- Notes (edit mode only) --}}
          {{#if inEditMode}}
          <div class="rt-form-field rt-form-field--full" style="padding: 10px 12px;">
            <label>Notes</label>
            <textarea name="system.notes" rows="2" placeholder="Personal notes...">{{system.notes}}</textarea>
          </div>
          {{/if}}
        </div>
      </section>
      
      {{!-- MODIFICATIONS SECTION (for adding/managing) --}}
      {{#if inEditMode}}
      <section class="rt-section">
        <header class="rt-section__header" data-action="toggleSection" data-section="modifications">
          <i class="fa-solid fa-wrench"></i>
          <span>Modifications</span>
          {{#if modificationsData.length}}
          <span class="rt-badge">{{modificationsData.length}}</span>
          {{/if}}
          <i class="fa-solid fa-chevron-down rt-section__toggle"></i>
        </header>
        <div class="rt-section__body" data-section-content="modifications">
          {{#if modificationsData.length}}
          <div class="rt-mods-list" data-drop-zone="modifications">
            {{#each modificationsData as |mod|}}
            <div class="rt-mod-card {{#unless mod.active}}rt-mod-card--inactive{{/unless}}" data-mod-index="{{mod.index}}">
              <div class="rt-mod-card__info">
                <i class="fa-solid {{mod.categoryIcon}}"></i>
                <span class="rt-mod-card__name">{{mod.name}}</span>
              </div>
              {{#if mod.hasEffects}}
              <div class="rt-mod-card__effects">
                {{#each mod.effects}}
                <span class="rt-mod-effect">{{this}}</span>
                {{/each}}
              </div>
              {{/if}}
              <div class="rt-mod-card__actions">
                <button type="button" class="rt-btn rt-btn--icon rt-btn--ghost" 
                        data-action="viewModification" data-mod-index="{{mod.index}}" title="View">
                  <i class="fa-solid fa-eye"></i>
                </button>
                <button type="button" class="rt-btn rt-btn--icon rt-btn--ghost rt-btn--danger" 
                        data-action="removeModification" data-mod-index="{{mod.index}}" title="Remove">
                  <i class="fa-solid fa-trash"></i>
                </button>
              </div>
            </div>
            {{/each}}
          </div>
          {{else}}
          <div class="rt-empty-state rt-mod-dropzone" data-drop-zone="modifications">
            <i class="fa-solid fa-wrench"></i>
            <p>No modifications</p>
            <p class="rt-hint">Drag modifications from compendium</p>
          </div>
          {{/if}}
        </div>
      </section>
      {{/if}}
      
      {{!-- ACTIVE EFFECTS (collapsed by default in view mode) --}}
      {{#if effects.length}}
      <section class="rt-section rt-section--effects">
        <header class="rt-section__header" data-action="toggleSection" data-section="effects">
          <i class="fa-solid fa-wand-magic-sparkles"></i>
          <span>Active Effects</span>
          <span class="rt-badge">{{effects.length}}</span>
          <i class="fa-solid fa-chevron-down rt-section__toggle"></i>
        </header>
        <div class="rt-section__body" data-section-content="effects">
          {{> systems/rogue-trader/templates/item/panel/active-effects-panel.hbs}}
        </div>
      </section>
      {{/if}}
      
    </div>

    {{!-- ═══════════════════════════════════════════════════════════════════
         FAB (Floating Action Button)
    ═══════════════════════════════════════════════════════════════════ --}}
    {{#if isOwnedByActor}}
    <div class="rt-fab-container {{#if fabExpanded}}expanded{{/if}}">
      <button type="button" class="rt-fab rt-fab--main" data-action="toggleFab" title="Actions">
        <i class="fa-solid fa-dice-d20"></i>
      </button>
      <div class="rt-fab-actions">
        <button type="button" class="rt-fab rt-fab--attack" data-action="rollAttack" title="Attack Roll">
          <i class="fa-solid fa-crosshairs"></i>
          <span>Attack</span>
        </button>
        <button type="button" class="rt-fab rt-fab--damage" data-action="rollDamage" title="Damage Roll">
          <i class="fa-solid fa-burst"></i>
          <span>Damage</span>
        </button>
        {{#if system.usesAmmo}}
        <button type="button" class="rt-fab rt-fab--reload {{#if (eq system.clip.value system.clip.max)}}rt-fab--disabled{{/if}}" 
                data-action="reload" 
                title="Reload ({{system.reloadLabel}})"
                {{#if (eq system.clip.value system.clip.max)}}disabled{{/if}}>
          <i class="fa-solid fa-rotate-right"></i>
          <span>Reload</span>
        </button>
        {{/if}}
      </div>
    </div>
    {{/if}}

  </form>
</div>
