{{!-- 
  Rogue Trader Weapon Item Sheet - Modern Redesign
  A sleek, information-dense weapon sheet for the grim darkness of the far future.
--}}
<div class="rt-weapon-sheet">
  <form autocomplete="off">
    
    {{!-- ═══════════════════════════════════════════════════════════════════
         HEADER: Compact weapon identity with inline stats
    ═══════════════════════════════════════════════════════════════════ --}}
    <header class="rt-weapon-header">
      <div class="rt-weapon-header__image" data-action="editImage" data-edit="img">
        <img src="{{item.img}}" alt="{{item.name}}" />
        <div class="rt-weapon-header__image-overlay">
          <i class="fas fa-edit"></i>
        </div>
      </div>
      
      <div class="rt-weapon-header__info">
        <input type="text" class="rt-weapon-header__name" name="name" value="{{item.name}}" placeholder="Weapon Name" />
        
        <div class="rt-weapon-header__meta">
          <span class="rt-weapon-badge rt-weapon-badge--class" title="Weapon Class">
            <i class="fas {{item.system.classIcon}}"></i>
            {{item.system.classLabel}}
          </span>
          <span class="rt-weapon-badge rt-weapon-badge--type" title="Weapon Type">
            {{item.system.typeLabel}}
          </span>
          {{#if (ne item.system.craftsmanship "common")}}
          <span class="rt-weapon-badge rt-weapon-badge--craft rt-weapon-badge--{{item.system.craftsmanship}}" title="Craftsmanship">
            <i class="fas fa-hammer"></i>
            {{item.system.craftsmanshipLabel}}
          </span>
          {{/if}}
          {{#if item.system.twoHanded}}
          <span class="rt-weapon-badge rt-weapon-badge--hands" title="Two-Handed">
            <i class="fas fa-hands"></i>
          </span>
          {{/if}}
        </div>
      </div>
      
      <div class="rt-weapon-header__equipped">
        <label class="rt-toggle-equipped" title="Toggle Equipped">
          <input type="checkbox" name="system.equipped" {{checked item.system.equipped}} />
          <span class="rt-toggle-equipped__indicator">
            <i class="fas {{#if item.system.equipped}}fa-check-circle{{else}}fa-circle{{/if}}"></i>
          </span>
          <span class="rt-toggle-equipped__label">{{#if item.system.equipped}}Equipped{{else}}Stowed{{/if}}</span>
        </label>
      </div>
    </header>

    {{!-- ═══════════════════════════════════════════════════════════════════
         STAT BAR: Primary combat stats at a glance
    ═══════════════════════════════════════════════════════════════════ --}}
    <div class="rt-weapon-stats">
      {{!-- Damage --}}
      <div class="rt-weapon-stat rt-weapon-stat--damage">
        <div class="rt-weapon-stat__icon">
          <i class="fas fa-burst"></i>
        </div>
        <div class="rt-weapon-stat__content">
          <span class="rt-weapon-stat__label">Damage</span>
          <span class="rt-weapon-stat__value">{{item.system.damageLabel}}</span>
        </div>
      </div>
      
      {{!-- Penetration --}}
      <div class="rt-weapon-stat rt-weapon-stat--pen">
        <div class="rt-weapon-stat__icon">
          <i class="fas fa-bullseye"></i>
        </div>
        <div class="rt-weapon-stat__content">
          <span class="rt-weapon-stat__label">Pen</span>
          <span class="rt-weapon-stat__value">{{item.system.damage.penetration}}</span>
        </div>
      </div>
      
      {{!-- Range (Ranged weapons only) --}}
      {{#if item.system.isRangedWeapon}}
      <div class="rt-weapon-stat rt-weapon-stat--range">
        <div class="rt-weapon-stat__icon">
          <i class="fas fa-arrows-left-right"></i>
        </div>
        <div class="rt-weapon-stat__content">
          <span class="rt-weapon-stat__label">Range</span>
          <span class="rt-weapon-stat__value">{{item.system.rangeLabel}}</span>
        </div>
      </div>
      
      {{!-- Rate of Fire --}}
      <div class="rt-weapon-stat rt-weapon-stat--rof">
        <div class="rt-weapon-stat__icon">
          <i class="fas fa-bolt"></i>
        </div>
        <div class="rt-weapon-stat__content">
          <span class="rt-weapon-stat__label">RoF</span>
          <span class="rt-weapon-stat__value">{{item.system.rateOfFireLabel}}</span>
        </div>
      </div>
      {{/if}}
      
      {{!-- Clip (if uses ammo) --}}
      {{#if item.system.usesAmmo}}
      <div class="rt-weapon-stat rt-weapon-stat--clip rt-weapon-stat--ammo-{{item.system.ammoStatus}}">
        <div class="rt-weapon-stat__icon">
          <i class="fas fa-database"></i>
        </div>
        <div class="rt-weapon-stat__content">
          <span class="rt-weapon-stat__label">Clip</span>
          <span class="rt-weapon-stat__value">{{item.system.clip.value}}/{{item.system.clip.max}}</span>
        </div>
        <div class="rt-weapon-stat__bar">
          <div class="rt-weapon-stat__bar-fill" style="width: {{item.system.ammoPercentage}}%"></div>
        </div>
      </div>
      {{/if}}
      
      {{!-- Weight --}}
      <div class="rt-weapon-stat rt-weapon-stat--weight">
        <div class="rt-weapon-stat__icon">
          <i class="fas fa-weight-hanging"></i>
        </div>
        <div class="rt-weapon-stat__content">
          <span class="rt-weapon-stat__label">Weight</span>
          <span class="rt-weapon-stat__value">{{item.system.weight}}kg</span>
        </div>
      </div>
    </div>

    {{!-- ═══════════════════════════════════════════════════════════════════
         QUALITIES BAR: Active weapon qualities with tooltips
    ═══════════════════════════════════════════════════════════════════ --}}
    {{#if item.system.effectiveSpecial.size}}
    <div class="rt-weapon-qualities">
      <div class="rt-weapon-qualities__label">
        <i class="fas fa-star"></i>
        Qualities
      </div>
      <div class="rt-weapon-qualities__tags">
        {{#each item.system.qualitiesArray as |quality|}}
        <span class="rt-quality-tag" data-tooltip="{{quality.description}}" data-tooltip-direction="UP">
          {{quality.label}}{{#if quality.level}} ({{quality.level}}){{/if}}
        </span>
        {{/each}}
      </div>
    </div>
    {{/if}}

    {{!-- ═══════════════════════════════════════════════════════════════════
         TAB NAVIGATION
    ═══════════════════════════════════════════════════════════════════ --}}
    <nav class="rt-weapon-tabs" data-group="primary">
      <button type="button" class="rt-weapon-tab active" data-tab="stats" data-group="primary">
        <i class="fas fa-chart-bar"></i>
        <span>Stats</span>
      </button>
      <button type="button" class="rt-weapon-tab" data-tab="qualities" data-group="primary">
        <i class="fas fa-star"></i>
        <span>Qualities</span>
      </button>
      <button type="button" class="rt-weapon-tab" data-tab="description" data-group="primary">
        <i class="fas fa-scroll"></i>
        <span>Info</span>
      </button>
      <button type="button" class="rt-weapon-tab" data-tab="effects" data-group="primary">
        <i class="fas fa-magic"></i>
        <span>Effects</span>
      </button>
    </nav>

    {{!-- ═══════════════════════════════════════════════════════════════════
         TAB CONTENT
    ═══════════════════════════════════════════════════════════════════ --}}
    <section class="rt-weapon-content">
      
      {{!-- ─────────────────────────────────────────────────────────────────
           STATS TAB: Editable weapon statistics
      ───────────────────────────────────────────────────────────────── --}}
      <div class="rt-weapon-panel active" data-tab="stats" data-group="primary">
        
        {{!-- Combat Stats Section --}}
        <div class="rt-weapon-section">
          <div class="rt-weapon-section__header">
            <i class="fas fa-swords"></i>
            <h3>Combat Statistics</h3>
          </div>
          <div class="rt-weapon-section__body">
            <div class="rt-field-row">
              <div class="rt-field">
                <label>Damage</label>
                <input type="text" name="system.damage.formula" value="{{item.system.damage.formula}}" placeholder="1d10" />
              </div>
              <div class="rt-field rt-field--small">
                <label>Bonus</label>
                <input type="number" name="system.damage.bonus" value="{{item.system.damage.bonus}}" />
              </div>
              <div class="rt-field rt-field--small">
                <label>Pen</label>
                <input type="number" name="system.damage.penetration" value="{{item.system.damage.penetration}}" />
              </div>
              <div class="rt-field">
                <label>Type</label>
                <select name="system.damage.type">
                  {{selectOptions (arrayToObject CONFIG.ROGUE_TRADER.damageTypes) selected=item.system.damage.type}}
                </select>
              </div>
            </div>
            
            <div class="rt-field-row">
              <div class="rt-field">
                <label>Class</label>
                <select name="system.class">
                  {{selectOptions (arrayToObject CONFIG.ROGUE_TRADER.weaponClasses) selected=item.system.class}}
                </select>
              </div>
              <div class="rt-field">
                <label>Type</label>
                <select name="system.type">
                  {{selectOptions (arrayToObject CONFIG.ROGUE_TRADER.weaponTypes) selected=item.system.type}}
                </select>
              </div>
            </div>
            
            <div class="rt-field-row rt-field-row--checkboxes">
              <label class="rt-checkbox">
                <input type="checkbox" name="system.twoHanded" {{checked item.system.twoHanded}} />
                <span><i class="fas fa-hands"></i> Two-Handed</span>
              </label>
              <label class="rt-checkbox">
                <input type="checkbox" name="system.melee" {{checked item.system.melee}} />
                <span><i class="fas fa-sword"></i> Can Melee</span>
              </label>
            </div>
          </div>
        </div>
        
        {{!-- Ranged Attack Section --}}
        {{#if item.system.isRangedWeapon}}
        <div class="rt-weapon-section">
          <div class="rt-weapon-section__header">
            <i class="fas fa-crosshairs"></i>
            <h3>Ranged Attack</h3>
          </div>
          <div class="rt-weapon-section__body">
            <div class="rt-field-row">
              <div class="rt-field">
                <label>Range (m)</label>
                <input type="number" name="system.attack.range.value" value="{{item.system.attack.range.value}}" />
              </div>
              <div class="rt-field">
                <label>Special Range</label>
                <input type="text" name="system.attack.range.special" value="{{item.system.attack.range.special}}" placeholder="SBx3" />
              </div>
            </div>
            
            <div class="rt-field-row">
              <label class="rt-checkbox">
                <input type="checkbox" name="system.attack.rateOfFire.single" {{checked item.system.attack.rateOfFire.single}} />
                <span>Single (S)</span>
              </label>
              <div class="rt-field rt-field--small">
                <label>Semi-Auto</label>
                <input type="number" name="system.attack.rateOfFire.semi" value="{{item.system.attack.rateOfFire.semi}}" min="0" />
              </div>
              <div class="rt-field rt-field--small">
                <label>Full-Auto</label>
                <input type="number" name="system.attack.rateOfFire.full" value="{{item.system.attack.rateOfFire.full}}" min="0" />
              </div>
            </div>
          </div>
        </div>
        {{/if}}
        
        {{!-- Ammunition Section --}}
        {{#if item.system.usesAmmo}}
        <div class="rt-weapon-section">
          <div class="rt-weapon-section__header">
            <i class="fas fa-database"></i>
            <h3>Ammunition</h3>
            {{#if item.system.jamThreshold}}
            <span class="rt-weapon-section__badge rt-weapon-section__badge--warning" title="Jam Threshold">
              <i class="fas fa-exclamation-triangle"></i> Jams {{item.system.jamThreshold}}+
            </span>
            {{/if}}
          </div>
          <div class="rt-weapon-section__body">
            <div class="rt-ammo-display">
              <div class="rt-ammo-display__bar">
                <div class="rt-ammo-display__fill rt-ammo-display__fill--{{item.system.ammoStatus}}" style="width: {{item.system.ammoPercentage}}%"></div>
                <span class="rt-ammo-display__text">{{item.system.clip.value}} / {{item.system.clip.max}}</span>
              </div>
              <div class="rt-ammo-display__controls">
                <button type="button" class="rt-btn rt-btn--small" data-action="reload" title="Reload">
                  <i class="fas fa-rotate-right"></i>
                </button>
              </div>
            </div>
            
            <div class="rt-field-row">
              <div class="rt-field rt-field--small">
                <label>Current</label>
                <input type="number" name="system.clip.value" value="{{item.system.clip.value}}" min="0" />
              </div>
              <div class="rt-field rt-field--small">
                <label>Max</label>
                <input type="number" name="system.clip.max" value="{{item.system.clip.max}}" min="0" />
              </div>
              <div class="rt-field">
                <label>Reload Time</label>
                <select name="system.reload">
                  <option value="-" {{#if (eq item.system.reload "-")}}selected{{/if}}>—</option>
                  <option value="free" {{#if (eq item.system.reload "free")}}selected{{/if}}>Free Action</option>
                  <option value="half" {{#if (eq item.system.reload "half")}}selected{{/if}}>Half Action</option>
                  <option value="full" {{#if (eq item.system.reload "full")}}selected{{/if}}>Full Action</option>
                  <option value="2-full" {{#if (eq item.system.reload "2-full")}}selected{{/if}}>2 Full Actions</option>
                  <option value="3-full" {{#if (eq item.system.reload "3-full")}}selected{{/if}}>3 Full Actions</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        {{/if}}
        
        {{!-- Acquisition Section --}}
        <div class="rt-weapon-section">
          <div class="rt-weapon-section__header">
            <i class="fas fa-coins"></i>
            <h3>Acquisition</h3>
          </div>
          <div class="rt-weapon-section__body">
            <div class="rt-field-row">
              <div class="rt-field">
                <label>Availability</label>
                <select name="system.availability">
                  {{selectOptions (arrayToObject CONFIG.ROGUE_TRADER.availabilities) selected=item.system.availability}}
                </select>
              </div>
              <div class="rt-field">
                <label>Craftsmanship</label>
                <select name="system.craftsmanship">
                  {{selectOptions (arrayToObject CONFIG.ROGUE_TRADER.craftsmanships) selected=item.system.craftsmanship}}
                </select>
              </div>
            </div>
            <div class="rt-field-row">
              <div class="rt-field rt-field--small">
                <label>Weight (kg)</label>
                <input type="number" name="system.weight" value="{{item.system.weight}}" step="0.1" min="0" />
              </div>
              <div class="rt-field">
                <label>Source</label>
                <input type="text" name="system.source" value="{{item.system.source}}" placeholder="Core Rulebook p.XX" />
              </div>
            </div>
          </div>
        </div>
      </div>
      
      {{!-- ─────────────────────────────────────────────────────────────────
           QUALITIES TAB: Weapon special properties
      ───────────────────────────────────────────────────────────────── --}}
      <div class="rt-weapon-panel" data-tab="qualities" data-group="primary">
        
        {{!-- Craftsmanship Effects --}}
        {{#if (ne item.system.craftsmanship "common")}}
        <div class="rt-weapon-section rt-weapon-section--craftsmanship">
          <div class="rt-weapon-section__header">
            <i class="fas fa-hammer"></i>
            <h3>{{item.system.craftsmanshipLabel}} Craftsmanship</h3>
          </div>
          <div class="rt-weapon-section__body">
            <div class="rt-craftsmanship-effects">
              {{#if item.system.craftsmanshipModifiers.toHit}}
              <div class="rt-craftsmanship-effect">
                <span class="rt-craftsmanship-effect__label">To Hit</span>
                <span class="rt-craftsmanship-effect__value {{#if (gt item.system.craftsmanshipModifiers.toHit 0)}}rt-craftsmanship-effect__value--positive{{else}}rt-craftsmanship-effect__value--negative{{/if}}">
                  {{#if (gt item.system.craftsmanshipModifiers.toHit 0)}}+{{/if}}{{item.system.craftsmanshipModifiers.toHit}}
                </span>
              </div>
              {{/if}}
              {{#if item.system.craftsmanshipModifiers.damage}}
              <div class="rt-craftsmanship-effect">
                <span class="rt-craftsmanship-effect__label">Damage</span>
                <span class="rt-craftsmanship-effect__value rt-craftsmanship-effect__value--positive">
                  +{{item.system.craftsmanshipModifiers.damage}}
                </span>
              </div>
              {{/if}}
              {{#if item.system.hasCraftsmanshipQualities}}
              <div class="rt-craftsmanship-effect rt-craftsmanship-effect--quality">
                <span class="rt-craftsmanship-effect__label">Special</span>
                <span class="rt-craftsmanship-effect__value">
                  {{#if (eq item.system.craftsmanship "poor")}}Unreliable (91+){{/if}}
                  {{#if (eq item.system.craftsmanship "cheap")}}Unreliable (96+){{/if}}
                  {{#if (eq item.system.craftsmanship "good")}}Reliable{{/if}}
                  {{#if (or (eq item.system.craftsmanship "best") (eq item.system.craftsmanship "master-crafted"))}}Never Jams{{/if}}
                </span>
              </div>
              {{/if}}
            </div>
          </div>
        </div>
        {{/if}}
        
        {{!-- Active Qualities --}}
        <div class="rt-weapon-section">
          <div class="rt-weapon-section__header">
            <i class="fas fa-star"></i>
            <h3>Active Qualities</h3>
            <span class="rt-weapon-section__count">{{item.system.effectiveSpecial.size}}</span>
          </div>
          <div class="rt-weapon-section__body">
            {{#if item.system.effectiveSpecial.size}}
            <div class="rt-qualities-grid">
              {{#each item.system.qualitiesArray as |quality|}}
              <div class="rt-quality-card">
                <div class="rt-quality-card__header">
                  <span class="rt-quality-card__name">{{quality.label}}</span>
                  {{#if quality.level}}
                  <span class="rt-quality-card__level">({{quality.level}})</span>
                  {{/if}}
                </div>
                {{#if quality.description}}
                <div class="rt-quality-card__description">{{quality.description}}</div>
                {{/if}}
              </div>
              {{/each}}
            </div>
            {{else}}
            <p class="rt-empty-message">No special qualities</p>
            {{/if}}
          </div>
        </div>
        
        {{!-- Weapon Modifications --}}
        <div class="rt-weapon-section">
          <div class="rt-weapon-section__header">
            <i class="fas fa-wrench"></i>
            <h3>Modifications</h3>
            <button type="button" class="rt-btn rt-btn--small rt-btn--ghost" data-action="addModification">
              <i class="fas fa-plus"></i>
            </button>
          </div>
          <div class="rt-weapon-section__body">
            {{#if item.items.length}}
            <div class="rt-mods-list">
              {{#each item.items as |embedded|}}
              {{#if embedded.isWeaponModification}}
              <div class="rt-mod-item">
                <span class="rt-mod-item__name">{{embedded.name}}</span>
                <div class="rt-mod-item__actions">
                  <button type="button" class="rt-btn rt-btn--icon" data-action="itemEdit" data-item-id="{{embedded.id}}">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button type="button" class="rt-btn rt-btn--icon rt-btn--danger" data-action="itemDelete" data-item-id="{{embedded.id}}">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
              {{/if}}
              {{/each}}
            </div>
            {{else}}
            <p class="rt-empty-message">Drag modifications here to add them</p>
            {{/if}}
          </div>
        </div>
      </div>
      
      {{!-- ─────────────────────────────────────────────────────────────────
           DESCRIPTION TAB: Flavor text and notes
      ───────────────────────────────────────────────────────────────── --}}
      <div class="rt-weapon-panel" data-tab="description" data-group="primary">
        <div class="rt-weapon-section rt-weapon-section--full">
          <div class="rt-weapon-section__header">
            <i class="fas fa-scroll"></i>
            <h3>Description</h3>
          </div>
          <div class="rt-weapon-section__body">
            <div class="rt-prose-editor">
              {{editor content=item.system.description.value target="system.description.value" button=true editable=true engine="prosemirror"}}
            </div>
          </div>
        </div>
        
        <div class="rt-weapon-section">
          <div class="rt-weapon-section__header">
            <i class="fas fa-sticky-note"></i>
            <h3>Notes</h3>
          </div>
          <div class="rt-weapon-section__body">
            <textarea name="system.notes" rows="3" placeholder="Personal notes...">{{item.system.notes}}</textarea>
          </div>
        </div>
      </div>
      
      {{!-- ─────────────────────────────────────────────────────────────────
           EFFECTS TAB: Active Effects
      ───────────────────────────────────────────────────────────────── --}}
      <div class="rt-weapon-panel" data-tab="effects" data-group="primary">
        {{> systems/rogue-trader/templates/item/panel/active-effects-panel.hbs}}
      </div>
      
    </section>
  </form>
</div>
