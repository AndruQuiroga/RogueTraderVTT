{{!-- Origin Path Builder Template - Refactored Design --}}
<div class="origin-builder">

    {{!-- Unified Header: Toolbar + Mode + Direction --}}
    <header class="builder-toolbar">
        <div class="toolbar-group">
            <button type="button" class="toolbar-btn" data-action="randomize" data-tooltip="{{localize 'RT.OriginPath.RandomizeHint'}}">
                <i class="fa-solid fa-dice"></i>
                <span>{{localize "RT.OriginPath.Randomize"}}</span>
            </button>
            <button type="button" class="toolbar-btn" data-action="reset" data-tooltip="{{localize 'RT.OriginPath.ResetHint'}}">
                <i class="fa-solid fa-rotate-left"></i>
                <span>{{localize "RT.OriginPath.Reset"}}</span>
            </button>
        </div>

        <div class="toolbar-center">
            <h1 class="toolbar-title">{{localize "RT.OriginPath.YourJourney"}}</h1>
            
            {{!-- Mode and Direction Controls (inline with title) --}}
            <div class="toolbar-controls">
                {{!-- Guided/Free Mode Toggle --}}
                <div class="mode-toggle">
                    <label class="mode-option {{#if guidedMode}}active{{/if}}" data-tooltip="{{localize 'RT.OriginPath.GuidedHint'}}">
                        <input type="radio" name="mode" value="guided" {{#if guidedMode}}checked{{/if}} data-action="setMode">
                        <i class="fa-solid fa-route"></i>
                        <span>{{localize "RT.OriginPath.Guided"}}</span>
                    </label>
                    <label class="mode-option {{#unless guidedMode}}active{{/unless}}" data-tooltip="{{localize 'RT.OriginPath.FreeHint'}}">
                        <input type="radio" name="mode" value="free" {{#unless guidedMode}}checked{{/unless}} data-action="setMode">
                        <i class="fa-solid fa-unlock"></i>
                        <span>{{localize "RT.OriginPath.Free"}}</span>
                    </label>
                </div>

                {{!-- Direction Toggle --}}
                <div class="direction-toggle">
                    <label class="direction-option {{#if isBackward}}active{{/if}}" data-tooltip="{{localize 'RT.OriginPath.DirectionBackwardHint'}}">
                        <input type="radio" name="direction" value="backward" {{#if isBackward}}checked{{/if}} data-action="setDirection">
                        <i class="fa-solid fa-arrow-left"></i>
                        <span>{{localize "RT.OriginPath.DirectionBackward"}}</span>
                    </label>
                    <label class="direction-option {{#if isForward}}active{{/if}}" data-tooltip="{{localize 'RT.OriginPath.DirectionForwardHint'}}">
                        <input type="radio" name="direction" value="forward" {{#if isForward}}checked{{/if}} data-action="setDirection">
                        <i class="fa-solid fa-arrow-right"></i>
                        <span>{{localize "RT.OriginPath.DirectionForward"}}</span>
                    </label>
                </div>
            </div>
        </div>

        <div class="toolbar-group">
            <button type="button" class="toolbar-btn" data-action="export" data-tooltip="{{localize 'RT.OriginPath.ExportHint'}}">
                <i class="fa-solid fa-download"></i>
            </button>
            <button type="button" class="toolbar-btn" data-action="import" data-tooltip="{{localize 'RT.OriginPath.ImportHint'}}">
                <i class="fa-solid fa-upload"></i>
            </button>
        </div>
    </header>

    {{!-- Step Navigation with Visual Progress --}}
    <nav class="step-navigation">
        {{#each steps as |step|}}
            <div class="step-nav-item {{#if step.isActive}}active{{/if}} {{#if step.isComplete}}complete{{/if}} {{#if step.isDisabled}}disabled{{/if}}" 
                 data-action="goToStep" 
                 data-step-index="{{step.index}}"
                 data-tooltip="{{step.label}}{{#if step.selection}}: {{step.selection.name}}{{/if}}">
                <div class="step-number">
                    {{#if step.selection}}
                        <img src="{{step.selection.img}}" alt="{{step.selection.name}}" class="step-icon-img" />
                    {{else}}
                        {{add step.index 1}}
                    {{/if}}
                </div>
                <span class="step-label">{{step.shortLabel}}</span>
            </div>
            {{#unless @last}}
                <div class="step-connector {{#if step.isComplete}}active{{/if}}"></div>
            {{/unless}}
        {{/each}}
        {{!-- Lineage Step (shown after all 6 steps are complete) --}}
        {{#if status.stepsComplete}}
            <div class="step-connector {{#if hasLineageSelection}}active{{/if}}"></div>
            <div class="step-nav-item lineage-step {{#if showLineage}}active{{/if}} {{#if hasLineageSelection}}complete{{/if}}" 
                 data-action="goToLineage"
                 data-tooltip="{{localize 'RT.OriginPath.Lineage'}}{{#if hasLineageSelection}}: {{lineageSelection.name}}{{/if}}">
                <div class="step-number">
                    {{#if hasLineageSelection}}
                        <img src="{{lineageSelection.img}}" alt="{{lineageSelection.name}}" class="step-icon-img" />
                    {{else}}
                        <i class="fa-solid fa-crown"></i>
                    {{/if}}
                </div>
                <span class="step-label">{{localize "RT.OriginPath.Lineage"}}</span>
            </div>
        {{/if}}
    </nav>

    {{!-- Main Content --}}
    <main class="builder-main">
        {{!-- Step Content (Left) --}}
        <section class="step-content">
            <div class="step-header">
                <div class="step-icon">
                    <i class="fa-solid {{currentStep.icon}}"></i>
                </div>
                <div class="step-info">
                    {{#if currentStep.isLineage}}
                        <h2>{{localize "RT.OriginPath.Lineage"}} <span class="optional-badge">{{localize "RT.OriginPath.Optional"}}</span></h2>
                        <p>{{localize "RT.OriginPath.LineageDesc"}}</p>
                    {{else}}
                        <h2>{{localize "RT.OriginPath.Step"}} {{add currentStep.index 1}}: {{currentStep.label}}</h2>
                        <p>{{currentStep.description}}</p>
                    {{/if}}
                </div>
            </div>

            {{!-- Origin Cards --}}
            <div class="origin-cards-grid">
                {{#each currentStep.origins as |origin|}}
                    <div class="origin-card {{#if origin.isSelected}}selected{{/if}} {{#if origin.isDisabled}}disabled{{/if}} {{#if origin.isValidNext}}valid-next{{/if}}"
                         data-action="selectOriginCard"
                         data-origin-id="{{origin.id}}"
                         data-origin-uuid="{{origin.uuid}}"
                         data-tooltip="{{origin.name}}: {{origin.shortDescription}}">
                        {{#if origin.isSelected}}
                            <div class="selection-indicator">
                                <i class="fa-solid fa-check-circle"></i>
                            </div>
                        {{/if}}
                        <img src="{{origin.img}}" alt="{{origin.name}}" class="card-img" />
                        <h4 class="card-name">{{origin.name}}</h4>
                        {{#if origin.badges}}
                            <div class="card-badges">
                                {{#if origin.hasChoices}}
                                    <span class="card-badge choices">{{localize "RT.OriginPath.HasChoices"}}</span>
                                {{/if}}
                                {{#if origin.isAdvanced}}
                                    <span class="card-badge advanced">{{localize "RT.OriginPath.Advanced"}}</span>
                                {{/if}}
                                {{#if origin.xpCost}}
                                    <span class="card-badge xp">{{origin.xpCost}} XP</span>
                                {{/if}}
                            </div>
                        {{/if}}
                        {{!-- Preview button for detailed view --}}
                        <button type="button" class="card-preview-btn" data-action="viewOriginCard" data-origin-id="{{origin.id}}" data-origin-uuid="{{origin.uuid}}" data-tooltip="{{localize 'RT.OriginPath.ViewDetails'}}">
                            <i class="fa-solid fa-eye"></i>
                        </button>
                    </div>
                {{else}}
                    <p class="no-origins">{{localize "RT.OriginPath.NoOriginsAvailable"}}</p>
                {{/each}}
            </div>
        </section>

        {{!-- Selection Detail Panel (Right) --}}
        <aside class="selection-panel">
            {{#if selectedOrigin}}
                {{!-- Header --}}
                <div class="selection-header">
                    <img src="{{selectedOrigin.img}}" alt="{{selectedOrigin.name}}" class="selection-img" />
                    <div class="selection-info">
                        <h3>{{selectedOrigin.name}}</h3>
                    </div>
                    <div class="selection-actions">
                        <button type="button" class="toolbar-btn" data-action="viewOrigin" data-tooltip="{{localize 'RT.OriginPath.ViewDetails'}}">
                            <i class="fa-solid fa-eye"></i>
                        </button>
                        {{#unless selectedOrigin.isConfirmed}}
                            <button type="button" class="toolbar-btn toolbar-btn--confirm" data-action="confirmSelection" data-tooltip="{{localize 'RT.OriginPath.ConfirmSelection'}}">
                                <i class="fa-solid fa-check"></i>
                            </button>
                        {{/unless}}
                    </div>
                </div>

                {{!-- Grants Section --}}
                {{#if selectedOrigin.grants}}
                    <div class="selection-section">
                        <h4 class="section-title">
                            <i class="fa-solid fa-gift"></i>
                            {{localize "RT.OriginPath.Grants"}}
                        </h4>
                        <div class="grants-list">
                            {{!-- Characteristics --}}
                            {{#if selectedOrigin.grants.hasCharacteristics}}
                                <div class="grants-category">
                                    <span class="category-label">{{localize "RT.Characteristics"}}</span>
                                    <div class="category-items">
                                        {{#each selectedOrigin.grants.characteristics as |char|}}
                                            <span class="grant-item characteristic {{#if char.positive}}positive{{else}}negative{{/if}}">
                                                {{char.short}}: {{#if char.positive}}+{{/if}}{{char.value}}
                                            </span>
                                        {{/each}}
                                    </div>
                                </div>
                            {{/if}}
                            
                            {{!-- Skills (clickable) --}}
                            {{#if selectedOrigin.grants.hasSkills}}
                                <div class="grants-category">
                                    <span class="category-label">{{localize "RT.Skills"}}</span>
                                    <div class="category-items">
                                        {{#each selectedOrigin.grants.skills as |skill|}}
                                            <div class="grant-tag skill-tag clickable" 
                                                  {{#if skill.uuid}}data-action="openItem" data-uuid="{{skill.uuid}}"{{/if}}
                                                  data-tooltip="{{skill.displayName}} ({{skill.levelLabel}})">
                                                <i class="fa-solid fa-book-open"></i>
                                                <span class="tag-label">{{skill.displayName}}</span>
                                                <span class="tag-level">{{skill.levelLabel}}</span>
                                                {{#if skill.uuid}}<i class="fa-solid fa-external-link tag-link"></i>{{/if}}
                                            </div>
                                        {{/each}}
                                    </div>
                                </div>
                            {{/if}}
                            
                            {{!-- Talents (clickable if they have uuid) --}}
                            {{#if selectedOrigin.grants.hasTalents}}
                                <div class="grants-category">
                                    <span class="category-label">{{localize "RT.Talents"}}</span>
                                    <div class="category-items">
                                        {{#each selectedOrigin.grants.talents as |talent|}}
                                            <div class="grant-tag talent-tag {{#if talent.hasItem}}clickable{{/if}}" 
                                                  {{#if talent.uuid}}data-action="openItem" data-uuid="{{talent.uuid}}"{{/if}}
                                                  data-tooltip="{{talent.tooltip}}">
                                                <i class="fa-solid fa-star"></i>
                                                <span class="tag-label">{{talent.name}}</span>
                                                {{#if talent.hasItem}}<i class="fa-solid fa-external-link tag-link"></i>{{/if}}
                                            </div>
                                        {{/each}}
                                    </div>
                                </div>
                            {{/if}}
                            
                            {{!-- Traits (clickable if they have uuid) --}}
                            {{#if selectedOrigin.grants.hasTraits}}
                                <div class="grants-category">
                                    <span class="category-label">{{localize "RT.Traits"}}</span>
                                    <div class="category-items">
                                        {{#each selectedOrigin.grants.traits as |trait|}}
                                            <div class="grant-tag trait-tag {{#if trait.hasItem}}clickable{{/if}}"
                                                  {{#if trait.uuid}}data-action="openItem" data-uuid="{{trait.uuid}}"{{/if}}
                                                  data-tooltip="{{trait.tooltip}}">
                                                <i class="fa-solid fa-dna"></i>
                                                <span class="tag-label">{{trait.name}}{{#if trait.level}} ({{trait.level}}){{/if}}</span>
                                                {{#if trait.hasItem}}<i class="fa-solid fa-external-link tag-link"></i>{{/if}}
                                            </div>
                                        {{/each}}
                                    </div>
                                </div>
                            {{/if}}
                            
                            {{!-- Equipment --}}
                            {{#if selectedOrigin.grants.hasEquipment}}
                                <div class="grants-category">
                                    <span class="category-label">{{localize "RT.Equipment"}}</span>
                                    <div class="category-items">
                                        {{#each selectedOrigin.grants.equipment as |item|}}
                                            <div class="grant-tag equipment-tag">
                                                <i class="fa-solid fa-box"></i>
                                                <span class="tag-label">{{item}}</span>
                                            </div>
                                        {{/each}}
                                    </div>
                                </div>
                            {{/if}}
                        </div>
                    </div>
                {{/if}}

                {{!-- Choices Section --}}
                {{#if selectedOrigin.hasChoices}}
                    <div class="selection-section choices-section">
                        <h4 class="section-title">
                            <i class="fa-solid fa-list-check"></i>
                            {{localize "RT.OriginPath.ChoicesRequired"}}
                        </h4>
                        {{#each selectedOrigin.choices as |choice|}}
                            <div class="choice-item {{#if choice.isComplete}}complete{{/if}}">
                                <div class="choice-header">
                                    {{#if choice.isComplete}}
                                        <i class="fa-solid fa-check-circle choice-complete-icon"></i>
                                    {{else}}
                                        <i class="fa-regular fa-circle choice-incomplete-icon"></i>
                                    {{/if}}
                                    <span class="choice-type-badge">{{choice.typeLabel}}</span>
                                    <span class="choice-label">{{choice.label}}</span>
                                    <span class="choice-count">{{choice.count}}x</span>
                                </div>
                                {{#if choice.selection}}
                                    <div class="choice-selection">
                                        <i class="fa-solid fa-check"></i> {{choice.selection}}
                                    </div>
                                {{/if}}
                                <button type="button" class="choice-btn" data-action="editChoice" data-choice-label="{{choice.label}}">
                                    <i class="fa-solid fa-pen"></i>
                                    {{#if choice.isComplete}}{{localize "RT.OriginPath.ChangeChoice"}}{{else}}{{localize "RT.OriginPath.MakeChoice"}}{{/if}}
                                </button>
                            </div>
                        {{/each}}
                    </div>
                {{/if}}

                {{!-- Roll Section --}}
                {{#if selectedOrigin.hasRolls}}
                    <div class="selection-section rolls-section">
                        <h4 class="section-title">
                            <i class="fa-solid fa-dice"></i>
                            {{localize "RT.OriginPath.StartingStats"}}
                        </h4>
                        {{#if selectedOrigin.rolls.wounds}}
                            <div class="roll-item {{#if selectedOrigin.rolls.wounds.hasValue}}has-value{{/if}}">
                                <div class="roll-info">
                                    <div class="roll-label">
                                        <i class="fa-solid fa-heart"></i> {{localize "RT.Wounds"}}
                                    </div>
                                    {{#if selectedOrigin.rolls.wounds.hasValue}}
                                        <div class="roll-result">{{selectedOrigin.rolls.wounds.value}} <span class="roll-breakdown">({{selectedOrigin.rolls.wounds.breakdown}})</span></div>
                                    {{else}}
                                        <div class="roll-formula">{{selectedOrigin.rolls.wounds.formula}}</div>
                                    {{/if}}
                                </div>
                                <div class="roll-actions">
                                    <button type="button" class="roll-btn" data-action="rollStat" data-stat-type="wounds" data-tooltip="{{localize 'RT.OriginPath.RollTooltip'}}">
                                        <i class="fa-solid fa-dice"></i>
                                        {{#if selectedOrigin.rolls.wounds.hasValue}}{{localize "RT.OriginPath.Reroll"}}{{else}}{{localize "RT.Roll"}}{{/if}}
                                    </button>
                                </div>
                            </div>
                        {{/if}}
                        {{#if selectedOrigin.rolls.fate}}
                            <div class="roll-item {{#if selectedOrigin.rolls.fate.hasValue}}has-value{{/if}}">
                                <div class="roll-info">
                                    <div class="roll-label">
                                        <i class="fa-solid fa-star"></i> {{localize "RT.Fate"}}
                                    </div>
                                    {{#if selectedOrigin.rolls.fate.hasValue}}
                                        <div class="roll-result">{{selectedOrigin.rolls.fate.value}} <span class="roll-breakdown">({{selectedOrigin.rolls.fate.breakdown}})</span></div>
                                    {{else}}
                                        <div class="roll-formula">{{selectedOrigin.rolls.fate.formula}}</div>
                                    {{/if}}
                                </div>
                                <div class="roll-actions">
                                    <button type="button" class="roll-btn" data-action="rollStat" data-stat-type="fate" data-tooltip="{{localize 'RT.OriginPath.RollTooltip'}}">
                                        <i class="fa-solid fa-dice"></i>
                                        {{#if selectedOrigin.rolls.fate.hasValue}}{{localize "RT.OriginPath.Reroll"}}{{else}}{{localize "RT.Roll"}}{{/if}}
                                    </button>
                                </div>
                            </div>
                        {{/if}}
                    </div>
                {{/if}}

                {{!-- Confirm Selection Button --}}
                <div class="selection-confirm">
                    <button type="button" class="confirm-selection-btn" data-action="confirmSelection" data-tooltip="{{localize 'RT.OriginPath.ConfirmSelectionHint'}}">
                        <i class="fa-solid fa-check"></i>
                        <span>{{localize "RT.OriginPath.ConfirmSelection"}}</span>
                    </button>
                </div>
            {{else}}
                {{!-- Empty State --}}
                <div class="selection-empty">
                    <i class="fa-solid fa-hand-pointer"></i>
                    <p>{{localize "RT.OriginPath.SelectOriginPrompt"}}</p>
                </div>
            {{/if}}
        </aside>
    </main>

    {{!-- Preview Panel --}}
    <section class="preview-panel">
        <div class="preview-header">
            <h3>
                <i class="fa-solid fa-eye"></i>
                {{localize "RT.OriginPath.TotalBonuses"}}
            </h3>
        </div>
        <div class="preview-grid">
            {{#if preview.characteristics.length}}
                <div class="preview-category">
                    <div class="category-title">{{localize "RT.Characteristics"}}</div>
                    <div class="category-items">
                        {{#each preview.characteristics as |char|}}
                            <span class="preview-item {{#if (gt char.value 0)}}positive{{else}}negative{{/if}} {{#if char.fromChoice}}from-choice{{/if}}">
                                {{char.short}}: {{#if (gt char.value 0)}}+{{/if}}{{char.value}}
                            </span>
                        {{/each}}
                    </div>
                </div>
            {{/if}}
            {{#if preview.skills.length}}
                <div class="preview-category">
                    <div class="category-title">{{localize "RT.Skills"}}</div>
                    <div class="category-items">
                        {{#each preview.skills as |skill|}}
                            <div class="grant-tag skill-tag {{#if skill.uuid}}clickable{{/if}} {{#if skill.fromChoice}}from-choice{{/if}}"
                                  {{#if skill.uuid}}data-action="openItem" data-uuid="{{skill.uuid}}"{{/if}}
                                  data-tooltip="{{skill.name}}">
                                <i class="fa-solid fa-book-open"></i>
                                <span class="tag-label">{{skill.name}}</span>
                                {{#if skill.uuid}}<i class="fa-solid fa-external-link tag-link"></i>{{/if}}
                            </div>
                        {{/each}}
                    </div>
                </div>
            {{/if}}
            {{#if preview.talents.length}}
                <div class="preview-category">
                    <div class="category-title">{{localize "RT.Talents"}}</div>
                    <div class="category-items">
                        {{#each preview.talents as |talent|}}
                            <div class="grant-tag talent-tag {{#if talent.uuid}}clickable{{/if}} {{#if talent.fromChoice}}from-choice{{/if}}"
                                  {{#if talent.uuid}}data-action="openItem" data-uuid="{{talent.uuid}}"{{/if}}
                                  data-tooltip="{{talent.name}}">
                                <i class="fa-solid fa-star"></i>
                                <span class="tag-label">{{talent.name}}</span>
                                {{#if talent.uuid}}<i class="fa-solid fa-external-link tag-link"></i>{{/if}}
                            </div>
                        {{/each}}
                    </div>
                </div>
            {{/if}}
            {{#if preview.wounds}}
                <div class="preview-category">
                    <div class="category-title">{{localize "RT.Wounds"}}</div>
                    <div class="category-items">
                        <div class="grant-tag positive">
                            <i class="fa-solid fa-heart"></i>
                            <span class="tag-label">{{preview.wounds}}</span>
                        </div>
                    </div>
                </div>
            {{/if}}
            {{#if preview.fate}}
                <div class="preview-category">
                    <div class="category-title">{{localize "RT.Fate"}}</div>
                    <div class="category-items">
                        <div class="grant-tag positive">
                            <i class="fa-solid fa-star"></i>
                            <span class="tag-label">{{preview.fate}}</span>
                        </div>
                    </div>
                </div>
            {{/if}}
        </div>
    </section>

    {{!-- Footer --}}
    <footer class="builder-footer">
        <div class="footer-status">
            <span class="status-item {{#if status.stepsComplete}}complete{{else}}pending{{/if}}">
                <i class="fa-solid {{#if status.stepsComplete}}fa-check-circle{{else}}fa-circle-half-stroke{{/if}}"></i>
                {{status.stepsCount}}/6 {{localize "RT.OriginPath.Steps"}}
            </span>
            <span class="status-item {{#if status.choicesComplete}}complete{{else}}pending{{/if}}">
                <i class="fa-solid {{#if status.choicesComplete}}fa-check-circle{{else}}fa-exclamation-triangle{{/if}}"></i>
                {{#if status.choicesComplete}}
                    {{localize "RT.OriginPath.AllChoicesComplete"}}
                {{else}}
                    {{status.pendingChoices}} {{localize "RT.OriginPath.ChoicesPending"}}
                {{/if}}
            </span>
            {{#if status.pendingRolls}}
                <span class="status-item warning">
                    <i class="fa-solid fa-dice"></i>
                    {{status.pendingRolls}} {{localize "RT.OriginPath.RollsPending"}}
                </span>
            {{/if}}
        </div>
        <div class="footer-actions">
            {{!-- Lineage controls when on lineage step --}}
            {{#if showLineage}}
                <button type="button" class="skip-lineage-btn" data-action="skipLineage">
                    <i class="fa-solid fa-forward"></i>
                    {{localize "RT.OriginPath.SkipLineage"}}
                </button>
            {{/if}}
            {{!-- Go to Lineage button when all 6 steps are complete but not on lineage step --}}
            {{#if status.stepsComplete}}
                {{#unless showLineage}}
                    <button type="button" class="lineage-btn" data-action="goToLineage">
                        <i class="fa-solid fa-crown"></i>
                        {{localize "RT.OriginPath.GoToLineage"}}
                    </button>
                {{/unless}}
            {{/if}}
            <button type="button" class="commit-btn" data-action="commit" {{#unless status.canCommit}}disabled{{/unless}}>
                <i class="fa-solid fa-save"></i>
                {{localize "RT.OriginPath.CommitToCharacter"}}
            </button>
        </div>
    </footer>

</div>
