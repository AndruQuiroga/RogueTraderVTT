{{!-- Rogue Trader Action Roll Card - Modern Design --}}
<div class="rt-chat">
    <div class="rt-roll-card">
        {{!-- Header --}}
        <div class="rt-roll-card__header">
            {{#if label}}<div class="rt-roll-card__actor">{{label}}</div>{{/if}}
            {{#with rollData}}
                <h2 class="rt-roll-card__title">{{name}}</h2>
                {{#if action}}<div class="rt-roll-card__subtitle">{{action}}</div>{{/if}}
                {{#if effectString}}<div class="rt-roll-card__subtitle">{{effectString}}</div>{{/if}}
                {{#if isManualRoll}}
                    <div class="rt-roll-card__manual-badge"><i class="fas fa-hand-paper"></i> Player Rolled</div>
                {{/if}}
            {{/with}}
        </div>
        
        {{!-- Body --}}
        <div class="rt-roll-card__body">
            {{#with rollData}}
                {{!-- Weapon Qualities --}}
                {{#if weapon}}
                    {{#if weapon.system.effectiveSpecial.size}}
                        <div class="rt-roll-card__qualities">
                            <div class="rt-roll-card__qualities-header">
                                <i class="fas fa-star" style="color: #4bc073; font-size: 0.85rem;"></i>
                                <span class="rt-roll-card__qualities-title">Active Qualities</span>
                            </div>
                            <div class="rt-roll-card__qualities-list">
                                {{#each (specialQualities weapon.system.effectiveSpecial) as |quality|}}
                                    <span class="rt-quality-tag" data-tooltip="{{quality.description}}" title="{{quality.description}}">
                                        {{quality.label}}{{#if quality.level}} ({{quality.level}}){{/if}}
                                    </span>
                                {{/each}}
                            </div>
                        </div>
                    {{/if}}
                {{/if}}
                
                {{#unless ignoreModifiers}}
                    {{!-- Modifiers Breakdown --}}
                    <div class="rt-roll-card__row">
                        <span class="rt-roll-card__label">Base</span>
                        <span class="rt-roll-card__value">{{baseTarget}}</span>
                    </div>
                    
                    {{#each activeModifiers}}
                        <div class="rt-roll-card__row rt-roll-card__row--modifier">
                            <span class="rt-roll-card__label">{{@key}}</span>
                            <span class="rt-roll-card__value {{#if (gt this 0)}}rt-roll-card__value--positive{{else if (lt this 0)}}rt-roll-card__value--negative{{/if}}">
                                {{#if (gt this 0)}}+{{/if}}{{this}}
                            </span>
                        </div>
                    {{/each}}
                    
                    {{!-- Target Number --}}
                    <div class="rt-roll-card__target">
                        <span class="rt-roll-card__label">Target</span>
                        <span class="rt-roll-card__value">{{modifiedTarget}}</span>
                    </div>
                {{/unless}}
                
                {{#if usesAmmo}}
                    <div class="rt-roll-card__row">
                        <span class="rt-roll-card__label">Ammo Used</span>
                        <span class="rt-roll-card__value">{{ammoUsed}}</span>
                    </div>
                {{/if}}
                
                {{!-- Effects --}}
                {{#each @root.effectOutput as |effect|}}
                    <div class="rt-roll-card__effect">
                        <span class="rt-roll-card__effect-name">{{effect.name}}</span>
                        <span class="rt-roll-card__effect-desc">{{effect.effect}}</span>
                    </div>
                {{/each}}
                
                {{!-- Opposed Roll --}}
                {{#if isOpposed}}
                    <div class="rt-roll-card__row">
                        <span class="rt-roll-card__label">Opposed {{opposedChar}}</span>
                        <span class="rt-roll-card__value">{{opposedRoll.total}} vs {{opposedTarget}} {{#if opposedSuccess}}({{opposedDos}} DoS){{/if}}</span>
                    </div>
                {{/if}}
                
                {{!-- Degrees --}}
                {{#unless ignoreDegrees}}
                  {{#unless isTargetOnly}}
                    {{#if success}}
                        <div class="rt-roll-card__degrees rt-roll-card__degrees--success">
                            <span class="rt-roll-card__degrees-count">{{dos}}</span>
                            <span class="rt-roll-card__degrees-label">Degrees of Success</span>
                        </div>
                    {{else}}
                        <div class="rt-roll-card__degrees rt-roll-card__degrees--failure">
                            <span class="rt-roll-card__degrees-count">{{dof}}</span>
                            <span class="rt-roll-card__degrees-label">Degrees of Failure</span>
                        </div>
                    {{/if}}
                  {{/unless}}
                {{/unless}}
                
                {{!-- Target-only display (no roll entered) --}}
                {{#if isTargetOnly}}
                    <div class="rt-roll-card__target-only">
                        Target posted - awaiting physical dice roll
                    </div>
                {{/if}}

                {{!-- Result Display --}}
                {{#unless ignoreSuccess}}
                  {{#unless isTargetOnly}}
                    {{#if success}}
                        <div class="rt-roll-card__result rt-roll-card__result--success">
                            <div class="rt-roll-card__result-label">Success</div>
                            <div class="rt-roll-card__result-roll">{{roll.total}}</div>
                        </div>
                        {{#if hitLocation}}
                            <div class="rt-roll-card__hit-loc">
                                <i class="fas fa-crosshairs"></i>
                                <span>{{hitLocation}}</span>
                            </div>
                        {{/if}}
                    {{else}}
                        <div class="rt-roll-card__result rt-roll-card__result--failure">
                            <div class="rt-roll-card__result-label">Failure</div>
                            <div class="rt-roll-card__result-roll">{{roll.total}}</div>
                        </div>
                    {{/if}}
                  {{/unless}}
                {{/unless}}
                
                {{!-- Action Controls --}}
                {{#unless ignoreControls}}
                    <div class="rt-roll-card__controls rt-roll-card__controls--stacked">
                        {{#if showDamage}}
                            <button class="rt-roll-card__btn rt-roll-card__btn--damage rt-roll-card__btn--full roll-control__hide-control" data-toggle="{{@root.id}}">
                                <span class="material-icons">bolt</span>
                                <span>Damage</span>
                            </button>
                        {{else}}
                            <button class="rt-roll-card__btn rt-roll-card__btn--disabled rt-roll-card__btn--full">
                                <span class="material-icons">bolt</span>
                                <span>Damage</span>
                            </button>
                        {{/if}}
                        <div class="rt-roll-card__controls-row">
                            <button class="rt-roll-card__btn rt-roll-card__btn--sm roll-control__refund" data-roll-id="{{@root.id}}">
                                <span class="material-icons">deblur</span>
                                <span>Refund</span>
                            </button>
                            <button class="rt-roll-card__btn rt-roll-card__btn--sm rt-roll-card__btn--fate roll-control__fate-reroll" data-roll-id="{{@root.id}}">
                                <span class="material-icons">casino</span>
                                <span>Re-roll</span>
                            </button>
                        </div>
                    </div>
                {{/unless}}
            {{/with}}
            
            {{!-- Collapsible Damage Section --}}
            {{#unless rollData.ignoreDamage}}
                {{#with damageData}}
                    <div id="{{@root.id}}" class="rt-roll-card__collapse" style="display: none">>
                        {{#if @root.psychicEffect}}
                            <div class="rt-roll-card__divider rt-roll-card__divider--ornate"></div>
                            <div class="rt-roll-card__text">{{{@root.psychicEffect}}}</div>
                        {{/if}}
                        
                        {{#each hits as |hit|}}
                            <div class="rt-roll-card__hit">
                                <div class="rt-roll-card__hit-header">
                                    <span class="rt-roll-card__hit-number">{{inc @index}}</span>
                                    <span class="rt-roll-card__hit-location">{{hit.location}}</span>
                                </div>
                                
                                <div class="rt-roll-card__row">
                                    <span class="rt-roll-card__label">Formula</span>
                                    <span class="rt-roll-card__value">{{hit.damageRoll.formula}}</span>
                                </div>
                                <div class="rt-roll-card__row">
                                    <span class="rt-roll-card__label">Base Damage</span>
                                    <span class="rt-roll-card__value">{{hit.damageRoll.result}}</span>
                                </div>
                                {{#each modifiers}}
                                    <div class="rt-roll-card__row rt-roll-card__row--modifier">
                                        <span class="rt-roll-card__label">{{@key}}</span>
                                        <span class="rt-roll-card__value">{{this}}</span>
                                    </div>
                                {{/each}}
                                
                                {{!-- Damage Display --}}
                                <div class="rt-roll-card__damage">
                                    <div class="rt-roll-card__damage-header">
                                        <span class="rt-roll-card__damage-title">Damage</span>
                                        <span class="rt-roll-card__damage-location">{{hit.location}}</span>
                                    </div>
                                    <div class="rt-roll-card__damage-value">{{hit.totalDamage}}</div>
                                    <div class="rt-roll-card__damage-type">{{hit.damageType}}</div>
                                </div>
                                
                                {{!-- Penetration --}}
                                <div class="rt-roll-card__notice">
                                    <span class="rt-roll-card__notice-label">Penetration</span>
                                    <span class="rt-roll-card__notice-value">{{hit.totalPenetration}}</span>
                                </div>
                                
                                {{!-- Effects --}}
                                {{#each hit.effects as |effect|}}
                                    <div class="rt-roll-card__effect">
                                        <span class="rt-roll-card__effect-name">{{effect.name}}</span>
                                        <span class="rt-roll-card__effect-desc">{{effect.effect}}</span>
                                    </div>
                                {{/each}}
                                
                                {{!-- Righteous Fury --}}
                                {{#each hit.righteousFury as |fury|}}
                                    {{#if fury.confirmed}}
                                        <div class="rt-roll-card__fury rt-roll-card__fury--confirmed">
                                            <div class="rt-roll-card__fury-title">⚡ Righteous Fury Confirmed! ⚡</div>
                                            <div class="rt-roll-card__fury-bonus">
                                                <span class="rt-roll-card__fury-label">Bonus Damage:</span>
                                                <span class="rt-roll-card__fury-value">+{{fury.bonusDamage}}</span>
                                            </div>
                                            <div class="rt-roll-card__fury-effect">Critical Level {{fury.critRoll.total}}: {{fury.effect}}</div>
                                        </div>
                                    {{else}}
                                        <div class="rt-roll-card__fury rt-roll-card__fury--not-confirmed">
                                            <div class="rt-roll-card__fury-title">⚡ Righteous Fury (Not Confirmed)</div>
                                            <div class="rt-roll-card__fury-text">
                                                Rolled {{fury.dieResult}} (threshold: {{fury.threshold}}), but failed confirmation roll.
                                            </div>
                                        </div>
                                    {{/if}}
                                {{/each}}
                                
                                {{!-- Assign Damage Button --}}
                                {{#if @root.rollData.targetActor}}
                                    <div class="rt-roll-card__controls">
                                        <button class="rt-roll-card__btn rt-roll-card__btn--damage roll-control__assign-damage"
                                             data-location="{{hit.location}}"
                                             data-total-damage="{{hit.totalDamage}}"
                                             data-total-penetration="{{hit.totalPenetration}}"
                                             data-total-fatigue="{{hit.totalFatigue}}"
                                             data-target-uuid="{{@root.rollData.targetActor.uuid}}"
                                             data-damage-type="{{hit.damageType}}">
                                            <span class="material-icons">api</span>
                                            <span>Assign Damage</span>
                                        </button>
                                    </div>
                                {{/if}}
                            </div>
                        {{/each}}
                    </div>
                {{/with}}
            {{/unless}}
        </div>
    </div>
</div>
