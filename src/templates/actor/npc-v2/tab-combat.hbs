{{!-- NPC V2 Combat Tab - Battle Station --}}
<section class="tab {{#if tab.active}}active{{/if}} {{tab.cssClass}}" data-tab="{{tab.id}}" data-group="{{tab.group}}">
  <div class="rt-combat-tab">

    {{!-- ═══ TOP BAR: Wounds + Movement ═══ --}}
    <div class="rt-combat-topbar">
      {{!-- Wounds --}}
      <div class="rt-combat-wounds">
        <div class="rt-wounds-icon"><i class="fa-solid fa-heart"></i></div>
        <div class="rt-wounds-info">
          <div class="rt-wounds-display">
            <input type="number" name="system.wounds.value" value="{{system.wounds.value}}" min="0" class="rt-wounds-current" {{#unless editable}}disabled{{/unless}} />
            <span class="rt-wounds-sep">/</span>
            <input type="number" name="system.wounds.max" value="{{system.wounds.max}}" min="1" class="rt-wounds-max" {{#unless editable}}disabled{{/unless}} />
          </div>
          <div class="rt-wounds-bar">
            <div class="rt-wounds-fill" style="width: {{percent system.wounds.value system.wounds.max}}%"></div>
          </div>
        </div>
        <div class="rt-wounds-arrows">
          <button type="button" class="rt-arrow-btn rt-arrow-up" data-action="healWounds" data-amount="1" title="+1 Wound"><i class="fa-solid fa-caret-up"></i></button>
          <button type="button" class="rt-arrow-btn rt-arrow-down" data-action="applyDamage" data-amount="1" title="−1 Wound"><i class="fa-solid fa-caret-down"></i></button>
        </div>
        {{!-- Quick Stats --}}
        <div class="rt-combat-quickstats">
          <div class="rt-quickstat">
            <i class="fa-solid fa-shield-halved"></i>
            <span class="rt-quickstat-value">{{toughnessBonus}}</span>
            <span class="rt-quickstat-label">TB</span>
          </div>
          {{#if system.wounds.critical}}
          <div class="rt-quickstat rt-quickstat--critical">
            <i class="fa-solid fa-skull-crossbones"></i>
            <span class="rt-quickstat-value">{{system.wounds.critical}}</span>
            <span class="rt-quickstat-label">Crit</span>
          </div>
          {{/if}}
        </div>
      </div>

      {{!-- Movement Cards --}}
      <div class="rt-movement-cards">
        <div class="rt-move-card rt-move-card--half" title="Half Move Action">
          <i class="fa-solid fa-shoe-prints"></i>
          {{#if editable}}<input type="number" name="system.movement.half" value="{{system.movement.half}}" class="rt-move-card-input" />
          {{else}}<span class="rt-move-card-value">{{system.movement.half}}</span>{{/if}}
          <span class="rt-move-card-label">Half</span>
        </div>
        <div class="rt-move-card rt-move-card--full" title="Full Move Action">
          <i class="fa-solid fa-person-walking"></i>
          {{#if editable}}<input type="number" name="system.movement.full" value="{{system.movement.full}}" class="rt-move-card-input" />
          {{else}}<span class="rt-move-card-value">{{system.movement.full}}</span>{{/if}}
          <span class="rt-move-card-label">Full</span>
        </div>
        <div class="rt-move-card rt-move-card--charge" title="Charge Action">
          <i class="fa-solid fa-person-running"></i>
          {{#if editable}}<input type="number" name="system.movement.charge" value="{{system.movement.charge}}" class="rt-move-card-input" />
          {{else}}<span class="rt-move-card-value">{{system.movement.charge}}</span>{{/if}}
          <span class="rt-move-card-label">Charge</span>
        </div>
        <div class="rt-move-card rt-move-card--run" title="Run Action (Full Action)">
          <i class="fa-solid fa-bolt-lightning"></i>
          {{#if editable}}<input type="number" name="system.movement.run" value="{{system.movement.run}}" class="rt-move-card-input" />
          {{else}}<span class="rt-move-card-value">{{system.movement.run}}</span>{{/if}}
          <span class="rt-move-card-label">Run</span>
        </div>
      </div>
    </div>

    {{!-- ═══ 2-COLUMN: Armour/Hit Locations | Actions Grid ═══ --}}
    <div class="rt-combat-main">

      {{!-- LEFT: Armour & Hit Locations --}}
      <div class="rt-panel rt-panel--armour-locs">
        <div class="rt-panel-header">
          <i class="fa-solid fa-shield-halved"></i>
          <span>Armour & Hit Locations</span>
          {{#if editable}}
          <button class="rt-header-btn" type="button" data-action="toggleArmourMode" title="Toggle Simple/Locations">
            <i class="fa-solid fa-arrows-rotate"></i>
          </button>
          {{/if}}
        </div>
        <div class="rt-panel-body">
          <div class="rt-hit-locations-grid">
            {{#each hitLocations}}
            <div class="rt-hit-loc" data-location="{{key}}">
              <span class="rt-loc-range">{{range}}</span>
              <span class="rt-loc-label">{{short}}</span>
              {{#if ../editable}}
              {{#if ../armour.isLocations}}
              <input type="number" name="system.armour.locations.{{key}}" value="{{value}}" min="0" class="rt-loc-ap-input" title="AP" />
              {{else}}
              <span class="rt-loc-ap">{{value}}</span>
              {{/if}}
              {{else}}
              <span class="rt-loc-ap">{{value}}</span>
              {{/if}}
              <span class="rt-loc-dr" title="Damage Reduction (TB+AP)">DR {{dr}}</span>
            </div>
            {{/each}}
          </div>
          {{#if armour.isSimple}}
          <div class="rt-armour-simple-edit">
            <span class="rt-armour-mode-label">Simple Mode — All Locations:</span>
            {{#if editable}}
            <input type="number" name="system.armour.total" value="{{armour.total}}" min="0" class="rt-armour-total-input" />
            {{else}}
            <span class="rt-armour-total-value">{{armour.total}} AP</span>
            {{/if}}
          </div>
          {{/if}}
        </div>
      </div>

      {{!-- RIGHT: Actions Grid --}}
      <div class="rt-panel rt-panel--actions-grid">
        <div class="rt-panel-header">
          <i class="fa-solid fa-hand-fist"></i>
          <span>Actions</span>
        </div>
        <div class="rt-panel-body">
          <div class="rt-actions-grid">
            {{!-- Row 1: Dodge / Parry / Initiative --}}
            <div class="rt-action-row">
              <button type="button" class="rt-action-btn rt-action-btn--dodge rollable" data-action="rollSkill" data-skill="dodge"
                      title="Dodge — Half Action / Reaction&#10;Target: {{combatSummary.dodge}}">
                <i class="fa-solid fa-person-running"></i>
                <span class="rt-action-btn-value">{{combatSummary.dodge}}</span>
                <span class="rt-action-btn-label">Dodge</span>
                <span class="rt-action-btn-cost">Reaction</span>
              </button>
              <button type="button" class="rt-action-btn rt-action-btn--parry rollable" data-action="rollSkill" data-skill="parry"
                      title="Parry — Half Action / Reaction&#10;Target: {{combatSummary.parry}}">
                <i class="fa-solid fa-shield"></i>
                <span class="rt-action-btn-value">{{combatSummary.parry}}</span>
                <span class="rt-action-btn-label">Parry</span>
                <span class="rt-action-btn-cost">Reaction</span>
              </button>
              <button type="button" class="rt-action-btn rt-action-btn--init rollable" data-action="rollInitiative"
                      title="Roll Initiative&#10;Bonus: {{system.initiative.bonus}}">
                <i class="fa-solid fa-bolt"></i>
                <span class="rt-action-btn-value">{{system.initiative.bonus}}</span>
                <span class="rt-action-btn-label">Initiative</span>
                <span class="rt-action-btn-cost">Free</span>
              </button>
            </div>

            {{!-- Weapon Rows --}}
            {{#if isSimpleMode}}
            {{#each simpleWeapons}}
            <div class="rt-action-row rt-action-row--weapon" data-weapon-index="{{index}}">
              <button type="button" class="rt-action-btn rt-action-btn--attack rollable" data-action="rollWeapon" data-weapon-index="{{index}}"
                      title="Attack with {{name}}&#10;{{#if isMelee}}Half Action{{else}}Half Action{{/if}} — Dmg: {{damage}} | Pen: {{pen}}">
                <i class="fa-solid {{#if isMelee}}fa-sword{{else}}fa-crosshairs{{/if}}"></i>
                <span class="rt-action-btn-value">{{name}}</span>
                <span class="rt-action-btn-label">Attack</span>
                <span class="rt-action-btn-cost">Half</span>
              </button>
              <button type="button" class="rt-action-btn rt-action-btn--reload {{#if isMelee}}disabled{{/if}}"
                      {{#unless isMelee}}data-action="reloadWeapon" data-weapon-index="{{index}}"{{/unless}}
                      title="{{#if isMelee}}N/A — Melee{{else}}Reload — Half Action{{/if}}">
                <i class="fa-solid fa-arrows-rotate"></i>
                <span class="rt-action-btn-value">{{#if isMelee}}—{{else}}Reload{{/if}}</span>
                <span class="rt-action-btn-label">Reload</span>
                <span class="rt-action-btn-cost">{{#if isMelee}}—{{else}}Half+{{/if}}</span>
              </button>
              <button type="button" class="rt-action-btn rt-action-btn--ammo {{#if isMelee}}disabled{{/if}}"
                      title="{{#if isMelee}}N/A — Melee{{else}}Ammo: {{clip}}/{{clipMax}}{{/if}}">
                <i class="fa-solid fa-box-open"></i>
                <span class="rt-action-btn-value">{{#if isMelee}}—{{else}}{{clip}}/{{clipMax}}{{/if}}</span>
                <span class="rt-action-btn-label">Ammo</span>
                <span class="rt-action-btn-cost">—</span>
              </button>
            </div>
            {{/each}}
            {{else}}
            {{#each embeddedWeapons}}
            <div class="rt-action-row rt-action-row--weapon" data-item-id="{{id}}">
              <button type="button" class="rt-action-btn rt-action-btn--attack rollable" data-action="itemRoll" data-item-id="{{id}}"
                      title="Attack with {{name}}">
                <i class="fa-solid fa-crosshairs"></i>
                <span class="rt-action-btn-value">{{name}}</span>
                <span class="rt-action-btn-label">Attack</span>
                <span class="rt-action-btn-cost">Half</span>
              </button>
              <button type="button" class="rt-action-btn rt-action-btn--reload" title="Reload — Half Action">
                <i class="fa-solid fa-arrows-rotate"></i>
                <span class="rt-action-btn-value">Reload</span>
                <span class="rt-action-btn-label">Reload</span>
                <span class="rt-action-btn-cost">Half+</span>
              </button>
              <button type="button" class="rt-action-btn rt-action-btn--ammo" title="Ammo Management">
                <i class="fa-solid fa-box-open"></i>
                <span class="rt-action-btn-value">—</span>
                <span class="rt-action-btn-label">Ammo</span>
                <span class="rt-action-btn-cost">—</span>
              </button>
            </div>
            {{/each}}
            {{/if}}

            {{!-- Empty state --}}
            {{#unless combatWeaponRows}}
            <div class="rt-action-row rt-action-row--empty">
              <span class="rt-empty-label"><i class="fa-solid fa-gun"></i> No weapons — add from Inventory</span>
            </div>
            {{/unless}}
          </div>
        </div>
      </div>
    </div>

    {{!-- ═══ INVENTORY TABLE ═══ --}}
    <div class="rt-panel rt-panel--inventory" data-drop-zone="item">
      <div class="rt-panel-header">
        <i class="fa-solid fa-boxes-stacked"></i>
        <span>Inventory</span>
        <span class="rt-count-badge">{{allItems.length}}</span>
        {{#if editable}}
        <div class="rt-header-actions">
          {{#if isSimpleMode}}
          <button class="rt-header-btn" type="button" data-action="addSimpleWeapon" title="Add Simple Weapon"><i class="fa-solid fa-plus"></i></button>
          {{/if}}
          <button class="rt-header-btn" type="button" data-action="toggleWeaponMode" title="Toggle Simple/Embedded Weapons"><i class="fa-solid fa-arrows-rotate"></i></button>
        </div>
        {{/if}}
      </div>
      <div class="rt-panel-body">
        <table class="rt-inventory-table">
          <thead>
            <tr>
              <th class="rt-inv-col-icon"></th>
              <th class="rt-inv-col-name">Name</th>
              <th class="rt-inv-col-type">Type</th>
              <th class="rt-inv-col-qty">Qty</th>
              {{#if editable}}<th class="rt-inv-col-actions"></th>{{/if}}
            </tr>
          </thead>
          <tbody>
            {{!-- Simple Weapons --}}
            {{#if isSimpleMode}}
            {{#each simpleWeapons}}
            <tr class="rt-inv-row rt-inv-row--weapon">
              <td class="rt-inv-col-icon"><i class="fa-solid {{#if isMelee}}fa-sword{{else}}fa-crosshairs{{/if}}"></i></td>
              <td class="rt-inv-col-name">
                {{#if ../editable}}<input type="text" name="system.weapons.simple.{{index}}.name" value="{{name}}" class="rt-inv-name-input" placeholder="Weapon" />
                {{else}}{{name}}{{/if}}
              </td>
              <td class="rt-inv-col-type"><span class="rt-inv-type-badge weapon">{{class}}</span></td>
              <td class="rt-inv-col-qty">—</td>
              {{#if ../editable}}<td class="rt-inv-col-actions">
                <button type="button" class="rt-inv-remove" data-action="removeSimpleWeapon" data-weapon-index="{{index}}" title="Remove"><i class="fa-solid fa-trash-can"></i></button>
              </td>{{/if}}
            </tr>
            {{/each}}
            {{/if}}
            {{!-- Embedded Items --}}
            {{#each allItems}}
            <tr class="rt-inv-row rt-inv-row--{{type}}" data-item-id="{{id}}">
              <td class="rt-inv-col-icon"><img src="{{img}}" class="rt-inv-img" alt="" /></td>
              <td class="rt-inv-col-name">{{name}}</td>
              <td class="rt-inv-col-type"><span class="rt-inv-type-badge {{type}}">{{type}}</span></td>
              <td class="rt-inv-col-qty">{{#if system.quantity}}{{system.quantity}}{{else}}—{{/if}}</td>
              {{#if ../editable}}<td class="rt-inv-col-actions">
                <button type="button" class="rt-inv-remove" data-action="removeItem" data-item-id="{{id}}" title="Remove"><i class="fa-solid fa-trash-can"></i></button>
              </td>{{/if}}
            </tr>
            {{/each}}
          </tbody>
        </table>
        {{#unless allItems.length}}
        {{#unless simpleWeapons.length}}
        <div class="rt-empty-state"><i class="fa-solid fa-box-open"></i><p>Drag items here to add</p></div>
        {{/unless}}
        {{/unless}}
      </div>
    </div>

  </div>
</section>
