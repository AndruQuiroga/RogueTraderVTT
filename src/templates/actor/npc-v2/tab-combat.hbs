{{!-- NPC V2 Combat Tab - All Combat Info in One Place --}}
<section class="tab {{#if tab.active}}active{{/if}} {{tab.cssClass}}" data-tab="{{tab.id}}" data-group="{{tab.group}}">
  <div class="rt-combat-tab">

    {{!-- TOP ROW: Wounds + Combat Stats + Movement --}}
    <div class="rt-combat-vitals">
      
      {{!-- Wounds Panel --}}
      <div class="rt-panel rt-panel--wounds">
        <div class="rt-panel-header">
          <i class="fa-solid fa-heart"></i>
          <span>Wounds</span>
        </div>
        <div class="rt-panel-body">
          <div class="rt-wounds-display">
            <input type="number"
                   name="system.wounds.value"
                   value="{{system.wounds.value}}"
                   min="0"
                   class="rt-wounds-current"
                   {{#unless editable}}disabled{{/unless}} />
            <span class="rt-wounds-sep">/</span>
            <input type="number"
                   name="system.wounds.max"
                   value="{{system.wounds.max}}"
                   min="1"
                   class="rt-wounds-max"
                   {{#unless editable}}disabled{{/unless}} />
          </div>
          <div class="rt-wounds-bar">
            <div class="rt-wounds-fill" style="width: {{percent system.wounds.value system.wounds.max}}%"></div>
          </div>
          <div class="rt-damage-controls">
            <div class="rt-damage-row">
              <button type="button" class="rt-btn-damage" data-action="applyDamage" data-amount="1">−1</button>
              <button type="button" class="rt-btn-damage" data-action="applyDamage" data-amount="5">−5</button>
              <button type="button" class="rt-btn-damage" data-action="applyDamage" data-amount="10">−10</button>
            </div>
            <div class="rt-heal-row">
              <button type="button" class="rt-btn-heal" data-action="healWounds" data-amount="1">+1</button>
              <button type="button" class="rt-btn-heal" data-action="healWounds" data-amount="5">+5</button>
              <button type="button" class="rt-btn-heal" data-action="healWounds" data-amount="10">+10</button>
            </div>
            {{#if editable}}
            <div class="rt-custom-damage">
              <input type="number" class="rt-custom-input" data-custom-damage value="1" min="1" />
              <button type="button" class="rt-btn-damage" data-action="applyCustomDamage"><i class="fa-solid fa-minus"></i></button>
              <button type="button" class="rt-btn-heal" data-action="healCustomWounds"><i class="fa-solid fa-plus"></i></button>
            </div>
            {{/if}}
          </div>
        </div>
      </div>

      {{!-- Combat Stats --}}
      <div class="rt-panel rt-panel--combat">
        <div class="rt-panel-header">
          <i class="fa-solid fa-swords"></i>
          <span>Combat</span>
        </div>
        <div class="rt-panel-body">
          <div class="rt-combat-stats">
            <div class="rt-stat-tile rollable" data-action="rollInitiative" title="Roll Initiative">
              <i class="fa-solid fa-bolt"></i>
              <span class="rt-stat-value">{{system.initiative.bonus}}</span>
              <span class="rt-stat-label">Init</span>
            </div>
            <div class="rt-stat-tile rollable" data-action="rollSkill" data-skill="dodge" title="Roll Dodge">
              <i class="fa-solid fa-person-running-fast"></i>
              <span class="rt-stat-value">{{combatSummary.dodge}}</span>
              <span class="rt-stat-label">Dodge</span>
            </div>
            <div class="rt-stat-tile rollable" data-action="rollSkill" data-skill="parry" title="Roll Parry">
              <i class="fa-solid fa-shield"></i>
              <span class="rt-stat-value">{{combatSummary.parry}}</span>
              <span class="rt-stat-label">Parry</span>
            </div>
          </div>
        </div>
      </div>

      {{!-- Defense / Armour --}}
      <div class="rt-panel rt-panel--armour">
        <div class="rt-panel-header">
          <i class="fa-solid fa-shield-halved"></i>
          <span>Armour</span>
          {{#if editable}}
          <button class="rt-header-btn" type="button" data-action="toggleArmourMode" title="Toggle Simple/Locations">
            <i class="fa-solid fa-arrows-rotate"></i>
          </button>
          {{/if}}
        </div>
        <div class="rt-panel-body">
          {{#if armour.isSimple}}
          <div class="rt-armour-simple">
            <div class="rt-armour-big">
              {{#if editable}}
              <input type="number" name="system.armour.total" value="{{armour.total}}" min="0" class="rt-armour-input" />
              {{else}}
              <span class="rt-armour-value">{{armour.total}}</span>
              {{/if}}
              <span class="rt-armour-label">AP</span>
            </div>
            <div class="rt-dr-calc">
              <span>TB {{toughnessBonus}} + AP {{armour.total}} = <strong>{{add toughnessBonus armour.total}} DR</strong></span>
            </div>
          </div>
          {{else}}
          <div class="rt-armour-locations">
            {{#each hitLocations}}
            <div class="rt-location">
              <span class="rt-loc-name">{{label}}</span>
              {{#if ../editable}}
              <input type="number" name="system.armour.locations.{{key}}" value="{{value}}" min="0" class="rt-loc-input" />
              {{else}}
              <span class="rt-loc-value">{{value}}</span>
              {{/if}}
              <span class="rt-loc-dr">=={{add value ../toughnessBonus}}</span>
            </div>
            {{/each}}
          </div>
          {{/if}}
        </div>
      </div>

      {{!-- Movement --}}
      <div class="rt-panel rt-panel--movement">
        <div class="rt-panel-header">
          <i class="fa-solid fa-person-running"></i>
          <span>Movement</span>
        </div>
        <div class="rt-panel-body">
          <div class="rt-movement-grid">
            <div class="rt-move-tile">
              <span class="rt-move-label">Half</span>
              {{#if editable}}
              <input type="number" name="system.movement.half" value="{{system.movement.half}}" class="rt-move-input" />
              {{else}}
              <span class="rt-move-value">{{system.movement.half}}</span>
              {{/if}}
            </div>
            <div class="rt-move-tile">
              <span class="rt-move-label">Full</span>
              {{#if editable}}
              <input type="number" name="system.movement.full" value="{{system.movement.full}}" class="rt-move-input" />
              {{else}}
              <span class="rt-move-value">{{system.movement.full}}</span>
              {{/if}}
            </div>
            <div class="rt-move-tile">
              <span class="rt-move-label">Charge</span>
              {{#if editable}}
              <input type="number" name="system.movement.charge" value="{{system.movement.charge}}" class="rt-move-input" />
              {{else}}
              <span class="rt-move-value">{{system.movement.charge}}</span>
              {{/if}}
            </div>
            <div class="rt-move-tile">
              <span class="rt-move-label">Run</span>
              {{#if editable}}
              <input type="number" name="system.movement.run" value="{{system.movement.run}}" class="rt-move-input" />
              {{else}}
              <span class="rt-move-value">{{system.movement.run}}</span>
              {{/if}}
            </div>
          </div>
        </div>
      </div>
    </div>

    {{!-- WEAPONS SECTION --}}
    <div class="rt-panel rt-panel--weapons" data-drop-zone="weapon" data-accepts="weapon">
      <div class="rt-panel-header">
        <i class="fa-solid fa-gun"></i>
        <span>Weapons</span>
        {{#if editable}}
        <div class="rt-header-actions">
          <button class="rt-header-btn" type="button" data-action="addSimpleWeapon" title="Add Weapon">
            <i class="fa-solid fa-plus"></i>
          </button>
          <button class="rt-header-btn" type="button" data-action="toggleWeaponMode" title="Toggle Simple/Items">
            <i class="fa-solid fa-arrows-rotate"></i>
          </button>
        </div>
        {{/if}}
      </div>
      <div class="rt-panel-body">
        {{#if isSimpleMode}}
        <div class="rt-weapons-list">
          {{#each simpleWeapons}}
          <div class="rt-weapon-card {{#if isMelee}}melee{{else}}ranged{{/if}}">
            <div class="rt-weapon-header">
              <i class="fa-solid {{#if isMelee}}fa-sword{{else}}fa-crosshairs{{/if}}"></i>
              {{#if ../editable}}
              <input type="text" name="system.weapons.simple.{{index}}.name" value="{{name}}" class="rt-weapon-name-input" placeholder="Weapon Name" />
              {{else}}
              <span class="rt-weapon-name">{{name}}</span>
              {{/if}}
              <button type="button" class="rt-btn-attack rollable" data-action="rollWeapon" data-weapon-index="{{index}}" title="Attack">
                <i class="fa-solid fa-dice-d20"></i>
              </button>
              {{#if ../editable}}
              <button type="button" class="rt-btn-delete" data-action="removeSimpleWeapon" data-weapon-index="{{index}}" title="Remove">
                <i class="fa-solid fa-trash-can"></i>
              </button>
              {{/if}}
            </div>
            <div class="rt-weapon-stats">
              {{#if ../editable}}
              <select name="system.weapons.simple.{{index}}.class" class="rt-weapon-class">
                {{#select class}}
                <option value="melee">Melee</option>
                <option value="pistol">Pistol</option>
                <option value="basic">Basic</option>
                <option value="heavy">Heavy</option>
                <option value="thrown">Thrown</option>
                {{/select}}
              </select>
              {{/if}}
              <span class="rt-weapon-stat">
                <i class="fa-solid fa-burst"></i>
                {{#if ../editable}}
                <input type="text" name="system.weapons.simple.{{index}}.damage" value="{{damage}}" class="rt-stat-input" placeholder="1d10+3" />
                {{else}}
                {{damage}}
                {{/if}}
              </span>
              <span class="rt-weapon-stat">
                <i class="fa-solid fa-bullseye-arrow"></i>
                {{#if ../editable}}
                <input type="number" name="system.weapons.simple.{{index}}.pen" value="{{pen}}" min="0" class="rt-stat-input-sm" />
                {{else}}
                {{pen}}
                {{/if}}
              </span>
              {{#if isRanged}}
              <span class="rt-weapon-stat">
                <i class="fa-solid fa-ruler"></i>
                {{#if ../editable}}
                <input type="text" name="system.weapons.simple.{{index}}.range" value="{{range}}" class="rt-stat-input" placeholder="30m" />
                {{else}}
                {{range}}
                {{/if}}
              </span>
              <span class="rt-weapon-stat">
                <i class="fa-solid fa-arrows-repeat"></i>
                {{#if ../editable}}
                <input type="text" name="system.weapons.simple.{{index}}.rof" value="{{rof}}" class="rt-stat-input" placeholder="S/2/–" />
                {{else}}
                {{rof}}
                {{/if}}
              </span>
              {{/if}}
            </div>
            {{#if special}}
            <div class="rt-weapon-special">
              {{#if ../editable}}
              <input type="text" name="system.weapons.simple.{{index}}.special" value="{{special}}" class="rt-special-input" placeholder="Special qualities..." />
              {{else}}
              <span>{{special}}</span>
              {{/if}}
            </div>
            {{else if ../editable}}
            <div class="rt-weapon-special">
              <input type="text" name="system.weapons.simple.{{index}}.special" value="" class="rt-special-input" placeholder="Special qualities..." />
            </div>
            {{/if}}
          </div>
          {{else}}
          <div class="rt-empty-state">
            <i class="fa-solid fa-gun"></i>
            <p>No weapons configured</p>
            {{#if editable}}
            <button type="button" class="rt-btn-add" data-action="addSimpleWeapon">
              <i class="fa-solid fa-plus"></i> Add Weapon
            </button>
            {{/if}}
          </div>
          {{/each}}
        </div>
        {{else}}
        {{!-- Embedded weapons mode --}}
        <div class="rt-embedded-weapons">
          {{#each embeddedWeapons}}
          <div class="rt-weapon-item" data-item-id="{{id}}">
            <img src="{{img}}" class="rt-weapon-img" alt="{{name}}" />
            <div class="rt-weapon-info">
              <span class="rt-weapon-item-name">{{name}}</span>
              <span class="rt-weapon-item-stats">{{system.damage}} | Pen {{system.penetration}}</span>
            </div>
            <button type="button" class="rt-btn-attack rollable" data-action="itemRoll" data-item-id="{{id}}" title="Attack">
              <i class="fa-solid fa-dice-d20"></i>
            </button>
          </div>
          {{else}}
          <div class="rt-empty-state">
            <i class="fa-solid fa-hand-pointer"></i>
            <p>Drag weapon items here or use Simple mode</p>
          </div>
          {{/each}}
        </div>
        {{/if}}
      </div>
    </div>

    {{!-- Combat Tracker (GM only) --}}
    {{#if isGM}}
    <div class="rt-panel rt-panel--tracker">
      <div class="rt-panel-header">
        <i class="fa-solid fa-chess-clock"></i>
        <span>Combat Tracker</span>
      </div>
      <div class="rt-panel-body">
        <div class="rt-tracker-content">
          {{#if actor.inCombat}}
          <span class="rt-status rt-status--active">
            <i class="fa-solid fa-circle"></i> In Combat
          </span>
          <span class="rt-init-value">
            <i class="fa-solid fa-bolt"></i> Init: {{actor.combatant.initiative}}
          </span>
          <div class="rt-tracker-actions">
            <button type="button" class="rt-btn-secondary" data-action="rerollInitiative">
              <i class="fa-solid fa-dice"></i> Reroll
            </button>
            <button type="button" class="rt-btn-danger" data-action="removeFromCombat">
              <i class="fa-solid fa-xmark"></i> Remove
            </button>
          </div>
          {{else}}
          <span class="rt-status rt-status--inactive">
            <i class="fa-regular fa-circle"></i> Not in Combat
          </span>
          <button type="button" class="rt-btn-primary" data-action="addToCombat">
            <i class="fa-solid fa-plus"></i> Add to Combat
          </button>
          {{/if}}
        </div>
      </div>
    </div>
    {{/if}}

  </div>
</section>
