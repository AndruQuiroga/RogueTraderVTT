{{!-- NPC V2 Combat Tab - Battle Station --}}
<section class="tab {{#if tab.active}}active{{/if}} {{tab.cssClass}}" data-tab="{{tab.id}}" data-group="{{tab.group}}">
  <div class="rt-combat-tab">

    {{!-- ═══ WOUNDS & VITALS BAR ═══ --}}
    <div class="rt-combat-header">
      <div class="rt-combat-wounds">
        <div class="rt-wounds-icon"><i class="fa-solid fa-heart"></i></div>
        <div class="rt-wounds-info">
          <div class="rt-wounds-display">
            <input type="number" name="system.wounds.value" value="{{system.wounds.value}}" min="0" class="rt-wounds-current" {{#unless editable}}disabled{{/unless}} />
            <span class="rt-wounds-sep">/</span>
            <input type="number" name="system.wounds.max" value="{{system.wounds.max}}" min="1" class="rt-wounds-max" {{#unless editable}}disabled{{/unless}} />
          </div>
          <div class="rt-wounds-bar">
            <div class="rt-wounds-fill" style="width: {{percent system.wounds.value system.wounds.max}}%"></div>
          </div>
        </div>
        <div class="rt-wounds-actions">
          <button type="button" class="rt-btn-damage" data-action="applyDamage" data-amount="1" title="−1 Wound">−1</button>
          <button type="button" class="rt-btn-damage" data-action="applyDamage" data-amount="5" title="−5 Wounds">−5</button>
          <div class="rt-custom-damage">
            <input type="number" class="rt-custom-input" data-custom-damage value="1" min="1" />
            <button type="button" class="rt-btn-damage" data-action="applyCustomDamage" title="Apply Damage"><i class="fa-solid fa-minus"></i></button>
            <button type="button" class="rt-btn-heal" data-action="healCustomWounds" title="Heal"><i class="fa-solid fa-plus"></i></button>
          </div>
          <button type="button" class="rt-btn-heal" data-action="healWounds" data-amount="5" title="+5 Wounds">+5</button>
          <button type="button" class="rt-btn-heal" data-action="healWounds" data-amount="1" title="+1 Wound">+1</button>
        </div>
      </div>
      {{!-- Critical Wounds --}}
      <div class="rt-combat-quickstats">
        <div class="rt-quickstat">
          <i class="fa-solid fa-shield-halved"></i>
          <span class="rt-quickstat-value">{{toughnessBonus}}</span>
          <span class="rt-quickstat-label">TB</span>
        </div>
        {{#if system.wounds.critical}}
        <div class="rt-quickstat rt-quickstat--critical">
          <i class="fa-solid fa-skull-crossbones"></i>
          <span class="rt-quickstat-value">{{system.wounds.critical}}</span>
          <span class="rt-quickstat-label">Crit</span>
        </div>
        {{/if}}
      </div>
    </div>

    {{!-- ═══ 2-COLUMN: Armour/Hit Locations | Action Cards ═══ --}}
    <div class="rt-combat-main">

      {{!-- LEFT: Armour & Hit Locations --}}
      <div class="rt-panel rt-panel--armour-locs">
        <div class="rt-panel-header">
          <i class="fa-solid fa-shield-halved"></i>
          <span>Armour & Hit Locations</span>
          {{#if editable}}
          <button class="rt-header-btn" type="button" data-action="toggleArmourMode" title="Toggle Simple/Locations">
            <i class="fa-solid fa-arrows-rotate"></i>
          </button>
          {{/if}}
        </div>
        <div class="rt-panel-body">
          <div class="rt-hit-locations-grid">
            {{#each hitLocations}}
            <div class="rt-hit-loc" data-location="{{key}}">
              <span class="rt-loc-range">{{range}}</span>
              <span class="rt-loc-label">{{short}}</span>
              {{#if ../editable}}
              {{#if ../armour.isLocations}}
              <input type="number" name="system.armour.locations.{{key}}" value="{{value}}" min="0" class="rt-loc-ap-input" title="AP" />
              {{else}}
              <span class="rt-loc-ap">{{value}}</span>
              {{/if}}
              {{else}}
              <span class="rt-loc-ap">{{value}}</span>
              {{/if}}
              <span class="rt-loc-dr" title="Damage Reduction (TB+AP)">DR {{dr}}</span>
            </div>
            {{/each}}
          </div>
          {{#if armour.isSimple}}
          <div class="rt-armour-simple-edit">
            <span class="rt-armour-mode-label">Simple Mode — All Locations:</span>
            {{#if editable}}
            <input type="number" name="system.armour.total" value="{{armour.total}}" min="0" class="rt-armour-total-input" />
            {{else}}
            <span class="rt-armour-total-value">{{armour.total}} AP</span>
            {{/if}}
          </div>
          {{/if}}
        </div>
      </div>

      {{!-- RIGHT: Action Cards + Movement --}}
      <div class="rt-combat-actions-col">
        {{!-- Action Cards --}}
        <div class="rt-action-cards">
          <button type="button" class="rt-action-card rollable" data-action="rollSkill" data-skill="dodge" title="Roll Dodge">
            <i class="fa-solid fa-person-running"></i>
            <span class="rt-action-value">{{combatSummary.dodge}}</span>
            <span class="rt-action-label">Dodge</span>
          </button>
          <button type="button" class="rt-action-card rollable" data-action="rollSkill" data-skill="parry" title="Roll Parry">
            <i class="fa-solid fa-shield"></i>
            <span class="rt-action-value">{{combatSummary.parry}}</span>
            <span class="rt-action-label">Parry</span>
          </button>
          <button type="button" class="rt-action-card rollable" data-action="rollInitiative" title="Roll Initiative">
            <i class="fa-solid fa-bolt"></i>
            <span class="rt-action-value">{{system.initiative.bonus}}</span>
            <span class="rt-action-label">Initiative</span>
          </button>
        </div>

        {{!-- Movement --}}
        <div class="rt-panel rt-panel--movement">
          <div class="rt-panel-header">
            <i class="fa-solid fa-person-running"></i>
            <span>Movement</span>
          </div>
          <div class="rt-panel-body">
            <div class="rt-movement-grid">
              <div class="rt-move-tile">
                <span class="rt-move-label">Half</span>
                {{#if editable}}<input type="number" name="system.movement.half" value="{{system.movement.half}}" class="rt-move-input" />
                {{else}}<span class="rt-move-value">{{system.movement.half}}</span>{{/if}}
              </div>
              <div class="rt-move-tile">
                <span class="rt-move-label">Full</span>
                {{#if editable}}<input type="number" name="system.movement.full" value="{{system.movement.full}}" class="rt-move-input" />
                {{else}}<span class="rt-move-value">{{system.movement.full}}</span>{{/if}}
              </div>
              <div class="rt-move-tile">
                <span class="rt-move-label">Charge</span>
                {{#if editable}}<input type="number" name="system.movement.charge" value="{{system.movement.charge}}" class="rt-move-input" />
                {{else}}<span class="rt-move-value">{{system.movement.charge}}</span>{{/if}}
              </div>
              <div class="rt-move-tile">
                <span class="rt-move-label">Run</span>
                {{#if editable}}<input type="number" name="system.movement.run" value="{{system.movement.run}}" class="rt-move-input" />
                {{else}}<span class="rt-move-value">{{system.movement.run}}</span>{{/if}}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    {{!-- ═══ WEAPONS ═══ --}}
    <div class="rt-panel rt-panel--weapons" data-drop-zone="weapon" data-accepts="weapon">
      <div class="rt-panel-header">
        <i class="fa-solid fa-gun"></i>
        <span>Weapons</span>
        {{#if editable}}
        <div class="rt-header-actions">
          <button class="rt-header-btn" type="button" data-action="addSimpleWeapon" title="Add Weapon"><i class="fa-solid fa-plus"></i></button>
          <button class="rt-header-btn" type="button" data-action="toggleWeaponMode" title="Toggle Simple/Items"><i class="fa-solid fa-arrows-rotate"></i></button>
        </div>
        {{/if}}
      </div>
      <div class="rt-panel-body">
        {{#if isSimpleMode}}
        <div class="rt-weapons-list">
          {{#each simpleWeapons}}
          <div class="rt-weapon-card {{#if isMelee}}melee{{else}}ranged{{/if}}">
            <div class="rt-weapon-header">
              <i class="fa-solid {{#if isMelee}}fa-sword{{else}}fa-crosshairs{{/if}}"></i>
              {{#if ../editable}}
              <input type="text" name="system.weapons.simple.{{index}}.name" value="{{name}}" class="rt-weapon-name-input" placeholder="Weapon Name" />
              {{else}}
              <span class="rt-weapon-name">{{name}}</span>
              {{/if}}
              <button type="button" class="rt-btn-attack rollable" data-action="rollWeapon" data-weapon-index="{{index}}" title="Attack Roll">
                <i class="fa-solid fa-dice-d20"></i> Attack
              </button>
              {{#if ../editable}}
              <button type="button" class="rt-btn-delete" data-action="removeSimpleWeapon" data-weapon-index="{{index}}" title="Remove"><i class="fa-solid fa-trash-can"></i></button>
              {{/if}}
            </div>
            <div class="rt-weapon-stats">
              {{#if ../editable}}
              <select name="system.weapons.simple.{{index}}.class" class="rt-weapon-class">{{selectOptions ../weaponClassOptions selected=this.class}}</select>
              {{else}}
              <span class="rt-weapon-stat rt-weapon-class-label">{{this.class}}</span>
              {{/if}}
              <span class="rt-weapon-stat" title="Damage"><i class="fa-solid fa-burst"></i>
                {{#if ../editable}}<input type="text" name="system.weapons.simple.{{index}}.damage" value="{{damage}}" class="rt-stat-input" placeholder="1d10+3" />
                {{else}}{{damage}}{{/if}}
              </span>
              <span class="rt-weapon-stat" title="Penetration"><i class="fa-solid fa-bullseye-arrow"></i>
                {{#if ../editable}}<input type="number" name="system.weapons.simple.{{index}}.pen" value="{{pen}}" min="0" class="rt-stat-input-sm" />
                {{else}}Pen {{pen}}{{/if}}
              </span>
              {{#if isRanged}}
              <span class="rt-weapon-stat" title="Range"><i class="fa-solid fa-ruler"></i>
                {{#if ../editable}}<input type="text" name="system.weapons.simple.{{index}}.range" value="{{range}}" class="rt-stat-input" placeholder="30m" />
                {{else}}{{range}}{{/if}}
              </span>
              <span class="rt-weapon-stat" title="Rate of Fire"><i class="fa-solid fa-arrows-repeat"></i>
                {{#if ../editable}}<input type="text" name="system.weapons.simple.{{index}}.rof" value="{{rof}}" class="rt-stat-input" placeholder="S/2/–" />
                {{else}}{{rof}}{{/if}}
              </span>
              {{/if}}
            </div>
            {{#if special}}
            <div class="rt-weapon-special">
              {{#if ../editable}}<input type="text" name="system.weapons.simple.{{index}}.special" value="{{special}}" class="rt-special-input" placeholder="Special qualities..." />
              {{else}}<span>{{special}}</span>{{/if}}
            </div>
            {{else if ../editable}}
            <div class="rt-weapon-special">
              <input type="text" name="system.weapons.simple.{{index}}.special" value="" class="rt-special-input" placeholder="Special qualities..." />
            </div>
            {{/if}}
          </div>
          {{else}}
          <div class="rt-empty-state">
            <i class="fa-solid fa-gun"></i>
            <p>No weapons configured</p>
            {{#if editable}}<button type="button" class="rt-btn-add" data-action="addSimpleWeapon"><i class="fa-solid fa-plus"></i> Add Weapon</button>{{/if}}
          </div>
          {{/each}}
        </div>
        {{else}}
        <div class="rt-embedded-weapons">
          {{#each embeddedWeapons}}
          <div class="rt-weapon-item" data-item-id="{{id}}">
            <img src="{{img}}" class="rt-weapon-img" alt="{{name}}" />
            <div class="rt-weapon-info">
              <span class="rt-weapon-item-name">{{name}}</span>
              <span class="rt-weapon-item-stats">{{system.damage}} | Pen {{system.penetration}}</span>
            </div>
            <button type="button" class="rt-btn-attack rollable" data-action="itemRoll" data-item-id="{{id}}" title="Attack">
              <i class="fa-solid fa-dice-d20"></i> Attack
            </button>
          </div>
          {{else}}
          <div class="rt-empty-state"><i class="fa-solid fa-hand-pointer"></i><p>Drag weapon items here or use Simple mode</p></div>
          {{/each}}
        </div>
        {{/if}}
      </div>
    </div>

    {{!-- ═══ INVENTORY (compact) ═══ --}}
    {{#if gearItems.length}}
    <div class="rt-panel rt-panel--inventory">
      <div class="rt-panel-header">
        <i class="fa-solid fa-backpack"></i>
        <span>Inventory</span>
        <span class="rt-count-badge">{{gearItems.length}}</span>
      </div>
      <div class="rt-panel-body">
        <div class="rt-gear-list">
          {{#each gearItems}}
          <div class="rt-gear-chip" data-item-id="{{id}}" title="{{name}}">
            <img src="{{img}}" class="rt-gear-img" alt="" />
            <span class="rt-gear-name">{{name}}</span>
            {{#if system.quantity}}
            <span class="rt-gear-qty">×{{system.quantity}}</span>
            {{/if}}
          </div>
          {{/each}}
        </div>
      </div>
    </div>
    {{/if}}

    {{!-- ═══ COMBAT TRACKER ═══ --}}
    {{#if isGM}}
    <div class="rt-panel rt-panel--tracker">
      <div class="rt-panel-header">
        <i class="fa-solid fa-chess-clock"></i>
        <span>Combat Tracker</span>
      </div>
      <div class="rt-panel-body">
        <div class="rt-tracker-content">
          {{#if actor.inCombat}}
          <span class="rt-status rt-status--active"><i class="fa-solid fa-circle"></i> In Combat</span>
          <span class="rt-init-value"><i class="fa-solid fa-bolt"></i> Init: {{actor.combatant.initiative}}</span>
          <div class="rt-tracker-actions">
            <button type="button" class="rt-btn-secondary" data-action="rerollInitiative"><i class="fa-solid fa-dice"></i> Reroll</button>
            <button type="button" class="rt-btn-danger" data-action="removeFromCombat"><i class="fa-solid fa-xmark"></i> Remove</button>
          </div>
          {{else}}
          <span class="rt-status rt-status--inactive"><i class="fa-regular fa-circle"></i> Not in Combat</span>
          <button type="button" class="rt-btn-primary" data-action="addToCombat"><i class="fa-solid fa-plus"></i> Add to Combat</button>
          {{/if}}
        </div>
      </div>
    </div>
    {{/if}}

  </div>
</section>
