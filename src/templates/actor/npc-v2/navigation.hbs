{{!-- NPC V2 Vertical Navigation + Identity Panel --}}
<div class="rt-npc-v2-sidebar">
  {{!-- Portrait & Identity --}}
  <div class="rt-npc-identity">
    <div class="rt-portrait-container">
      <img class="rt-portrait-img" src="{{actor.img}}" alt="{{actor.name}}" />
      {{#if editable}}
      <button class="rt-portrait-edit-btn" data-action="editImage" type="button" title="Change Image">
        <i class="fa-solid fa-camera"></i>
      </button>
      {{/if}}
    </div>

    <input class="rt-name-input"
           name="name"
           type="text"
           value="{{actor.name}}"
           placeholder="{{localize 'RT.NPC.Name'}}"
           {{#unless editable}}disabled{{/unless}} />

    {{!-- Threat Badge --}}
    <div class="rt-threat-badge" style="--threat-color: {{threatTier.color}}">
      <i class="fa-solid fa-skull"></i>
      <span class="rt-threat-label">Threat</span>
      <input type="number"
             name="system.threatLevel"
             value="{{system.threatLevel}}"
             min="1"
             max="30"
             class="rt-threat-input"
             {{#unless editable}}disabled{{/unless}} />
      <span class="rt-threat-tier">{{threatTier.label}}</span>
    </div>

    {{!-- Quick Meta --}}
    <div class="rt-meta-compact">
      <select name="system.type" class="rt-select-compact" {{#unless editable}}disabled{{/unless}} title="Type">
        {{selectOptions npcTypeOptions selected=source.type}}
      </select>
      <select name="system.role" class="rt-select-compact" {{#unless editable}}disabled{{/unless}} title="Role">
        {{selectOptions npcRoleOptions selected=source.role}}
      </select>
    </div>
  </div>

  {{!-- Vertical Tab Navigation --}}
  <nav class="rt-vertical-nav tabs" data-group="primary">
    {{#each tabs}}
    <button type="button"
            class="rt-nav-item {{#if active}}active{{/if}}"
            data-action="tab"
            data-group="{{group}}"
            data-tab="{{id}}"
            data-tooltip="{{localize label}}">
      <i class="{{icon}}"></i>
      <span class="rt-nav-label">{{localize label}}</span>
    </button>
    {{/each}}
  </nav>

  {{!-- Edit Mode Toggle (always visible) --}}
  <button class="rt-edit-toggle {{#if editable}}active{{/if}}" data-action="toggleEditMode" type="button"
          data-tooltip="{{#if editable}}Lock Sheet{{else}}Edit Sheet{{/if}}">
    <i class="fa-solid {{#if editable}}fa-lock-open{{else}}fa-lock{{/if}}"></i>
    <span class="rt-edit-toggle-label">{{#if editable}}Editing{{else}}Locked{{/if}}</span>
  </button>

  {{!-- GM Toolbar — collapsible --}}
  {{#if isGM}}
  <div class="rt-gm-tools-wrapper">
    <button class="rt-gm-tools-toggle" type="button" data-action="toggleGMTools" data-tooltip="GM Tools">
      <i class="fa-solid fa-toolbox"></i>
      <span>GM Tools</span>
      <i class="fa-solid fa-chevron-down rt-gm-chevron"></i>
    </button>
    <div class="rt-gm-tools" hidden>
      <button class="rt-tool-btn" data-action="setupToken" type="button" data-tooltip="Configure Token">
        <i class="fa-solid fa-chess-pawn"></i>
      </button>
      <button class="rt-tool-btn" data-action="duplicateNPC" type="button" data-tooltip="Clone NPC">
        <i class="fa-solid fa-clone"></i>
      </button>
      <button class="rt-tool-btn" data-action="scaleToThreat" type="button" data-tooltip="Scale to Threat">
        <i class="fa-solid fa-scale-balanced"></i>
      </button>
      <button class="rt-tool-btn" data-action="exportStatBlock" type="button" data-tooltip="Export Stat Block">
        <i class="fa-solid fa-file-export"></i>
      </button>
      <button class="rt-tool-btn" data-action="calculateDifficulty" type="button" data-tooltip="Calculate Difficulty">
        <i class="fa-solid fa-calculator"></i>
      </button>
      <button class="rt-tool-btn rt-tool-btn--danger" data-action="deleteNPC" type="button" data-tooltip="Delete NPC">
        <i class="fa-solid fa-trash-can"></i>
      </button>
    </div>
  </div>
  {{/if}}

  {{!-- Horde Magnitude (if enabled) --}}
  {{#if horde.enabled}}
  <div class="rt-magnitude-compact">
    <div class="rt-magnitude-header">
      <i class="fa-solid fa-users"></i>
      <span>{{horde.magnitude}}/{{horde.magnitudeMax}}</span>
    </div>
    <div class="rt-magnitude-bar-container">
      <div class="rt-magnitude-bar rt-magnitude-bar--{{horde.barClass}}"
           style="width: {{horde.magnitudePercent}}%"></div>
    </div>
    <div class="rt-magnitude-btns">
      <button type="button" class="rt-mag-btn" data-action="applyMagnitudeDamage" data-amount="1">−1</button>
      <button type="button" class="rt-mag-btn" data-action="restoreMagnitude" data-amount="1">+1</button>
    </div>
  </div>
  {{/if}}

  {{!-- Combat Tracker (sidebar) --}}
  {{#if isGM}}
  <div class="rt-combat-tracker-nav">
    {{#if actor.inCombat}}
    <div class="rt-tracker-status rt-tracker-status--active">
      <i class="fa-solid fa-swords"></i>
      <span>Init: {{actor.combatant.initiative}}</span>
    </div>
    <div class="rt-tracker-nav-actions">
      <button type="button" class="rt-tool-btn" data-action="rerollInitiative" data-tooltip="Reroll Initiative"><i class="fa-solid fa-dice"></i></button>
      <button type="button" class="rt-tool-btn rt-tool-btn--danger" data-action="removeFromCombat" data-tooltip="Remove from Combat"><i class="fa-solid fa-xmark"></i></button>
    </div>
    {{else}}
    <button type="button" class="rt-combat-add-btn" data-action="addToCombat" data-tooltip="Add to Combat">
      <i class="fa-solid fa-swords"></i>
      <span>Add to Combat</span>
    </button>
    {{/if}}
  </div>
  {{/if}}
</div>
