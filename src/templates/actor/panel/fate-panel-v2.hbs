{{!-- Redesigned Fate Panel - Golden Star Pips, Spending Menu, Sacred Theme --}}
<div class="rt-panel rt-fate-panel-v2">

    {{!-- Panel Header - Click to expand/collapse --}}
    <div class="rt-panel-header rt-panel-header--clickable sheet-control__hide-control"
         data-toggle="fate_details"
         title="Click to {{#if (isExpanded 'fate_details' actor)}}collapse{{else}}expand{{/if}}">
        <span class="rt-panel-title">
            <i class="fas fa-star"></i> Fate Points
        </span>
        <i class="fas fa-chevron-down rt-panel-chevron {{#if (isExpanded 'fate_details' actor)}}rt-panel-chevron--open{{/if}}"></i>
    </div>

    {{!-- Panel Body --}}
    <div class="rt-panel-body">

        {{!-- Main Display: Golden Star Pips --}}
        <div class="rt-fate-display">

            {{!-- Current / Max Label --}}
            <div class="rt-fate-label">
                <span class="rt-fate-count">{{system.fate.value}} / {{system.fate.max}}</span>
                <span class="rt-fate-subtitle">Points Remaining</span>
            </div>

            {{!-- Star Pip Display --}}
            <div class="rt-fate-pips">
                {{#if (gt system.fate.max 0)}}
                    {{#each (range 1 (add system.fate.max 1)) as |index|}}
                        <button type="button"
                                class="rt-fate-star {{#if (lte index ../system.fate.value)}}rt-fate-star--filled{{/if}}"
                                data-fate-index="{{index}}"
                                title="Fate Point {{index}}{{#if (lte index ../system.fate.value)}} (Available){{else}} (Spent){{/if}}">
                            <i class="fas fa-star"></i>
                        </button>
                    {{/each}}
                {{else}}
                    <div class="rt-fate-empty">
                        <i class="far fa-star"></i>
                        <span>No Fate Points</span>
                    </div>
                {{/if}}
            </div>

            {{!-- Spending Menu (only show if has fate points) --}}
            {{#if (gt system.fate.value 0)}}
            <div class="rt-fate-actions">
                <div class="rt-fate-spend-menu">
                    <button type="button" class="rt-fate-spend-btn" data-fate-action="menu">
                        <i class="fas fa-hand-sparkles"></i>
                        <span>Spend Fate Point</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>

                    <div class="rt-fate-dropdown" style="display: none;">
                        <button type="button" class="rt-fate-option" data-fate-action="reroll" title="Re-roll a failed test">
                            <i class="fas fa-dice"></i>
                            <span>Re-roll Test</span>
                        </button>
                        <button type="button" class="rt-fate-option" data-fate-action="bonus" title="Gain +10 bonus to a test">
                            <i class="fas fa-plus-circle"></i>
                            <span>+10 Bonus</span>
                        </button>
                        <button type="button" class="rt-fate-option" data-fate-action="dos" title="Add +1 Degree of Success">
                            <i class="fas fa-arrow-up"></i>
                            <span>+1 DoS</span>
                        </button>
                        <button type="button" class="rt-fate-option" data-fate-action="heal" title="Heal damage">
                            <i class="fas fa-heart"></i>
                            <span>Heal Damage</span>
                        </button>
                        <button type="button" class="rt-fate-option" data-fate-action="avoid" title="Avoid death">
                            <i class="fas fa-shield-alt"></i>
                            <span>Avoid Death</span>
                        </button>
                        <button type="button" class="rt-fate-option rt-fate-option--burn" data-fate-action="burn" title="Permanently burn a Fate Point for a major effect">
                            <i class="fas fa-fire"></i>
                            <span>Burn Fate (Permanent)</span>
                        </button>
                    </div>
                </div>
            </div>
            {{/if}}

        </div>

        {{!-- Edit Mode (Expandable) --}}
        <div class="rt-panel-details fate_details" {{hideIfNot (isExpanded 'fate_details' actor)}}>

            {{!-- Quick Edit Section --}}
            <div class="rt-fate-edit-section">
                <div class="rt-fate-edit-header">
                    <i class="fas fa-cog"></i> Edit Fate Points
                </div>

                <div class="rt-fate-edit-grid">
                    <label class="rt-edit-field">
                        <span class="rt-edit-label">Max Fate Points</span>
                        <input type="number"
                               data-dtype="Number"
                               class="rt-edit-input"
                               name="system.fate.max"
                               value="{{system.fate.max}}"
                               min="0"
                               max="10"
                               placeholder="Max" />
                    </label>

                    <label class="rt-edit-field">
                        <span class="rt-edit-label">Current Fate</span>
                        <input type="number"
                               data-dtype="Number"
                               class="rt-edit-input"
                               name="system.fate.value"
                               value="{{system.fate.value}}"
                               min="0"
                               max="{{system.fate.max}}"
                               placeholder="Current" />
                    </label>
                </div>

                {{!-- Quick Actions --}}
                <div class="rt-fate-quick-actions">
                    <button type="button"
                            class="rt-fate-quick-btn rt-restore-btn"
                            data-action="restore-fate"
                            title="Restore all fate points">
                        <i class="fas fa-redo"></i>
                        <span>Restore All</span>
                    </button>
                    {{#if (gt system.fate.value 0)}}
                    <button type="button"
                            class="rt-fate-quick-btn rt-spend-one-btn"
                            data-action="decrement"
                            data-field="system.fate.value"
                            data-min="0"
                            title="Spend one fate point">
                        <i class="fas fa-minus-circle"></i>
                        <span>Spend One</span>
                    </button>
                    {{/if}}
                </div>
            </div>

            {{!-- Star Pips (Edit Mode) - Click to set exact value --}}
            <div class="rt-fate-edit-section">
                <div class="rt-fate-edit-header">
                    <i class="fas fa-star"></i> Set Fate Points
                </div>
                <div class="rt-fate-pips rt-fate-pips-edit">
                    {{#each (range 0 (add system.fate.max 1)) as |index|}}
                        <button type="button"
                                class="rt-fate-star {{#if (lte index ../system.fate.value)}}rt-fate-star--filled{{/if}}"
                                data-fate-index="{{index}}"
                                title="Set to {{index}} fate points">
                            <i class="fas fa-star"></i>
                            <span class="rt-star-number">{{index}}</span>
                        </button>
                    {{/each}}
                </div>
            </div>

            {{!-- Info Section --}}
            <div class="rt-fate-edit-section">
                <div class="rt-fate-info-box">
                    <i class="fas fa-book-open"></i>
                    <div class="rt-info-content">
                        <strong>About Fate Points</strong>
                        <p><strong>Fate Points</strong> represent the Emperor's divine favor. They can be spent to:</p>
                        <ul>
                            <li><strong>Re-roll</strong> a failed test</li>
                            <li>Gain a <strong>+10 bonus</strong> to a test</li>
                            <li>Add <strong>+1 Degree of Success</strong></li>
                            <li><strong>Heal damage</strong> or remove conditions</li>
                            <li><strong>Avoid death</strong> when reduced to 0 wounds</li>
                        </ul>
                        <p class="rt-fate-warning"><i class="fas fa-exclamation-triangle"></i> <strong>Burning Fate</strong> permanently reduces your maximum - use only in dire circumstances!</p>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
