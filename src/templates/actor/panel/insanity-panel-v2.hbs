{{!-- Insanity Panel V2 - Matches Corruption Panel Design --}}
<div class="rt-panel rt-insanity-panel-v2 {{insanityDegreeClass system.insanity}}">

    {{!-- Panel Header - Click to expand/collapse --}}
    <div class="rt-panel-header rt-panel-header--clickable sheet-control__hide-control"
         data-toggle="insanity_details"
         title="Click to {{#if (isExpanded 'insanity_details' actor)}}collapse{{else}}expand{{/if}}">
        <span class="rt-panel-title">
            <i class="fas fa-brain"></i> Insanity
        </span>
        
        {{!-- Dynamic Mind Badge --}}
        <div class="rt-insanity-header-status">
            <div class="rt-insanity-badge {{insanityDegreeClass system.insanity}}"
                 title="{{insanityDegree system.insanity}} - {{insanityModifier system.insanity}} to tests">
                <i class="fas fa-brain rt-badge-icon"></i>
                <span class="rt-badge-label">{{insanityDegree system.insanity}}</span>
            </div>
        </div>
        
        <i class="fas fa-chevron-down rt-panel-chevron {{#if (isExpanded 'insanity_details' actor)}}rt-panel-chevron--open{{/if}}"></i>
    </div>

    {{!-- Panel Body --}}
    <div class="rt-panel-body">

        {{!-- Main Display --}}
        <div class="rt-insanity-display">

            {{!-- Current Value & Modifier --}}
            <div class="rt-insanity-header">
                <div class="rt-insanity-value">
                    <button type="button"
                            class="rt-insanity-btn rt-insanity-minus"
                            data-action="decrement"
                            data-field="system.insanity"
                            data-min="0"
                            title="Reduce Insanity">
                        <i class="fas fa-minus"></i>
                    </button>

                    <div class="rt-insanity-number">
                        <span class="rt-insanity-current">{{system.insanity}}</span>
                        <span class="rt-insanity-max">/ 100</span>
                    </div>

                    <button type="button"
                            class="rt-insanity-btn rt-insanity-plus"
                            data-action="increment"
                            data-field="system.insanity"
                            data-max="100"
                            title="Increase Insanity">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>

                <div class="rt-insanity-modifier">
                    <span class="rt-modifier-label">Modifier:</span>
                    <span class="rt-modifier-value">{{insanityModifier system.insanity}}</span>
                </div>
            </div>

            {{!-- Progress Bar with Threshold Markers --}}
            <div class="rt-insanity-bar-container">
                <div class="rt-insanity-bar">
                    <div class="rt-insanity-bar-fill" style="width: {{system.insanity}}%"></div>

                    {{!-- Threshold Markers --}}
                    <div class="rt-threshold-marker" style="left: 10%;" title="STABLE → UNSETTLED (10)">
                        <span class="rt-threshold-line"></span>
                        <span class="rt-threshold-label">10</span>
                    </div>
                    <div class="rt-threshold-marker" style="left: 40%;" title="UNSETTLED → DISTURBED (40)">
                        <span class="rt-threshold-line"></span>
                        <span class="rt-threshold-label">40</span>
                    </div>
                    <div class="rt-threshold-marker" style="left: 60%;" title="DISTURBED → UNHINGED (60)">
                        <span class="rt-threshold-line"></span>
                        <span class="rt-threshold-label">60</span>
                    </div>
                    <div class="rt-threshold-marker" style="left: 80%;" title="UNHINGED → DERANGED (80)">
                        <span class="rt-threshold-line"></span>
                        <span class="rt-threshold-label">80</span>
                    </div>
                </div>
            </div>

            {{!-- Warning Messages at Thresholds --}}
            {{#if (eq system.insanity 100)}}
            <div class="rt-insanity-alert rt-alert-insane">
                <i class="fas fa-dizzy"></i>
                <span>TERMINALLY INSANE - Mind Lost to Madness!</span>
            </div>
            {{else if (gte system.insanity 80)}}
            <div class="rt-insanity-alert rt-alert-deranged">
                <i class="fas fa-exclamation-triangle"></i>
                <span>DERANGED - On the Edge of Madness (-20)</span>
            </div>
            {{else if (gte system.insanity 60)}}
            <div class="rt-insanity-alert rt-alert-unhinged">
                <i class="fas fa-user-injured"></i>
                <span>UNHINGED - Severe Mental Instability (-10)</span>
            </div>
            {{/if}}

        </div>

        {{!-- Mental Disorders Section (always visible if any exist) --}}
        {{#if (any actor.items "isMentalDisorder")}}
        <div class="rt-disorder-preview">
            <div class="rt-disorder-count">
                <i class="fas fa-head-side-virus"></i>
                <span>{{countType actor.items "isMentalDisorder"}} Mental Disorders</span>
            </div>
        </div>
        {{/if}}

        {{!-- Edit Mode (Expandable) --}}
        <div class="rt-panel-details insanity_details" {{hideIfNot (isExpanded 'insanity_details' actor)}}>

            {{!-- Direct Edit Section --}}
            <div class="rt-insanity-edit-section">
                <div class="rt-insanity-edit-header">
                    <i class="fas fa-cog"></i> Edit Insanity
                </div>

                <div class="rt-insanity-edit-field">
                    <label class="rt-edit-label">Insanity Points (0-100)</label>
                    <input type="number"
                           data-dtype="Number"
                           class="rt-edit-input"
                           name="system.insanity"
                           value="{{system.insanity}}"
                           min="0"
                           max="100"
                           placeholder="0" />
                </div>

                {{!-- Quick Adjust Buttons --}}
                <div class="rt-insanity-quick-adjust">
                    <button type="button" 
                            class="rt-quick-adjust-btn" 
                            data-action="adjustStat" 
                            data-field="system.insanity" 
                            data-delta="-5"
                            data-min="0"
                            title="Decrease by 5">
                        -5
                    </button>
                    <button type="button" 
                            class="rt-quick-adjust-btn" 
                            data-action="adjustStat" 
                            data-field="system.insanity" 
                            data-delta="-1"
                            data-min="0"
                            title="Decrease by 1">
                        -1
                    </button>
                    <button type="button" 
                            class="rt-quick-adjust-btn" 
                            data-action="adjustStat" 
                            data-field="system.insanity" 
                            data-delta="1"
                            data-max="100"
                            title="Increase by 1">
                        +1
                    </button>
                    <button type="button" 
                            class="rt-quick-adjust-btn" 
                            data-action="adjustStat" 
                            data-field="system.insanity" 
                            data-delta="5"
                            data-max="100"
                            title="Increase by 5">
                        +5
                    </button>
                </div>
            </div>

            {{!-- Mental Disorders List --}}
            <div class="rt-insanity-edit-section">
                <div class="rt-insanity-edit-header">
                    <i class="fas fa-head-side-virus"></i> Mental Disorders
                </div>

                {{#if (any actor.items "isMentalDisorder")}}
                <div class="rt-disorder-list">
                    {{#each actor.items as |item|}}
                        {{#if item.isMentalDisorder}}
                        <div class="rt-disorder-card">
                            <button type="button"
                                    class="rt-disorder-name item-edit"
                                    data-item-id="{{item.id}}"
                                    title="Edit {{item.name}}">
                                <i class="fas fa-brain"></i>
                                {{item.name}}
                            </button>
                            <button type="button"
                                    class="rt-disorder-delete item-delete"
                                    data-item-id="{{item.id}}"
                                    title="Remove {{item.name}}">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        {{/if}}
                    {{/each}}
                </div>
                {{/if}}
                
                {{!-- Drop Zone (always visible) --}}
                <div class="rt-dropzone {{#unless (any actor.items "isMentalDisorder")}}rt-dropzone-empty{{/unless}}" 
                     data-action="itemCreate"
                     data-type="mentalDisorder">
                    <i class="fas fa-smile-beam rt-dropzone-icon"></i>
                    <span class="rt-dropzone-text">
                        {{#if (any actor.items "isMentalDisorder")}}
                            Drop Mental Disorders Here or Click to Create
                        {{else}}
                            No mental disorders (yet)
                        {{/if}}
                    </span>
                </div>
            </div>

            {{!-- Info Section --}}
            <div class="rt-insanity-edit-section">
                <div class="rt-insanity-info-box">
                    <i class="fas fa-book-medical"></i>
                    <div class="rt-info-content">
                        <strong>Insanity Degrees</strong>
                        <ul class="rt-degree-list">
                            <li><span class="rt-degree-name">STABLE (0-9):</span> Sound of mind - No penalty</li>
                            <li><span class="rt-degree-name">UNSETTLED (10-39):</span> Minor unease - <strong>+10</strong> to Fear tests</li>
                            <li><span class="rt-degree-name">DISTURBED (40-59):</span> Troubled mind - No modifier</li>
                            <li><span class="rt-degree-name">UNHINGED (60-79):</span> Severe instability - <strong>-10</strong> to checks</li>
                            <li><span class="rt-degree-name">DERANGED (80-99):</span> On the brink - <strong>-20</strong> to checks</li>
                            <li><span class="rt-degree-name rt-degree-insane">TERMINALLY INSANE (100):</span> Mind lost - <strong>NPC only</strong></li>
                        </ul>
                        <p class="rt-insanity-warning"><i class="fas fa-brain"></i> Mental disorders represent psychological trauma from witnessing horrors beyond mortal comprehension.</p>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
