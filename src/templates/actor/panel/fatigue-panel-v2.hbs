{{!-- Redesigned Fatigue Panel - Core Rules Compliant --}}
<div class="rt-panel rt-fatigue-panel-v2 {{#if (gt system.fatigue.value system.fatigue.max)}}rt-unconscious{{else if (gt system.fatigue.value 0)}}rt-fatigued{{/if}}">

    {{!-- Panel Header - Click to expand/collapse --}}
    <div class="rt-panel-header rt-panel-header--clickable sheet-control__hide-control"
         data-toggle="fatigue_details"
         title="Click to {{#if (isExpanded 'fatigue_details' actor)}}collapse{{else}}expand{{/if}}">
        <span class="rt-panel-title">
            <i class="fas fa-bolt"></i> Fatigue
        </span>
        <i class="fas fa-chevron-down rt-panel-chevron {{#if (isExpanded 'fatigue_details' actor)}}rt-panel-chevron--open{{/if}}"></i>
    </div>

    {{!-- Panel Body --}}
    <div class="rt-panel-body">

        {{!-- Main Display: Current/Threshold with Quick Controls --}}
        <div class="rt-fatigue-display">
            <div class="rt-fatigue-tracker">
                <button type="button"
                        class="rt-fatigue-btn rt-fatigue-minus"
                        data-action="decrement"
                        data-field="system.fatigue.value"
                        data-min="0"
                        title="Reduce Fatigue">
                    <i class="fas fa-minus"></i>
                </button>

                <div class="rt-fatigue-value">
                    <span class="rt-fatigue-current">{{system.fatigue.value}}</span>
                    <span class="rt-fatigue-sep">/</span>
                    <span class="rt-fatigue-max">{{system.fatigue.max}}</span>
                </div>

                <button type="button"
                        class="rt-fatigue-btn rt-fatigue-plus"
                        data-action="increment"
                        data-field="system.fatigue.value"
                        title="Increase Fatigue">
                    <i class="fas fa-plus"></i>
                </button>
            </div>

            {{!-- Auto-Calc Badge --}}
            <div class="rt-fatigue-auto-badge">
                <i class="fas fa-calculator"></i>
                <span>Threshold = TB ({{characteristics.toughness.bonus}})</span>
            </div>

            {{!-- Progress Bar --}}
            <div class="rt-fatigue-bar-container">
                <div class="rt-fatigue-bar"
                     data-percent="{{percent system.fatigue.value system.fatigue.max}}"
                     style="--fatigue-percent: {{percent system.fatigue.value system.fatigue.max}}%">
                    <div class="rt-fatigue-bar-fill"></div>

                    {{!-- Threshold Marker at 100% --}}
                    <div class="rt-threshold-marker" style="left: 100%;" title="Collapse Threshold">
                        <span class="rt-threshold-line"></span>
                        <span class="rt-threshold-label">TB</span>
                    </div>
                </div>
                <span class="rt-fatigue-percent">{{system.fatigue.value}} / {{system.fatigue.max}}</span>
            </div>
        </div>

        {{!-- Warning Messages --}}
        {{#if (gt system.fatigue.value system.fatigue.max)}}
        <div class="rt-fatigue-alert rt-alert-unconscious">
            <i class="fas fa-dizzy"></i>
            <span>UNCONSCIOUS - Collapsed for {{sub 10 characteristics.toughness.bonus}} minutes!</span>
        </div>
        {{else if (gt system.fatigue.value 0)}}
        <div class="rt-fatigue-alert rt-alert-fatigued">
            <i class="fas fa-exclamation-triangle"></i>
            <span>FATIGUED - Suffer –10 penalty to all Tests</span>
        </div>
        {{/if}}

        {{!-- Quick Actions --}}
        <div class="rt-fatigue-actions">
            <button type="button"
                    class="rt-fatigue-action-btn rt-rest-btn"
                    data-action="decrement"
                    data-field="system.fatigue.value"
                    data-min="0"
                    title="Rest to recover 1 fatigue">
                <i class="fas fa-bed"></i>
                <span>Rest (-1)</span>
            </button>
            {{#if (gt system.fatigue.value 0)}}
            <button type="button"
                    class="rt-fatigue-action-btn rt-clear-btn"
                    data-action="clear-fatigue"
                    title="Clear all fatigue (full rest)">
                <i class="fas fa-broom"></i>
                <span>Clear All</span>
            </button>
            {{/if}}
        </div>

        {{!-- Edit Mode (Expandable) --}}
        <div class="rt-panel-details fatigue_details" {{hideIfNot (isExpanded 'fatigue_details' actor)}}>

            {{!-- Current Fatigue Editor --}}
            <div class="rt-fatigue-edit-section">
                <div class="rt-fatigue-edit-header">
                    <i class="fas fa-cog"></i> Edit Values
                </div>

                <div class="rt-fatigue-edit-grid">
                    <label class="rt-edit-field">
                        <span class="rt-edit-label">
                            Threshold
                            <span class="rt-auto-tag">AUTO: TB</span>
                        </span>
                        <input type="number"
                               data-dtype="Number"
                               class="rt-edit-input"
                               name="system.fatigue.max"
                               value="{{system.fatigue.max}}"
                               min="0"
                               readonly
                               placeholder="Threshold" />
                    </label>

                    <label class="rt-edit-field">
                        <span class="rt-edit-label">Current Fatigue</span>
                        <input type="number"
                               data-dtype="Number"
                               class="rt-edit-input"
                               name="system.fatigue.value"
                               value="{{system.fatigue.value}}"
                               min="0"
                               placeholder="Current" />
                    </label>
                </div>
            </div>

            {{!-- Info Section --}}
            <div class="rt-fatigue-edit-section">
                <div class="rt-fatigue-info-box">
                    <i class="fas fa-book"></i>
                    <div class="rt-info-content">
                        <strong>Fatigue Rules (Core)</strong>
                        <p><strong>Any Fatigue:</strong> –10 penalty to all Tests.</p>
                        <p><strong>Exceeds TB:</strong> Collapse unconscious for (10 – TB) minutes. Upon waking, fatigue resets to TB.</p>
                        <p><strong>Recovery:</strong> Each hour of rest removes 1 fatigue. Eight consecutive hours removes all fatigue.</p>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
