{{!-- Combat Tab Panel --}}
{{!-- Streamlined combat interface --}}

<div class="rt-combat-tab">
    {{!-- Main Combat Layout: 3 Columns --}}
    <div class="rt-combat-grid">
        {{!-- LEFT COLUMN: Vitals HUD --}}
        <div class="rt-combat-col rt-combat-vitals">
            {{!-- Compact Vitals Monitor --}}
            <div class="rt-vitals-hud">
                <div class="rt-vitals-hud-header">
                    <i class="fas fa-heartbeat"></i>
                    <span>VITALS</span>
                </div>
                
                {{!-- Wounds Status --}}
                <div class="rt-vital-stat rt-vital-wounds {{#if (eq system.wounds.value 0)}}rt-vital-critical{{else if (lt (percent system.wounds.value system.wounds.max) 25)}}rt-vital-warning{{/if}}">
                    <div class="rt-vital-stat-header rt-panel-header--clickable sheet-control__hide-control"
                         data-toggle="combat_wounds_details"
                         title="Click to {{#if (isExpanded 'combat_wounds_details' actor)}}collapse{{else}}expand{{/if}}">
                        <div class="rt-vital-label">
                            <i class="fas fa-heart"></i>
                            <span>WOUNDS</span>
                        </div>
                        <div class="rt-vital-controls">
                            <button type="button" class="rt-vital-ctrl-btn" data-action="decrement" data-field="system.wounds.value" data-min="0" title="Decrease">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button type="button" class="rt-vital-ctrl-btn" data-action="increment" data-field="system.wounds.value" title="Increase">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <i class="fas fa-chevron-down rt-panel-chevron {{#if (isExpanded 'combat_wounds_details' actor)}}rt-panel-chevron--open{{/if}}"></i>
                    </div>
                    <div class="rt-vital-stat-body">
                        <div class="rt-vital-readout">
                            <span class="rt-vital-value">{{system.wounds.value}}</span>
                            <span class="rt-vital-max-label">/ {{system.wounds.max}}</span>
                        </div>
                        <div class="rt-vital-bar-wrapper">
                            <div class="rt-vital-bar-track">
                                <div class="rt-vital-bar-progress rt-wounds-progress" style="--progress: {{percent system.wounds.value system.wounds.max}}%"></div>
                            </div>
                            <span class="rt-vital-percent">{{percent system.wounds.value system.wounds.max}}%</span>
                        </div>
                    </div>
                    {{#if (gt system.wounds.critical 0)}}
                    <div class="rt-vital-alert">
                        <i class="fas fa-skull"></i>
                        <span>CRITICAL DAMAGE: {{system.wounds.critical}}</span>
                    </div>
                    {{/if}}

                    {{!-- Critical Damage Pips (inline compact) --}}
                    {{#if (or (gt system.wounds.critical 0) (eq system.wounds.value 0))}}
                    <div class="rt-vital-critical-inline">
                        <span class="rt-crit-label"><i class="fas fa-skull"></i> CRIT</span>
                        <div class="rt-critical-pips-compact">
                            {{#each (array 1 2 3 4 5 6 7 8 9 10) as |level|}}
                                <button type="button"
                                        class="rt-crit-pip-mini {{#if (lte level ../system.wounds.critical)}}rt-crit-pip-mini--filled{{/if}}"
                                        data-action="setCriticalPip"
                                        data-crit-level="{{level}}"
                                        title="Critical Level {{level}} - Click to toggle">
                                </button>
                            {{/each}}
                        </div>
                    </div>
                    {{/if}}

                    {{!-- Expandable Details --}}
                    <div class="rt-panel-details combat_wounds_details" {{hideIfNot (isExpanded 'combat_wounds_details' actor)}}>
                        <div class="rt-vital-edit-section">
                            <label class="rt-vital-edit-field">
                                <span class="rt-vital-edit-label">Max Wounds</span>
                                <input type="number"
                                       data-dtype="Number"
                                       class="rt-vital-edit-input"
                                       name="system.wounds.max"
                                       value="{{system.wounds.max}}"
                                       min="1"
                                       placeholder="Max"
                                       {{#unless (isExpanded 'combat_wounds_details' actor)}}disabled{{/unless}} />
                            </label>
                            <label class="rt-vital-edit-field">
                                <span class="rt-vital-edit-label">Current Wounds</span>
                                <input type="number"
                                       data-dtype="Number"
                                       class="rt-vital-edit-input"
                                       name="system.wounds.value"
                                       value="{{system.wounds.value}}"
                                       min="0"
                                       max="{{system.wounds.max}}"
                                       placeholder="Current"
                                       {{#unless (isExpanded 'combat_wounds_details' actor)}}disabled{{/unless}} />
                            </label>
                            <label class="rt-vital-edit-field">
                                <span class="rt-vital-edit-label">Critical Damage</span>
                                <input type="number"
                                       data-dtype="Number"
                                       class="rt-vital-edit-input"
                                       name="system.wounds.critical"
                                       value="{{system.wounds.critical}}"
                                       min="0"
                                       max="10"
                                       placeholder="Critical"
                                       {{#unless (isExpanded 'combat_wounds_details' actor)}}disabled{{/unless}} />
                            </label>
                        </div>
                    </div>
                </div>

                {{!-- Fatigue Status --}}
                <div class="rt-vital-stat rt-vital-fatigue {{#if (gt system.fatigue.value system.fatigue.max)}}rt-vital-critical{{else if (gt system.fatigue.value 0)}}rt-vital-warning{{/if}}">
                    <div class="rt-vital-stat-header rt-panel-header--clickable sheet-control__hide-control"
                         data-toggle="combat_fatigue_details"
                         title="Click to {{#if (isExpanded 'combat_fatigue_details' actor)}}collapse{{else}}expand{{/if}}">
                        <div class="rt-vital-label">
                            <i class="fas fa-bolt"></i>
                            <span>FATIGUE</span>
                        </div>
                        <div class="rt-vital-controls">
                            <button type="button" class="rt-vital-ctrl-btn" data-action="decrement" data-field="system.fatigue.value" data-min="0" title="Decrease">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button type="button" class="rt-vital-ctrl-btn" data-action="increment" data-field="system.fatigue.value" title="Increase">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <i class="fas fa-chevron-down rt-panel-chevron {{#if (isExpanded 'combat_fatigue_details' actor)}}rt-panel-chevron--open{{/if}}"></i>
                    </div>
                    <div class="rt-vital-stat-body">
                        <div class="rt-vital-readout">
                            <span class="rt-vital-value">{{system.fatigue.value}}</span>
                            <span class="rt-vital-max-label">/ {{system.fatigue.max}}</span>
                        </div>
                        <div class="rt-vital-bar-wrapper">
                            <div class="rt-vital-bar-track">
                                <div class="rt-vital-bar-progress rt-fatigue-progress" style="--progress: {{percent system.fatigue.value system.fatigue.max}}%"></div>
                            </div>
                            <span class="rt-vital-percent">{{percent system.fatigue.value system.fatigue.max}}%</span>
                        </div>
                    </div>
                    {{#if (gt system.fatigue.value 0)}}
                    <div class="rt-vital-alert rt-alert-fatigue">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>{{#if (gt system.fatigue.value system.fatigue.max)}}UNCONSCIOUS{{else}}−10 ALL TESTS{{/if}}</span>
                    </div>
                    {{/if}}

                    {{!-- Expandable Details --}}
                    <div class="rt-panel-details combat_fatigue_details" {{hideIfNot (isExpanded 'combat_fatigue_details' actor)}}>
                        <div class="rt-vital-edit-section">
                            <label class="rt-vital-edit-field">
                                <span class="rt-vital-edit-label">Threshold (TB)</span>
                                <input type="number"
                                       data-dtype="Number"
                                       class="rt-vital-edit-input"
                                       name="system.fatigue.max"
                                       value="{{system.fatigue.max}}"
                                       min="0"
                                       readonly
                                       placeholder="Threshold"
                                       {{#unless (isExpanded 'combat_fatigue_details' actor)}}disabled{{/unless}} />
                            </label>
                            <label class="rt-vital-edit-field">
                                <span class="rt-vital-edit-label">Current Fatigue</span>
                                <input type="number"
                                       data-dtype="Number"
                                       class="rt-vital-edit-input"
                                       name="system.fatigue.value"
                                       value="{{system.fatigue.value}}"
                                       min="0"
                                       placeholder="Current"
                                       {{#unless (isExpanded 'combat_fatigue_details' actor)}}disabled{{/unless}} />
                            </label>
                        </div>
                        <div class="rt-vital-info-text">
                            <i class="fas fa-info-circle"></i>
                            <span>Any fatigue: –10 all tests. Exceeds TB: Unconscious.</span>
                        </div>
                    </div>
                </div>

                {{!-- Fate Points Status --}}
                <div class="rt-vital-stat rt-vital-fate">
                    <div class="rt-vital-stat-header rt-panel-header--clickable sheet-control__hide-control"
                         data-toggle="combat_fate_details"
                         title="Click to {{#if (isExpanded 'combat_fate_details' actor)}}collapse{{else}}expand{{/if}}">
                        <div class="rt-vital-label">
                            <i class="fas fa-star"></i>
                            <span>FATE</span>
                        </div>
                        <div class="rt-vital-controls">
                            <button type="button" class="rt-vital-ctrl-btn" data-action="decrement" data-field="system.fate.value" data-min="0" title="Spend">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button type="button" class="rt-vital-ctrl-btn" data-action="increment" data-field="system.fate.value" title="Restore">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <i class="fas fa-chevron-down rt-panel-chevron {{#if (isExpanded 'combat_fate_details' actor)}}rt-panel-chevron--open{{/if}}"></i>
                    </div>
                    <div class="rt-vital-stat-body">
                        <div class="rt-fate-stars">
                            {{#each (range 1 (add system.fate.max 1)) as |index|}}
                                <span class="rt-fate-pip {{#if (lte index ../system.fate.value)}}rt-fate-pip--active{{/if}}">
                                    <i class="fas fa-star"></i>
                                </span>
                            {{/each}}
                        </div>
                        <div class="rt-fate-counter">
                            <span class="rt-fate-available">{{system.fate.value}}</span>
                            <span class="rt-fate-total">/ {{system.fate.max}}</span>
                        </div>
                    </div>

                    {{!-- Expandable Details --}}
                    <div class="rt-panel-details combat_fate_details" {{hideIfNot (isExpanded 'combat_fate_details' actor)}}>
                        <div class="rt-vital-edit-section">
                            <label class="rt-vital-edit-field">
                                <span class="rt-vital-edit-label">Max Fate Points</span>
                                <input type="number"
                                       data-dtype="Number"
                                       class="rt-vital-edit-input"
                                       name="system.fate.max"
                                       value="{{system.fate.max}}"
                                       min="0"
                                       placeholder="Max"
                                       {{#unless (isExpanded 'combat_fate_details' actor)}}disabled{{/unless}} />
                            </label>
                            <label class="rt-vital-edit-field">
                                <span class="rt-vital-edit-label">Current Fate</span>
                                <input type="number"
                                       data-dtype="Number"
                                       class="rt-vital-edit-input"
                                       name="system.fate.value"
                                       value="{{system.fate.value}}"
                                       min="0"
                                       max="{{system.fate.max}}"
                                       placeholder="Current"
                                       {{#unless (isExpanded 'combat_fate_details' actor)}}disabled{{/unless}} />
                            </label>
                        </div>
                        <div class="rt-vital-info-text">
                            <i class="fas fa-info-circle"></i>
                            <span>Spend Fate to reroll tests or avoid death.</span>
                        </div>
                    </div>
                </div>
            </div>

            {{!-- Combat Actions Panel --}}
            {{> systems/rogue-trader/templates/actor/panel/combat-actions-panel.hbs}}
        </div>

        {{!-- CENTER COLUMN: Armour (using existing panel directly) --}}
        <div class="rt-combat-col rt-combat-tactical">
            {{> systems/rogue-trader/templates/actor/panel/armour-display-panel.hbs}}
            
            {{!-- Force Field Status --}}
            {{#if hasForceField}}
            <div class="rt-panel rt-panel-forcefield">
                <div class="rt-panel-header">
                    <span class="rt-panel-title"><i class="fas fa-circle-notch"></i> Force Field</span>
                </div>
                <div class="rt-panel-body">
                    <div class="rt-forcefield-bar {{#if forceField.system.activated}}rt-ff-active{{/if}} {{#if forceField.system.overloaded}}rt-ff-overloaded{{/if}}">
                        <span class="rt-ff-name">{{forceField.name}}</span>
                        <span class="rt-ff-rating">({{forceField.system.protectionRating}})</span>
                        {{#if forceField.system.overloaded}}
                            <span class="rt-ff-status rt-ff-down">OVERLOADED</span>
                        {{else}}
                            <span class="rt-ff-status {{#if forceField.system.activated}}rt-ff-on{{else}}rt-ff-off{{/if}}">
                                {{#if forceField.system.activated}}ACTIVE{{else}}OFF{{/if}}
                            </span>
                        {{/if}}
                    </div>
                </div>
            </div>
            {{/if}}
        </div>

        {{!-- RIGHT COLUMN: Actions & Info --}}
        <div class="rt-combat-col rt-combat-actions">
            {{!-- Movement Reference Panel (Compact Version) --}}
            {{> systems/rogue-trader/templates/actor/panel/movement-panel-compact.hbs}}

            {{!-- Quick Actions Panel (with Initiative) --}}
            <div class="rt-panel rt-panel-quick-actions">
                <div class="rt-panel-header">
                    <span class="rt-panel-title"><i class="fas fa-crosshairs"></i> Actions</span>
                </div>
                <div class="rt-panel-body">
                    {{!-- Initiative Section --}}
                    <div class="rt-initiative-inline">
                        <span class="rt-initiative-label">Initiative</span>
                        <div class="rt-initiative-display">
                            <span class="rt-init-value">{{system.initiative.total}}</span>
                            <button type="button" class="rt-init-roll-btn combat-control" data-action="initiative" title="Roll Initiative">
                                <i class="fas fa-dice-d20"></i>
                            </button>
                        </div>
                    </div>
                    
                    {{!-- Action Buttons --}}
                    <div class="rt-quick-actions-row">
                        <button type="button" class="rt-quick-action-btn combat-control" data-action="attack" title="Make Attack">
                            <i class="fas fa-crosshairs"></i>
                            <span>Attack</span>
                        </button>
                        <button type="button" class="rt-quick-action-btn combat-control" data-action="assign-damage" title="Assign Damage">
                            <i class="fas fa-skull-crossbones"></i>
                            <span>Damage</span>
                        </button>
                    </div>
                </div>
            </div>

            {{!-- Critical Injuries Panel --}}
            <div class="rt-panel rt-panel-injuries">
                <div class="rt-panel-header">
                    <span class="rt-panel-title"><i class="fas fa-band-aid"></i> Critical Injuries</span>
                </div>
                <div class="rt-panel-body">
                    {{#if criticalInjuries.length}}
                    <div class="rt-injuries-list">
                        {{#each criticalInjuries as |injury|}}
                        <div class="rt-injury-row" data-item-id="{{injury.id}}">
                            <span class="rt-injury-name item-edit" data-item-id="{{injury.id}}">{{injury.name}}</span>
                            <button type="button" class="rt-injury-delete item-delete" data-item-id="{{injury.id}}" title="Remove">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        {{/each}}
                    </div>
                    {{/if}}
                    <div class="rt-dropzone" data-action="itemCreate" data-type="criticalInjury">
                        <i class="fas fa-band-aid rt-dropzone-icon"></i>
                        <span class="rt-dropzone-text">Drop injuries here or click to create</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {{!-- WEAPONS ARSENAL --}}
    <div class="rt-panel rt-panel-arsenal">
        <div class="rt-panel-header">
            <span class="rt-panel-title"><i class="fas fa-fist-raised"></i> Weapons</span>
        </div>
        <div class="rt-panel-body">
            {{#if actor.items}}
            <div class="rt-table--border rt-weapontable--border">
                <div class="table-row--head">
                    <div class="table-cell--span2">Weapon</div>
                    <div class="table-cell">Class</div>
                    <div class="table-cell">Damage</div>
                    <div class="table-cell">Range</div>
                    <div class="table-cell--last">Actions</div>
                </div>
                {{#each actor.items as |item|}}
                {{#if item.isWeapon}}
                <div class="table-row item-drag {{#if item.system.equipped}}rt-row-equipped{{/if}}" data-item-id="{{item.id}}" data-item-type="weapon">
                    <div class="table-cell--settingstoggle">
                        <label class="rt-control-button item-edit" data-item-id="{{item.id}}">
                            <i class="fas fa-cog"></i>
                        </label>
                    </div>
                    <div class="table-cell--left">
                        <span class="rt-weapon-name-cell">
                            {{#if item.system.equipped}}<i class="fas fa-check-circle rt-equipped-icon"></i>{{/if}}
                            {{item.name}}
                        </span>
                    </div>
                    <div class="table-cell">{{item.system.class}}</div>
                    <div class="table-cell">{{item.system.damageLabel}}</div>
                    <div class="table-cell">{{item.system.rangeLabel}}</div>
                    <div class="table-cell--last">
                        <label class="rt-control-button item-roll" data-item-id="{{item.id}}" title="Attack Roll">
                            <i class="fas fa-dice-d20"></i>
                        </label>
                        <label class="rt-control-button item-damage" data-item-id="{{item.id}}" title="Damage Roll">
                            <i class="fas fa-bolt"></i>
                        </label>
                        <label class="rt-control-button item-delete" data-item-id="{{item.id}}" title="Delete">
                            <i class="fas fa-trash"></i>
                        </label>
                    </div>
                </div>
                {{/if}}
                {{/each}}
            </div>
            {{/if}}
            <div class="rt-dropzone" data-action="itemCreate" data-type="weapon">
                <i class="fas fa-fist-raised rt-dropzone-icon"></i>
                <span class="rt-dropzone-text">Drop weapons here or click to create</span>
            </div>
        </div>
    </div>
</div>
