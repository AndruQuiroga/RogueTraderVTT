{{!-- Loadout Manager Equipment Panel --}}
{{!-- Modern equipment management with organized sections --}}

<div class="rt-equipment-loadout">
    {{!-- NEW: Split Backpack Panel (Personal & Ship Storage) --}}
    {{> systems/rogue-trader/templates/actor/panel/backpack-split-panel.hbs}}

    {{!-- Two Column Layout --}}
    <div class="rt-equipment-grid">
        {{!-- LEFT COLUMN: Armour & Protection --}}
        <div class="rt-equipment-col rt-equipment-protection">
            {{!-- Armour Body Diagram (already has panel wrapper) --}}
            {{> systems/rogue-trader/templates/actor/panel/armour-display-panel.hbs}}

            {{!-- Lifting Capacity --}}
            <div class="rt-panel rt-panel-lifting">
                <div class="rt-panel-header">
                    <span class="rt-panel-title"><i class="fas fa-dumbbell"></i> Lifting Capacity</span>
                </div>
                <div class="rt-panel-body">
                    <div class="rt-lifting-grid">
                        <div class="rt-lift-item">
                            <span class="rt-lift-label">Carry</span>
                            <span class="rt-lift-value">{{system.lifting.carry}} kg</span>
                        </div>
                        <div class="rt-lift-item">
                            <span class="rt-lift-label">Lift</span>
                            <span class="rt-lift-value">{{system.lifting.lift}} kg</span>
                        </div>
                        <div class="rt-lift-item">
                            <span class="rt-lift-label">Push</span>
                            <span class="rt-lift-value">{{system.lifting.push}} kg</span>
                        </div>
                    </div>
                </div>
            </div>

            {{!-- Backpack/Container Info --}}
            {{#if actor.backpack.hasBackpack}}
            <div class="rt-panel rt-panel-backpack">
                <div class="rt-panel-header">
                    <span class="rt-panel-title"><i class="fas fa-suitcase"></i> Backpack</span>
                </div>
                <div class="rt-panel-body">
                    <div class="rt-backpack-bar-wrapper">
                        <div class="rt-backpack-bar-container">
                            <div class="rt-backpack-bar-fill" style="width: {{backpackPercent}}%"></div>
                        </div>
                        <span class="rt-backpack-text">{{actor.encumbrance.backpack_value}} / {{actor.encumbrance.backpack_max}} kg</span>
                    </div>
                </div>
            </div>
            {{/if}}
        </div>

        {{!-- RIGHT COLUMN: Equipment Lists --}}
        <div class="rt-equipment-col rt-equipment-items">
            {{!-- Armour Items --}}
            <div class="rt-panel rt-panel-armour-list">
                <div class="rt-panel-header">
                    <span class="rt-panel-title"><i class="fas fa-shield-alt"></i> Armour</span>
                    <span class="rt-item-count">{{armourItems.length}}</span>
                </div>
                <div class="rt-panel-body">
                    {{#if armourItems.length}}
                    <div class="rt-equipment-table">
                        {{#each armourItems as |item|}}
                        <div class="rt-equip-row item-drag {{#if item.system.equipped}}rt-equip-equipped{{/if}}" data-item-id="{{item.id}}" data-item-type="armour">
                            <img class="rt-equip-icon" src="{{item.img}}" alt="{{item.name}}" />
                            <button type="button" class="rt-equip-name" data-action="itemEdit" data-item-id="{{item.id}}" title="{{item.name}}">{{item.name}}</button>
                            <span class="rt-equip-meta">{{item.system.type}}</span>
                            <span class="rt-equip-stat"><span class="rt-stat-l">AP:</span> <strong>{{item.system.ap}}</strong></span>
                            {{#if item.system.maxAP}}
                            <span class="rt-equip-stat"><span class="rt-stat-l">Max:</span> {{item.system.maxAP}}</span>
                            {{/if}}
                            {{#if item.system.weight}}
                            <span class="rt-equip-stat"><span class="rt-stat-l">Wt:</span> {{item.system.weight}}kg</span>
                            {{/if}}
                            <div class="rt-equip-actions">
                                <button type="button" class="rt-equip-btn" data-action="toggleItemPreview" data-item-id="{{item.id}}" title="Quick Preview">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button type="button" class="rt-equip-btn rt-equip-toggle" data-action="toggleEquip" data-item-id="{{item.id}}" title="{{#if item.system.equipped}}Unequip{{else}}Equip{{/if}}">
                                    <i class="fas {{#if item.system.equipped}}fa-check-circle{{else}}fa-circle{{/if}}"></i>
                                </button>
                                <button type="button" class="rt-equip-btn" data-action="itemVocalize" data-item-id="{{item.id}}" title="Send to Chat">
                                    <i class="fas fa-comment"></i>
                                </button>
                                <button type="button" class="rt-equip-btn rt-equip-danger" data-action="itemDelete" data-item-id="{{item.id}}" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <!-- Item preview card container (populated by ItemPreviewMixin) -->
                        <div id="item-preview-{{item.id}}" class="rt-item-preview-container" style="display: none;"></div>
                        {{/each}}
                    </div>
                    {{/if}}
                    {{!-- Armour Dropzone --}}
                    <div class="rt-dropzone-small" data-action="itemCreate" data-type="armour">
                        <i class="fas fa-plus-circle"></i>
                        <span>Drop armour here or click to create</span>
                    </div>
                </div>
            </div>

            {{!-- Force Fields --}}
            <div class="rt-panel rt-panel-forcefields">
                <div class="rt-panel-header">
                    <span class="rt-panel-title"><i class="fas fa-circle-notch"></i> Force Fields</span>
                    <span class="rt-item-count">{{forceFieldItems.length}}</span>
                </div>
                <div class="rt-panel-body">
                    {{#if forceFieldItems.length}}
                    <div class="rt-equipment-table">
                        {{#each forceFieldItems as |item|}}
                        <div class="rt-equip-row item-drag {{#if item.system.activated}}rt-equip-active{{/if}} {{#if item.system.overloaded}}rt-equip-overloaded{{/if}}" data-item-id="{{item.id}}" data-item-type="forceField">
                            <img class="rt-equip-icon" src="{{item.img}}" alt="{{item.name}}" />
                            <button type="button" class="rt-equip-name" data-action="itemEdit" data-item-id="{{item.id}}" title="{{item.name}}">{{item.name}}</button>
                            <span class="rt-equip-status">
                                {{#if item.system.overloaded}}
                                    <i class="fas fa-exclamation-triangle rt-status-danger"></i> OVERLOAD
                                {{else if item.system.activated}}
                                    <i class="fas fa-bolt rt-status-active"></i> ACTIVE
                                {{else}}
                                    <i class="fas fa-power-off rt-status-offline"></i> Offline
                                {{/if}}
                            </span>
                            <span class="rt-equip-stat"><span class="rt-stat-l">Rating:</span> <strong>{{item.system.protectionRating}}</strong></span>
                            <span class="rt-equip-stat"><span class="rt-stat-l">Overload:</span> {{item.system.overloadRoll}}</span>
                            <div class="rt-equip-actions">
                                {{#unless item.system.overloaded}}
                                <button type="button" class="rt-equip-btn rt-equip-toggle" data-action="toggleActivate" data-item-id="{{item.id}}" title="{{#if item.system.activated}}Deactivate{{else}}Activate{{/if}}">
                                    <i class="fas {{#if item.system.activated}}fa-bolt{{else}}fa-power-off{{/if}}"></i>
                                </button>
                                {{/unless}}
                                <button type="button" class="rt-equip-btn" data-action="itemRoll" data-item-id="{{item.id}}" title="Roll Protection">
                                    <i class="fas fa-dice-d20"></i>
                                </button>
                                <button type="button" class="rt-equip-btn" data-action="itemVocalize" data-item-id="{{item.id}}" title="Send to Chat">
                                    <i class="fas fa-comment"></i>
                                </button>
                                <button type="button" class="rt-equip-btn rt-equip-danger" data-action="itemDelete" data-item-id="{{item.id}}" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        {{/each}}
                    </div>
                    {{/if}}
                    {{!-- Force Field Dropzone --}}
                    <div class="rt-dropzone-small" data-action="itemCreate" data-type="forceField">
                        <i class="fas fa-plus-circle"></i>
                        <span>Drop force field here or click to create</span>
                    </div>
                </div>
            </div>

            {{!-- Cybernetics --}}
            <div class="rt-panel rt-panel-cybernetics">
                <div class="rt-panel-header">
                    <span class="rt-panel-title"><i class="fas fa-microchip"></i> Cybernetics</span>
                    <span class="rt-item-count">{{cyberneticItems.length}}</span>
                </div>
                <div class="rt-panel-body">
                    {{#if cyberneticItems.length}}
                    <div class="rt-equipment-table">
                        {{#each cyberneticItems as |item|}}
                        <div class="rt-equip-row item-drag {{#if item.system.equipped}}rt-equip-equipped{{/if}}" data-item-id="{{item.id}}" data-item-type="cybernetic">
                            <img class="rt-equip-icon" src="{{item.img}}" alt="{{item.name}}" />
                            <button type="button" class="rt-equip-name" data-action="itemEdit" data-item-id="{{item.id}}" title="{{item.name}}">{{item.name}}</button>
                            <span class="rt-equip-meta">{{item.system.location}}</span>
                            {{#if item.system.craftsmanship}}
                            <span class="rt-equip-stat"><span class="rt-stat-l">Quality:</span> {{item.system.craftsmanship}}</span>
                            {{/if}}
                            <div class="rt-equip-actions">
                                <button type="button" class="rt-equip-btn rt-equip-toggle" data-action="toggleEquip" data-item-id="{{item.id}}" title="{{#if item.system.equipped}}Uninstall{{else}}Install{{/if}}">
                                    <i class="fas {{#if item.system.equipped}}fa-check-circle{{else}}fa-circle{{/if}}"></i>
                                </button>
                                <button type="button" class="rt-equip-btn" data-action="itemVocalize" data-item-id="{{item.id}}" title="Send to Chat">
                                    <i class="fas fa-comment"></i>
                                </button>
                                <button type="button" class="rt-equip-btn rt-equip-danger" data-action="itemDelete" data-item-id="{{item.id}}" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        {{/each}}
                    </div>
                    {{/if}}
                    {{!-- Cybernetic Dropzone --}}
                    <div class="rt-dropzone-small" data-action="itemCreate" data-type="cybernetic">
                        <i class="fas fa-plus-circle"></i>
                        <span>Drop cybernetic here or click to create</span>
                    </div>
                </div>
            </div>

            {{!-- Gear --}}
            <div class="rt-panel rt-panel-gear">
                <div class="rt-panel-header">
                    <span class="rt-panel-title"><i class="fas fa-toolbox"></i> Gear</span>
                    <span class="rt-item-count">{{gearItems.length}}</span>
                </div>
                <div class="rt-panel-body">
                    {{#if gearItems.length}}
                    <div class="rt-equipment-table">
                        {{#each gearItems as |item|}}
                        <div class="rt-equip-row item-drag {{#if item.system.inBackpack}}rt-equip-stowed{{/if}}" data-item-id="{{item.id}}" data-item-type="gear">
                            <img class="rt-equip-icon" src="{{item.img}}" alt="{{item.name}}" />
                            <button type="button" class="rt-equip-name" data-action="itemEdit" data-item-id="{{item.id}}" title="{{item.name}}">{{item.name}}</button>
                            <span class="rt-equip-status">
                                {{#if item.system.inBackpack}}
                                    <i class="fas fa-suitcase"></i> Backpack
                                {{else}}
                                    <i class="fas fa-user"></i> Carried
                                {{/if}}
                            </span>
                            {{#if item.system.weight}}
                            <span class="rt-equip-stat"><span class="rt-stat-l">Wt:</span> {{item.system.weight}}kg</span>
                            {{/if}}
                            {{#if item.system.availability}}
                            <span class="rt-equip-stat"><span class="rt-stat-l">Avail:</span> {{item.system.availability}}</span>
                            {{/if}}
                            <div class="rt-equip-actions">
                                {{#if item.system.inBackpack}}
                                <button type="button" class="rt-equip-btn" data-action="unstowItem" data-item-id="{{item.id}}" title="Remove from Backpack">
                                    <i class="fas fa-box-open"></i>
                                </button>
                                {{else}}
                                <button type="button" class="rt-equip-btn" data-action="stowItem" data-item-id="{{item.id}}" title="Stow in Backpack">
                                    <i class="fas fa-archive"></i>
                                </button>
                                {{/if}}
                                <button type="button" class="rt-equip-btn" data-action="itemVocalize" data-item-id="{{item.id}}" title="Send to Chat">
                                    <i class="fas fa-comment"></i>
                                </button>
                                <button type="button" class="rt-equip-btn rt-equip-danger" data-action="itemDelete" data-item-id="{{item.id}}" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        {{/each}}
                    </div>
                    {{/if}}
                    {{!-- Gear Dropzone --}}
                    <div class="rt-dropzone-small" data-action="itemCreate" data-type="gear">
                        <i class="fas fa-plus-circle"></i>
                        <span>Drop gear here or click to create</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
