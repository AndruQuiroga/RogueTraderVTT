================================================================================
  SHIP ROLES SYSTEM - DEEP DIVE ANALYSIS SUMMARY
  Date: 2026-01-09
  Agent: AI Assistant
================================================================================

STATUS: ðŸ”´ BROKEN - Requires full refactor
SCOPE: 22 ship role items
ISSUE: [object Object] displays throughout system

================================================================================
  ROOT CAUSE
================================================================================

FIELD TYPE MISMATCH between pack data and DataModel schema:

Pack Data (Legacy):
  â€¢ careerPreferences: STRING "Usually Explorator, any but Missionary"
  â€¢ subordinates: STRING "Ship Tech-Priests, Arch-Magi, and Lesser Enginseers"
  â€¢ importantSkills: STRING "Tech-Use, Chem-Use, Common Lore (Machine Cult)"
  
DataModel Schema (V13):
  â€¢ careerPreferences: ArrayField<StringField>
  â€¢ subordinates: ArrayField<StringField>
  â€¢ importantSkills: ArrayField<SchemaField{name, specialization}>

Result: Display getters call .join(", ") on STRINGS â†’ [object Object]

================================================================================
  4 CRITICAL ISSUES IDENTIFIED
================================================================================

1. FIELD TYPE MISMATCH
   - Pack: strings
   - Schema: arrays
   - Impact: All 22 items show [object Object]

2. ABILITIES NOT STRUCTURED
   - Pack: effect HTML string (legacy)
   - Schema: abilities array (modern)
   - Impact: No structured ability bonuses

3. BONUS SYSTEMS EMPTY
   - Pack: shipBonuses all zeros
   - Text: "+5 to Ship Crew Rating" in effect
   - Impact: Numeric bonuses not applied

4. DISPLAY GETTERS BROKEN
   - Expect arrays
   - Receive strings
   - Impact: UI completely broken

================================================================================
  SOLUTION APPROACH
================================================================================

Following successful Ship Components/Weapons pattern (262 items, 100% success):

PHASE 1: Pack Data Migration
  â€¢ Parse career strings â†’ structured arrays
  â€¢ Parse subordinate strings â†’ arrays
  â€¢ Parse skill strings â†’ array of objects
  â€¢ Extract abilities from effect text
  â€¢ Populate ship bonuses from effect

PHASE 2: DataModel Enhancement
  â€¢ Add migrateData() for automatic legacy handling
  â€¢ Update getters for backward compatibility
  â€¢ Add new display properties

PHASE 3: Template Updates
  â€¢ Modernize ship-role-panel.hbs
  â€¢ Add compendium browser metadata
  â€¢ Display structured abilities/bonuses

PHASE 4: Testing
  â€¢ Dry-run validation
  â€¢ Execute migration
  â€¢ Build and test in Foundry
  â€¢ Verify no [object Object] displays

================================================================================
  PARSING STRATEGIES
================================================================================

Career Preferences:
  "Only Rogue Trader" â†’ ["Rogue Trader"]
  "Usually X, any but Y" â†’ [all careers except Y]
  "Seneschal, Navigator, Explorers" â†’ ["Seneschal", "Navigator", "Explorator"]

Subordinates:
  "Tech-Priests, Arch-Magi, and Enginseers." â†’ split on commas/"and"

Important Skills:
  "Tech-Use, Common Lore (Machine Cult)" â†’ [{name, spec}, {name, spec}]

Effect â†’ Abilities:
  "+10 to Emergency Repairs Extended Actions" â†’ structured ability object
  "+5 to Ship Crew Rating" â†’ ability + shipBonuses.crewRating = 5

================================================================================
  FILES TO CREATE/MODIFY
================================================================================

NEW FILES (4):
  â€¢ scripts/migrate-ship-roles.mjs (500 lines)
  â€¢ SHIP_ROLES_DEEP_DIVE.md (47KB - technical analysis)
  â€¢ SHIP_ROLES_REFACTOR_INDEX.md (5KB - navigation)
  â€¢ SHIP_ROLES_QUICK_REFERENCE.md (7KB - quick guide)

MODIFIED FILES (4):
  â€¢ src/module/data/item/ship-role.mjs (+150 lines)
  â€¢ src/templates/actor/panel/ship-role-panel.hbs (rewrite)
  â€¢ src/module/applications/compendium-browser.mjs (+80 lines)
  â€¢ src/lang/en.json (+15 keys)

PACK DATA (22 files):
  â€¢ src/packs/rt-items-ship-roles/_source/*.json

================================================================================
  SUCCESS CRITERIA
================================================================================

âœ… All 22 ship roles migrated (0 errors)
âœ… Build passes
âœ… No [object Object] anywhere
âœ… Career/subordinates/skills display as readable text
âœ… Structured abilities with bonuses
âœ… Ship bonuses populate correctly
âœ… Compendium browser shows metadata
âœ… Character sheet displays correctly

================================================================================
  TIMELINE ESTIMATE
================================================================================

Phase 1: Migration Script        45 minutes
Phase 2: DataModel Updates        30 minutes
Phase 3: Template Updates         30 minutes
Phase 4: Testing & Refinement     45 minutes
----------------------------------------
TOTAL:                          2-3 hours

================================================================================
  RISK ASSESSMENT
================================================================================

RISK LEVEL: ðŸŸ¢ LOW
  â€¢ Proven pattern (Components/Weapons success)
  â€¢ Comprehensive backups
  â€¢ Dry-run validation before execution
  â€¢ migrateData() for automatic legacy handling

EXPECTED SUCCESS: ðŸŸ¢ HIGH
  â€¢ Following exact pattern that worked for 262 items
  â€¢ Scope is small (22 items)
  â€¢ Clear transformation rules

================================================================================
  REFERENCE MATERIALS
================================================================================

Previous Success:
  â€¢ Ship Components: 212 items, 100% success
  â€¢ Ship Weapons: 50 items, 100% success
  â€¢ Total: 262 items migrated, 0 errors

Documentation:
  â€¢ SHIP_ROLES_DEEP_DIVE.md - Complete technical analysis (47KB)
  â€¢ SHIP_ROLES_REFACTOR_INDEX.md - Navigation and quick links
  â€¢ SHIP_ROLES_QUICK_REFERENCE.md - Execution guide
  â€¢ SHIP_SYSTEM_REFACTOR_COMPLETE.md - Previous success report

================================================================================
  NEXT STEPS
================================================================================

1. Review SHIP_ROLES_DEEP_DIVE.md (complete technical details)
2. Create migration script (Phase 4 section has full code)
3. Dry-run validation
4. Execute migration
5. Update DataModel with migrateData()
6. Update templates
7. Build and test in Foundry
8. Create completion report

================================================================================
  READY FOR IMPLEMENTATION
================================================================================

All planning complete. All parsing strategies defined. All code patterns 
documented. Backup procedures in place. Success metrics established.

Status: ðŸŸ¡ READY TO EXECUTE

Next: Create scripts/migrate-ship-roles.mjs and begin Phase 1

================================================================================
