# Rogue Trader VTT - Task Planning Document
## Date: January 10, 2026

---

## PREAMBLE - Read Before Each Task

This preamble MUST be read and followed for every task in this document. It contains critical context, coding standards, and architectural guidelines specific to the Rogue Trader VTT system.

### Philosophy

**NO SHORTCUTS** - Every task should be completed properly, following established patterns and best practices. If legacy code exists, it should be migrated as part of the solution rather than worked around.

**PRO-REFACTOR** - When encountering outdated patterns, incomplete implementations, or technical debt, refactoring is encouraged. The goal is to leave the codebase better than we found it.

### System Architecture (Foundry V13)

| Layer | Responsibility | Pattern |
|-------|---------------|---------|
| **DataModels** (`src/module/data/`) | Schema, data preparation, derived calculations | Heavy logic |
| **Documents** (`src/module/documents/`) | Roll methods, API surface, action triggers | Slim wrappers |
| **ApplicationV2 Sheets** (`src/module/applications/`) | UI rendering, event handling, PARTS system | 8-mixin stack |

### Key Patterns to Follow

1. **Template Data Context**: Use `{{system.xxx}}` not `{{actor.system.xxx}}` in Handlebars
2. **ApplicationV2 Actions**: Define in `static DEFAULT_OPTIONS.actions` as static private methods
3. **PARTS System**: Modular templates rendered independently
4. **No Caching**: Compute fresh on each render; trust Foundry's reactive system
5. **Tab Configuration**: Use `{ tab: "name", group: "primary", label: "..." }` structure

### Styling Guidelines (Imperial Gothic Theme)

```scss
// Colors
$rt-color-gold: #c9a227;
$rt-color-crimson: #8b0000;
$rt-color-success: #2d5016;
$rt-color-failure: #6b1010;

// Typography
$rt-font-display: 'Cinzel', serif;
$rt-font-heading: 'IM Fell DW Pica', serif;
$rt-font-body: 'Lusitana', serif;

// Spacing
$rt-space-xs: 4px; $rt-space-sm: 8px; $rt-space-md: 12px; $rt-space-lg: 16px;
```

**Class Naming**: Use `.rt-` prefix with BEM-style modifiers (e.g., `.rt-panel__header`, `.rt-panel--collapsed`)

### Reference Files

| Purpose | Location |
|---------|----------|
| Weapon Sheet (exemplar) | `src/module/applications/item/weapon-sheet.mjs` |
| Weapon Template (exemplar) | `src/templates/item/item-weapon-sheet-modern.hbs` |
| Skill Sheet (exemplar) | `src/templates/item/item-skill-sheet-modern.hbs` |
| Base Item Sheet | `src/module/applications/item/base-item-sheet.mjs` |
| Handlebars Helpers | `src/module/handlebars/handlebars-helpers.mjs` |
| SCSS Variables | `src/scss/abstracts/_variables.scss` |
| DataModel Templates | `src/module/data/shared/` |

### Item Sheet Tab Pattern (Weapon Sheet as Reference)

```javascript
// JavaScript: Set up tabs in _onRender
_setupWeaponTabs() {
    const tabs = this.element.querySelectorAll(".rt-weapon-tabs .rt-weapon-tab");
    tabs.forEach(tab => {
        tab.addEventListener("click", (event) => {
            event.preventDefault();
            const tabName = tab.dataset.tab;
            tabs.forEach(t => t.classList.remove("active"));
            tab.classList.add("active");
            const panels = this.element.querySelectorAll(".rt-weapon-panel");
            panels.forEach(panel => {
                panel.classList.toggle("active", panel.dataset.tab === tabName);
            });
            this.tabGroups.primary = tabName;
        });
    });
}
```

```handlebars
{{!-- Template: Tab navigation --}}
<nav class="rt-weapon-tabs" data-group="primary">
  <button type="button" class="rt-weapon-tab active" data-tab="stats">
    <i class="fas fa-chart-bar"></i><span>Stats</span>
  </button>
  <button type="button" class="rt-weapon-tab" data-tab="qualities">
    <i class="fas fa-star"></i><span>Qualities</span>
  </button>
</nav>

{{!-- Template: Tab panels --}}
<div class="rt-weapon-panel active" data-tab="stats">...</div>
<div class="rt-weapon-panel" data-tab="qualities">...</div>
```

### SCSS Section Pattern (Weapon Sheet as Reference)

```scss
.rt-weapon-section {
  background: var(--rt-panel-bg);
  border: 1px solid var(--rt-border-color);
  border-radius: var(--rt-radius-lg);
  margin-bottom: var(--rt-space-md);
  
  &__header {
    display: flex;
    align-items: center;
    gap: var(--rt-space-sm);
    padding: var(--rt-space-sm) var(--rt-space-md);
    background: linear-gradient(180deg, rgba(var(--rt-gold-rgb), 0.1), transparent);
    border-bottom: 1px solid var(--rt-border-color);
    
    i { color: var(--rt-gold); }
    h3 { margin: 0; font-size: 0.85rem; font-weight: 600; }
  }
  
  &__body {
    padding: var(--rt-space-md);
  }
}
```

---

## TASK 1: Fix Weapon Item Sheet Image Validation Error

### Issue
When editing a weapon item in its sheet, the following error occurs:
```
DataModelValidationError: RogueTraderItem [xxx] validation errors:
  img: does not have a valid file extension
```
This happens despite the item using the default SVG icon.

### Root Cause Analysis
Foundry V13 has stricter validation on image paths. The default icon may be using an unsupported format, or the path is being corrupted during form submission.

### Investigation Steps
1. Check `src/module/documents/item.mjs` for default image handling
2. Check `src/module/data/item/weapon.mjs` for schema validation
3. Examine `BaseItemSheet._prepareSubmitData()` behavior
4. Check `system.json` for default icon configuration

### Solution Approach
1. Ensure default weapon icons use valid Foundry-supported formats (`.svg`, `.png`, `.jpg`, `.webp`)
2. Add validation/sanitization in `migrateData()` or `cleanData()` if needed
3. Consider adding a fallback icon path in the schema

### Files to Modify
- `src/module/documents/item.mjs` (default icons)
- `src/module/data/item/weapon.mjs` (schema validation)
- Potentially `system.json` (default icon paths)

---

## TASK 2: Add Vocalize Cards for Combat Actions

### Issue
Combat actions in the Combat tab need vocalize (chat) cards when clicking the action buttons.

### Current State
- Combat actions data model exists: `src/module/data/item/combat-action.mjs`
- Combat action sheet exists: `src/module/applications/item/combat-action-sheet.mjs`
- Combat actions panel exists: `src/templates/actor/panel/combat-actions-panel.hbs`
- Chat card template exists: `src/templates/chat/combat-action-card.hbs`
- Action manager exists: `src/module/actions/combat-action-manager.mjs`

### Solution Approach
1. Review existing `combat-action-manager.mjs` for vocalization method
2. Add/enhance `vocalize()` method in CombatActionData or the manager
3. Wire up the combat action buttons in the panel to trigger vocalization
4. Ensure chat card template is properly styled

### Files to Modify/Create
- `src/module/actions/combat-action-manager.mjs` - Add vocalize method
- `src/module/applications/actor/acolyte-sheet.mjs` - Add action handler for combat action clicks
- `src/templates/chat/combat-action-card.hbs` - Verify/enhance styling
- `src/scss/chat/_combat-action.scss` - Styling for chat cards

### Implementation Pattern
```javascript
// In action manager
static async vocalizeAction(actor, actionKey) {
    const actionConfig = CONFIG.rt.combatActions.all[actionKey];
    if (!actionConfig) return;
    
    const chatData = {
        user: game.user.id,
        speaker: ChatMessage.getSpeaker({ actor }),
        content: await renderTemplate(
            "systems/rogue-trader/templates/chat/combat-action-card.hbs",
            { action: actionConfig, actor }
        )
    };
    
    return ChatMessage.create(chatData);
}
```

---

## TASK 3: Fix Armour Silhouette Not Rendering

### Issue
The `rt-armour-silhouette` does not render at all. The `rt-armour-panel` does not show up in either location (Combat tab or Equipment tab).

### Current State
- Template exists: `src/templates/actor/panel/armour-display-panel.hbs`
- SCSS exists: `src/scss/components/_armour.scss`
- Template uses `{{system.armour.xxx.total}}` correctly

### Investigation Steps
1. Check if the panel partial is being included in the tab templates
2. Check if SCSS is being imported in `rogue-trader.scss`
3. Verify the panel is not inside a collapsed/hidden container
4. Check for CSS display rules that might hide the panel

### Solution Approach
1. Verify template inclusion in `tab-combat.hbs` and/or `tab-equipment.hbs`
2. Ensure SCSS is properly imported and not overridden
3. Check for missing CSS variables or grid positioning issues
4. Add debug logging if needed to confirm template is being rendered

### Files to Check/Modify
- `src/templates/actor/acolyte/tab-combat.hbs` - Include panel partial
- `src/templates/actor/acolyte/tab-equipment.hbs` - Include panel partial
- `src/scss/components/_armour.scss` - Verify styles
- `src/scss/rogue-trader.scss` - Verify import

---

## TASK 4: Fix Advanced Skill Badge Applying to All Skills

### Issue
The badge and other effects showing "ADV" (advanced skill) are incorrectly applying to BASIC skills. Every skill appears as an advanced skill.

### Current State
- Skill schema in `src/module/data/actor/templates/creature.mjs` correctly defines `advanced: true/false` for each skill
- Template uses `{{#if (eq entry.[1].advanced true)}} rt-skill-row--advanced{{/if}}`

### Root Cause Analysis
This is a deeper issue that has been attempted before. Possible causes:
1. The `advanced` property is being overwritten during data preparation
2. The skill data is not properly structured when passed to templates
3. The `SkillField` factory may have a bug in how it sets the initial values
4. Skill items from compendium may be overriding actor skill data

### Investigation Steps
1. Add console.log in `prepareDerivedData()` to check skill values
2. Verify the skill schema initial values in `SkillField()`
3. Check if compendium skill items are interfering
4. Examine how `skillLists` is prepared for the template

### Solution Approach
1. Trace the skill data flow from schema → prepareBaseData → prepareDerivedData → template
2. Fix the source of the corruption
3. Ensure `basic` and `advanced` flags are mutually exclusive and correctly set
4. Add validation to prevent future issues

### Files to Modify
- `src/module/data/actor/templates/creature.mjs` - Fix skill preparation
- `src/module/applications/actor/acolyte-sheet.mjs` - Fix `_prepareSkillsData()` method
- Potentially skill-related panel templates

---

## TASK 5: Skills Tab - Click Name Opens Item Sheet, Click Row Rolls

### Issue
Clicking the skill name should open the skill item sheet (from compendium). Clicking anywhere else on the row should show the roll prompt.

### Current State
- Skills are defined in actor's DataModel, not as embedded items
- Skills compendium exists: `rt-items-skills`
- Current behavior: clicking skill name triggers roll

### Solution Approach
This requires a more significant change:
1. Skills should reference compendium items OR
2. Add a "view skill details" action that opens a read-only skill info dialog

**Option A (Compendium Reference)**:
- Store skill item UUIDs in actor data
- On name click, `fromUuid()` and render sheet

**Option B (Skill Info Dialog)**:
- Create a `SkillInfoDialog` that shows skill details
- Pull data from CONFIG or embedded skill definitions
- Less invasive to existing architecture

### Recommended: Option B (Skill Info Dialog)

### Files to Create/Modify
- `src/module/applications/dialogs/skill-info-dialog.mjs` (NEW)
- `src/templates/dialogs/skill-info-dialog.hbs` (NEW)
- `src/module/applications/actor/acolyte-sheet.mjs` - Add action handler
- `src/templates/actor/panel/skills-panel.hbs` - Split click targets

### Template Pattern
```handlebars
<div class="rt-skill-row" data-action="rollSkill" data-skill="{{entry.[0]}}">
    <button type="button" class="rt-skill-name" 
            data-action="viewSkillInfo" data-skill="{{entry.[0]}}"
            title="View Skill Details">
        {{entry.[1].label}}
    </button>
    {{!-- Rest of row for rolling --}}
</div>
```

---

## TASK 6: Improve Trait/Talent/Origin Path Item Sheets

### Issue
The trait/talent/origin path item sheets look bland compared to the skill item sheet. They should follow the styling patterns of `rt-skill-properties`, `rt-skill-descriptor`, `rt-skill-uses`, `rt-skill-roll-config`. The tabs also do not work.

### Current State
- Talent sheet: `src/templates/item/item-talent-sheet-modern.hbs`
- Trait sheet: `src/templates/item/item-trait-sheet-modern.hbs`
- Origin path sheet: `src/templates/item/item-origin-path-sheet.hbs`
- Sheets use custom tab buttons but rely on parent class `_setupTabListeners()`

### Root Cause (Tabs Not Working)
The base item sheet's `_setupTabListeners()` expects `.rt-tabs .rt-tab` but these sheets use `.rt-talent-tabs .rt-talent-tab`, etc.

### Solution Approach
1. **Fix Tabs**: Add sheet-specific tab setup methods like weapon sheet does
2. **Improve Styling**: Apply skill sheet styling patterns
3. **Add Section Components**: Use `rt-*-section` pattern with headers

### Files to Modify
- `src/module/applications/item/talent-sheet.mjs` - Add `_setupTalentTabs()` method
- `src/module/applications/item/trait-sheet.mjs` - Add `_setupTraitTabs()` method
- `src/module/applications/item/origin-path-sheet.mjs` - Add `_setupOriginPathTabs()` method
- `src/templates/item/item-talent-sheet-modern.hbs` - Improve styling
- `src/templates/item/item-trait-sheet-modern.hbs` - Improve styling
- `src/templates/item/item-origin-path-sheet.hbs` - Improve styling
- `src/scss/item/_talent.scss` - Add section styling
- `src/scss/item/_trait.scss` - Add section styling

### Tab Fix Pattern
```javascript
// In TalentSheet class
async _onRender(context, options) {
    await super._onRender(context, options);
    this._setupTalentTabs();
}

_setupTalentTabs() {
    const tabs = this.element.querySelectorAll(".rt-talent-tabs .rt-talent-tab");
    tabs.forEach(tab => {
        tab.addEventListener("click", (event) => {
            event.preventDefault();
            const tabName = tab.dataset.tab;
            tabs.forEach(t => t.classList.remove("active"));
            tab.classList.add("active");
            const panels = this.element.querySelectorAll(".rt-talent-panel");
            panels.forEach(panel => {
                panel.classList.toggle("active", panel.dataset.tab === tabName);
            });
            this.tabGroups.primary = tabName;
        });
    });
}
```

---

## TASK 7: Armour Item Sheet - Remove Diagram, Fix Tabs

### Issue
1. The `rt-armour-diagram` is too big and should be removed entirely
2. Tabs do not function at all

### Current State
- Armour sheet: `src/module/applications/item/armour-sheet.mjs`
- Template: `src/templates/item/item-armour-sheet-v2.hbs`
- Sheet extends ContainerItemSheet but doesn't have tab setup

### Solution Approach
1. Remove the armour diagram from the template
2. Replace with a compact armour points display (like skill sheet properties)
3. Add `_setupArmourTabs()` method following weapon sheet pattern

### Files to Modify
- `src/module/applications/item/armour-sheet.mjs` - Add tab setup
- `src/templates/item/item-armour-sheet-v2.hbs` - Remove diagram, add compact display

### Alternative to Diagram
Create a compact grid showing AP by location:
```handlebars
<div class="rt-armour-ap-compact">
  <div class="rt-ap-location">
    <span class="rt-ap-label">Head</span>
    <span class="rt-ap-value">{{item.system.armourPoints.head}}</span>
  </div>
  {{!-- Repeat for other locations --}}
</div>
```

---

## TASK 8: Force Field Item Sheet - Match Weapon Sheet Style

### Issue
The force field item sheet should better match the function and styles of the weapon sheet.

### Current State
- Force field sheet: `src/module/applications/item/force-field-sheet.mjs`
- Template: `src/templates/item/item-force-field-sheet-v2.hbs`
- Already has reasonable structure but missing tabs and some styling

### Solution Approach
1. Add tabs if not present
2. Apply `rt-weapon-section` / `rt-weapon-stats` styling patterns
3. Ensure consistent panel headers and body styling

### Files to Modify
- `src/module/applications/item/force-field-sheet.mjs` - Add tab setup if needed
- `src/templates/item/item-force-field-sheet-v2.hbs` - Apply weapon sheet patterns
- `src/scss/item/_force-field.scss` - Match weapon sheet styling

---

## TASK 9: Gear Item Sheet - Fix Data Display Issues

### Issue
The gear item sheet does not show any info at all. This might be a data pack issue.

### Current State
- Gear sheet: `src/module/applications/item/gear-sheet.mjs`
- Uses template: `item-gear-sheet-v2.hbs`
- Data model: `src/module/data/item/gear.mjs`
- Template uses `item.system.weightLabel` but schema doesn't define `weightLabel`

### Root Cause Analysis
The template references computed properties that may not exist:
- `{{item.system.weightLabel}}` - Not defined in GearData
- `{{item.system.cost}}` - Should be `{{item.system.cost.value}}`

### Solution Approach
1. Add missing computed properties to GearData
2. Fix template property references
3. Apply weapon sheet styling patterns
4. Add tab setup method

### Files to Modify
- `src/module/data/item/gear.mjs` - Add `weightLabel` getter
- `src/templates/item/item-gear-sheet-v2.hbs` - Fix property references
- `src/module/applications/item/gear-sheet.mjs` - Add tab setup

### Missing Getters to Add
```javascript
get weightLabel() {
    return `${this.weight ?? 0} kg`;
}

get totalWeight() {
    return (this.weight ?? 0) * (this.quantity ?? 1);
}
```

---

## TASK 10: Cybernetic Sheet - Fix Missing "has" Helper

### Issue
When opening a cybernetic sheet, error occurs:
```
Missing helper: "has"
```
Template uses `{{#if (has item.system.locations "head")}}` but `has` helper doesn't exist.

### Current State
- Cybernetic sheet: `src/module/applications/item/cybernetic-sheet.mjs`
- Template: `src/templates/item/item-cybernetic-sheet-v2.hbs`
- Handlebars helpers: `src/module/handlebars/handlebars-helpers.mjs`

### Solution Approach
1. Add `has` helper to `handlebars-helpers.mjs`
2. Or refactor template to use `includes` helper if it exists

### Implementation
```javascript
// In handlebars-helpers.mjs
Handlebars.registerHelper('has', function(collection, value) {
    if (collection instanceof Set) return collection.has(value);
    if (Array.isArray(collection)) return collection.includes(value);
    if (typeof collection === 'object' && collection !== null) {
        return Object.prototype.hasOwnProperty.call(collection, value);
    }
    return false;
});
```

### Files to Modify
- `src/module/handlebars/handlebars-helpers.mjs` - Add `has` helper
- Optionally: `src/module/applications/item/cybernetic-sheet.mjs` - Add tab setup
- `src/scss/item/_cybernetic.scss` - Ensure consistent styling

---

## Task Execution Order (Recommended)

| Priority | Task | Complexity | Dependencies |
|----------|------|------------|--------------|
| 1 | Task 10: Fix "has" helper | Low | None |
| 2 | Task 1: Fix weapon image validation | Low | None |
| 3 | Task 3: Fix armour silhouette | Medium | None |
| 4 | Task 4: Fix advanced skill badge | Medium | Deep investigation |
| 5 | Task 9: Fix gear sheet | Medium | None |
| 6 | Task 6: Improve talent/trait sheets | Medium | Tab pattern |
| 7 | Task 7: Fix armour sheet | Medium | Tab pattern |
| 8 | Task 8: Fix force field sheet | Low | Tab pattern |
| 9 | Task 5: Skill info dialog | Medium | New component |
| 10 | Task 2: Combat action vocalize | Medium | Chat templates |

---

## Testing Checklist

After completing each task:

- [ ] No console errors on page load
- [ ] No errors when opening the relevant sheet
- [ ] Tabs switch correctly (if applicable)
- [ ] All form fields are editable
- [ ] Data persists after closing and reopening
- [ ] Styling matches Imperial Gothic theme
- [ ] Mobile/responsive considerations (if applicable)

---

## Notes for Implementation

### Creating New Helpers
When adding Handlebars helpers, register them in `registerHelpers()` method within `handlebars-helpers.mjs`.

### Adding New SCSS Files
1. Create file in appropriate subfolder (`src/scss/item/`, `src/scss/panels/`, etc.)
2. Add `@import` to `src/scss/rogue-trader.scss`
3. Use variables from `src/scss/abstracts/_variables.scss`

### Tab Implementation
All item sheets with tabs should follow the weapon sheet pattern:
1. Define `static TABS` array
2. Initialize `tabGroups` object
3. Add `_setup[Type]Tabs()` method called in `_onRender()`

### Data Model Computed Properties
Add getters to the DataModel class for template convenience:
```javascript
get myLabel() {
    return game.i18n.localize(`RT.MyField.${this.myField}`);
}
```

---

*Document created: January 10, 2026*
*Last updated: January 10, 2026*
